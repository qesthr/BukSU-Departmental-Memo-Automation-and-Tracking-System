<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Auth Complete</title>
</head>
<body>
    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
        <div style="border: 3px solid #4285f4; border-top: 3px solid transparent; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto;"></div>
        <p>Completing authentication...</p>
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    </div>

    <script>
        console.log('Callback page loaded');
        console.log('Window opener:', !!window.opener);

        // Check if this is a popup or full-page redirect
        if (window.opener) {
            // Popup scenario - send message to parent
            console.log('‚úÖ Popup detected - sending message to parent');
            window.opener.postMessage({ type: 'GOOGLE_AUTH_SUCCESS' }, window.location.origin);
            console.log('‚úÖ Sent GOOGLE_AUTH_SUCCESS to parent');

            setTimeout(() => {
                console.log('üîÑ Closing popup');
                window.close();
            }, 200);
        } else {
            // Full-page redirect scenario - fetch user info and redirect to appropriate dashboard
            console.log('‚úÖ Full-page redirect detected - fetching user info...');

            fetch('/auth/current-user', { credentials: 'include' })
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.user) {
                        const userRole = data.user.role;
                        let dashboardUrl = '/admin-dashboard';

                        if (userRole === 'secretary') {
                            dashboardUrl = '/dashboard';
                        } else if (userRole === 'faculty') {
                            dashboardUrl = '/dashboard';
                        } else if (userRole === 'admin') {
                            dashboardUrl = '/admin-dashboard';
                        }

                        console.log('‚úÖ Redirecting to:', dashboardUrl, 'for role:', userRole);
                        window.location.href = dashboardUrl;
                    } else {
                        console.error('‚ùå Could not get user info');
                        window.location.href = '/login';
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error fetching user info:', error);
                    window.location.href = '/login';
                });
        }
    </script>
</body>
</html>
