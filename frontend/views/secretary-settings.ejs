<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings | Memofy</title>
    <link rel="stylesheet" href="/css/admin-dash.css">
    <link rel="stylesheet" href="/css/secretary-side-css.css">
    <link rel="stylesheet" href="/css/sec-topbar.css">
    <link rel="stylesheet" href="/css/sec-nav.css">
    <link rel="stylesheet" href="/css/settings.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Google Analytics Tracking -->
    <%- include('google-analytics', { propertyId: typeof gaPropertyId !== 'undefined' ? gaPropertyId : null }); %>

    <!-- SweetAlert2 -->
    <%- include('../components/sweetalert2'); %>

    <!-- Vue.js CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="/js/lucide.min.js"></script>
    <script>
        // Immediate check on page load - redirect if password was changed
        (function() {
            if (sessionStorage.getItem('passwordChanged') === 'true') {
                sessionStorage.removeItem('passwordChanged');
                window.location.href = '/auth/logout';
            }
        })();
    </script>
</head>
<body>
    <div id="app" class="dashboard-container">
        <%- include('../components/sec-nav'); %>

        <main class="main-content">
            <%- include('../components/sec-topbar'); %>

            <section class="settings-section">
                <div class="settings-header">
                    <h1>Account Settings</h1>
                    <p>Update your password and notification preferences.</p>
                </div>

                <div class="settings-grid">
                    <!-- Change Password Card -->
                    <div class="settings-card">
                        <h3>Change Password</h3>
                        <p>Keep your account protected by using a strong password.</p>
                        <form @submit.prevent="updatePassword" class="settings-form">
                            <div>
                                <label for="currentPassword">Current Password</label>
                                <input type="password"
                                       id="currentPassword"
                                       v-model="passwordForm.currentPassword"
                                       autocomplete="current-password"
                                       required
                                       :disabled="passwordLoading">
                            </div>
                            <div>
                                <label for="newPassword">New Password</label>
                                <input type="password"
                                       id="newPassword"
                                       v-model="passwordForm.newPassword"
                                       autocomplete="new-password"
                                       required
                                       :disabled="passwordLoading">
                                <password-strength :password="passwordForm.newPassword"></password-strength>
                            </div>
                            <div>
                                <label for="confirmPassword">Confirm New Password</label>
                                <input type="password"
                                       id="confirmPassword"
                                       v-model="passwordForm.confirmPassword"
                                       autocomplete="new-password"
                                       required
                                       :disabled="passwordLoading">
                                <div v-if="passwordForm.confirmPassword && !passwordsMatch" class="password-mismatch">
                                    Passwords do not match
                                </div>
                            </div>
                            <div class="settings-actions">
                                <button type="submit"
                                        class="settings-btn primary"
                                        :disabled="passwordLoading || !isPasswordValid">
                                    {{ passwordLoading ? 'Updating...' : 'Update Password' }}
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Preferences Card -->
                    <div class="settings-card">
                        <h3>Notification Preferences</h3>
                        <p>Choose how you’d like to be notified about important updates.</p>
                        <div class="preferences-grid">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4>Email me when I distribute or receive memos</h4>
                                    <p>Get an email whenever a memo related to you is created or sent.</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="memoEmailToggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4>Email me about profile or account changes</h4>
                                    <p>Be notified if your profile details are updated.</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="profileUpdateToggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="settings-feedback" id="notificationFeedback" role="status"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        /* global Swal */
        const { createApp } = Vue;

        // Password Strength Indicator Component
        const PasswordStrength = {
            props: {
                password: String
            },
            computed: {
                strength() {
                    if (!this.password) return { level: 0, text: '' };

                    let score = 0;
                    const password = this.password;

                    if (password.length >= 8) score++;
                    if (password.length >= 12) score++;
                    if (/[a-z]/.test(password)) score++;
                    if (/[A-Z]/.test(password)) score++;
                    if (/[0-9]/.test(password)) score++;
                    if (/[^a-zA-Z0-9]/.test(password)) score++;

                    if (score <= 2) return { level: 1, text: 'Weak', class: 'weak' };
                    if (score <= 4) return { level: 2, text: 'Fair', class: 'fair' };
                    if (score <= 5) return { level: 3, text: 'Good', class: 'good' };
                    return { level: 4, text: 'Strong', class: 'strong' };
                }
            },
            template: `
                <div v-if="password" class="password-strength">
                    <div class="strength-bar">
                        <div :class="['strength-fill', strength.class]" :style="{ width: (strength.level * 25) + '%' }"></div>
                    </div>
                    <span :class="['strength-text', strength.class]">{{ strength.text }}</span>
                </div>
            `
        };

        createApp({
            components: {
                PasswordStrength
            },
            data() {
                return {
                    // Password form data
                    passwordForm: {
                        currentPassword: '',
                        newPassword: '',
                        confirmPassword: ''
                    },

                    // User preferences
                    preferences: {
                        darkMode: false,
                        twoFactorEnabled: false
                    },

                    // User profile data
                    userProfile: {
                        firstName: '<%= user.firstName || "" %>',
                        lastName: '<%= user.lastName || "" %>',
                        email: '<%= user.email || "" %>',
                        department: '<%= user.department || "" %>'
                    },

                    // Loading states
                    passwordLoading: false,
                    profileLoading: false,

                    // Feedback messages
                    passwordFeedback: {
                        type: '', // 'success' or 'error'
                        message: ''
                    },
                    securityFeedback: {
                        type: '',
                        message: ''
                    },
                    profileFeedback: {
                        type: '',
                        message: ''
                    }
                }
            },
            computed: {
                passwordsMatch() {
                    return this.passwordForm.newPassword === this.passwordForm.confirmPassword || !this.passwordForm.confirmPassword;
                },
                isPasswordValid() {
                    return this.passwordForm.newPassword.length >= 8 && this.passwordsMatch;
                }
            },
            mounted() {
                // Check if password was changed - redirect to login if so
                if (sessionStorage.getItem('passwordChanged') === 'true') {
                    sessionStorage.removeItem('passwordChanged');
                    window.location.href = '/auth/logout';
                    return;
                }

                this.loadUserPreferences();
                this.loadUserProfile();

                // Initialize Lucide icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            },
            methods: {
                // Load user preferences from localStorage or API
                loadUserPreferences() {
                    // Load from localStorage for demo purposes
                    const savedDarkMode = localStorage.getItem('memofy_darkMode') === 'true';
                    const savedTwoFactor = localStorage.getItem('memofy_twoFactorEnabled') === 'true';

                    this.preferences.darkMode = savedDarkMode;
                    this.preferences.twoFactorEnabled = savedTwoFactor;

                    // Apply dark mode if enabled
                    if (savedDarkMode) {
                        document.body.classList.add('dark-mode');
                    }
                },

                // Load user profile data
                loadUserProfile() {
                    // In a real app, you might fetch this from an API
                    // For now, we're using EJS template data passed to userProfile
                    console.log('Profile loaded:', this.userProfile);
                },

                // Update password
                async updatePassword() {
                    // Reset feedback
                    this.passwordFeedback = { type: '', message: '' };

                    // Validation
                    if (!this.isPasswordValid) {
                        this.showPasswordFeedback('Please ensure passwords match and are at least 8 characters long.', 'error');
                        return;
                    }

                    this.passwordLoading = true;

                    try {
                        const response = await fetch('/api/password/change', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'same-origin',
                            body: JSON.stringify({
                                currentPassword: this.passwordForm.currentPassword,
                                newPassword: this.passwordForm.newPassword,
                                confirmPassword: this.passwordForm.confirmPassword
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            // Clear form first
                            this.passwordForm = {
                                currentPassword: '',
                                newPassword: '',
                                confirmPassword: ''
                            };
                            // Show SweetAlert with re-login info and then force logout on confirm
                            const msg = data.message || 'Your password has been updated successfully.';
                            this.showPasswordFeedback(`${msg} Please log in again with your new password.`, 'success');
                        } else {
                            this.showPasswordFeedback(data.message || 'Failed to update password', 'error');
                        }
                    } catch (error) {
                        console.error('Error updating password:', error);
                        this.showPasswordFeedback('Failed to update password. Please try again.', 'error');
                    } finally {
                        this.passwordLoading = false;
                    }
                },
                showPasswordFeedback(message, feedbackType = 'info') {
                    const icon = feedbackType === 'success' ? 'success' : (feedbackType === 'error' ? 'error' : 'info');
                    if (typeof Swal !== 'undefined') {
                        const swalConfig = {
                            icon,
                            title: feedbackType === 'success' ? 'Password Updated' : 'Password Update',
                            text: message,
                            confirmButtonText: feedbackType === 'success' ? 'Re‑login' : 'OK',
                            confirmButtonColor: feedbackType === 'success' ? '#2563EB' : undefined,
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            showCancelButton: false
                        };

                        // For password success, make it non-dismissible
                        if (feedbackType === 'success') {
                            swalConfig.allowOutsideClick = false;
                            swalConfig.allowEscapeKey = false;
                            swalConfig.showCancelButton = false;
                            // Mark that password was changed - user must re-login
                            sessionStorage.setItem('passwordChanged', 'true');
                        }

                        Swal.fire(swalConfig).then((result) => {
                            if (feedbackType === 'success' && result.isConfirmed) {
                                // Clear the flag and force re-login after password change
                                sessionStorage.removeItem('passwordChanged');
                                window.location.href = '/auth/logout';
                            }
                        });
                    } else {
                        alert(message);
                        if (feedbackType === 'success') {
                            sessionStorage.setItem('passwordChanged', 'true');
                            window.location.href = '/auth/logout';
                        }
                    }
                },

                // Update preference (dark mode, 2FA, etc.)
                async updatePreference(setting, value) {
                    // Reset feedback
                    this.securityFeedback = { type: '', message: '' };

                    try {
                        // Save to localStorage for demo
                        localStorage.setItem(`memofy_${setting}`, value);

                        // In a real app, you would make an API call like:
                        /*
                        const response = await fetch('/api/user/preferences', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                [setting]: value
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Failed to update preference');
                        }
                        */

                        // Handle specific preferences
                        if (setting === 'darkMode') {
                            if (value) {
                                document.body.classList.add('dark-mode');
                            } else {
                                document.body.classList.remove('dark-mode');
                            }
                        }

                        this.securityFeedback = {
                            type: 'success',
                            message: 'Preference updated successfully!'
                        };

                        // Clear feedback after 3 seconds
                        setTimeout(() => {
                            this.securityFeedback = { type: '', message: '' };
                        }, 3000);

                    } catch (error) {
                        console.error('Error updating preference:', error);

                        // Revert the toggle
                        this.preferences[setting] = !value;

                        this.securityFeedback = {
                            type: 'error',
                            message: 'Failed to update preference. Please try again.'
                        };
                    }
                },

                // Update user profile
                async updateProfile() {
                    // Reset feedback
                    this.profileFeedback = { type: '', message: '' };

                    // Validation
                    if (!this.userProfile.email) {
                        this.profileFeedback = {
                            type: 'error',
                            message: 'Email address is required.'
                        };
                        return;
                    }

                    this.profileLoading = true;

                    try {
                        // Simulate API call
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        // In a real app, you would make an API call like:
                        /*
                        const response = await fetch('/api/user/profile', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(this.userProfile)
                        });

                        if (response.ok) {
                            this.profileFeedback = {
                                type: 'success',
                                message: 'Profile updated successfully!'
                            };
                        } else {
                            throw new Error('Failed to update profile');
                        }
                        */

                        // Simulate successful profile update
                        this.profileFeedback = {
                            type: 'success',
                            message: 'Profile updated successfully!'
                        };

                    } catch (error) {
                        console.error('Error updating profile:', error);
                        this.profileFeedback = {
                            type: 'error',
                            message: 'Failed to update profile. Please try again.'
                        };
                    } finally {
                        this.profileLoading = false;
                    }
                },

                // Additional utility method to check password strength
                checkPasswordStrength(password) {
                    if (!password) return 0;

                    let strength = 0;

                    // Length check
                    if (password.length >= 8) strength++;
                    if (password.length >= 12) strength++;

                    // Character variety checks
                    if (/[a-z]/.test(password)) strength++;
                    if (/[A-Z]/.test(password)) strength++;
                    if (/[0-9]/.test(password)) strength++;
                    if (/[^a-zA-Z0-9]/.test(password)) strength++;

                    return strength;
                }
            },
            watch: {
                // Watch for dark mode changes to apply immediately
                'preferences.darkMode': function(newVal) {
                    if (newVal) {
                        document.body.classList.add('dark-mode');
                    } else {
                        document.body.classList.remove('dark-mode');
                    }
                },

                // Watch new password for strength indicator (optional enhancement)
                'passwordForm.newPassword': function(newVal) {
                    // You could add a password strength indicator here
                    const strength = this.checkPasswordStrength(newVal);
                    // console.log('Password strength:', strength);
                }
            }
        }).mount('#app');
    </script>

    <!-- Optional: Add some CSS for the new profile section and feedback states -->
    <style>
        .settings-feedback.success {
            color: #10b981;
            background-color: #ecfdf5;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #d1fae5;
        }

        .settings-feedback.error {
            color: #ef4444;
            background-color: #fef2f2;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #fecaca;
        }

        .settings-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .dark-mode {
            background-color: #1f2937;
            color: #f9fafb;
        }

        .dark-mode .settings-card {
            background-color: #374151;
            border-color: #4b5563;
        }

        .dark-mode input,
        .dark-mode select,
        .dark-mode textarea {
            background-color: #4b5563;
            border-color: #6b7280;
            color: #f9fafb;
        }

        .dark-mode input:disabled {
            background-color: #6b7280;
            color: #d1d5db;
        }

        .password-strength {
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .strength-bar {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 0.25rem;
        }

        .strength-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .strength-fill.weak { background: #f59e0b; }
        .strength-fill.fair { background: #eab308; }
        .strength-fill.good { background: #84cc16; }
        .strength-fill.strong { background: #22c55e; }

        .strength-text {
            color: #6b7280;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .strength-text.weak { color: #f59e0b; }
        .strength-text.fair { color: #eab308; }
        .strength-text.good { color: #84cc16; }
        .strength-text.strong { color: #22c55e; }

        .password-mismatch {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
    </style>
</body>
</html>
