<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings | Memofy</title>
    <link rel="stylesheet" href="/css/admin-dash.css">
    <link rel="stylesheet" href="/css/secretary-side-css.css">
    <link rel="stylesheet" href="/css/sec-topbar.css">
    <link rel="stylesheet" href="/css/sec-nav.css">
    <link rel="stylesheet" href="/css/settings.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Google Analytics Tracking -->
    <%- include('google-analytics', { propertyId: typeof gaPropertyId !== 'undefined' ? gaPropertyId : null }); %>

    <!-- Vue.js CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="/js/lucide.min.js"></script>
</head>
<body>
    <div id="app" class="dashboard-container">
        <%- include('../components/sec-nav'); %>

        <main class="main-content">
            <%- include('../components/sec-topbar'); %>

            <section class="settings-section">
                <div class="settings-header">
                    <h1>Account Settings</h1>
                    <p>Update your password and notification preferences.</p>
                </div>

                <div class="settings-grid">
                    <!-- Change Password Card -->
                    <div class="settings-card">
                        <h3>Change Password</h3>
                        <p>Keep your account protected by using a strong password.</p>
                        <form @submit.prevent="updatePassword" class="settings-form">
                            <div>
                                <label for="currentPassword">Current Password</label>
                                <input type="password"
                                       id="currentPassword"
                                       v-model="passwordForm.currentPassword"
                                       autocomplete="current-password"
                                       required
                                       :disabled="passwordLoading">
                            </div>
                            <div>
                                <label for="newPassword">New Password</label>
                                <input type="password"
                                       id="newPassword"
                                       v-model="passwordForm.newPassword"
                                       autocomplete="new-password"
                                       required
                                       :disabled="passwordLoading">
                            </div>
                            <div>
                                <label for="confirmPassword">Confirm New Password</label>
                                <input type="password"
                                       id="confirmPassword"
                                       v-model="passwordForm.confirmPassword"
                                       autocomplete="new-password"
                                       required
                                       :disabled="passwordLoading">
                            </div>
                            <div class="settings-actions">
                                <button type="submit"
                                        class="settings-btn primary"
                                        :disabled="passwordLoading">
                                    {{ passwordLoading ? 'Updating...' : 'Update Password' }}
                                </button>
                            </div>
                            <div class="settings-feedback"
                                 :class="passwordFeedback.type"
                                 role="status">
                                {{ passwordFeedback.message }}
                            </div>
                        </form>
                    </div>

                    <!-- Preferences Card -->
                    <div class="settings-card">
                        <h3>Notification Preferences</h3>
                        <p>Choose how youâ€™d like to be notified about important updates.</p>
                        <div class="preferences-grid">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4>Email me when I distribute or receive memos</h4>
                                    <p>Get an email whenever a memo related to you is created or sent.</p>
                                </div>
                                <label class="switch">
<<<<<<< HEAD
                                    <input type="checkbox"
                                           v-model="preferences.darkMode"
                                           @change="updatePreference('darkMode', $event.target.checked)">
=======
                                    <input type="checkbox" id="memoEmailToggle">
>>>>>>> f00053134ca7dca831b15d8e6b5e24fe42a175b5
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4>Email me about profile or account changes</h4>
                                    <p>Be notified if your profile details are updated.</p>
                                </div>
                                <label class="switch">
<<<<<<< HEAD
                                    <input type="checkbox"
                                           v-model="preferences.twoFactorEnabled"
                                           @change="updatePreference('twoFactorEnabled', $event.target.checked)">
=======
                                    <input type="checkbox" id="profileUpdateToggle">
>>>>>>> f00053134ca7dca831b15d8e6b5e24fe42a175b5
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
<<<<<<< HEAD
                        <div class="settings-feedback"
                             :class="securityFeedback.type"
                             role="status">
                            {{ securityFeedback.message }}
                        </div>
                    </div>

                    <!-- Profile Information Card (Optional Addition) -->
                    <div class="settings-card" v-if="userProfile">
                        <h3>Profile Information</h3>
                        <p>Update your personal details and contact information.</p>
                        <form @submit.prevent="updateProfile" class="settings-form">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label for="firstName">First Name</label>
                                    <input type="text"
                                           id="firstName"
                                           v-model="userProfile.firstName"
                                           placeholder="Enter your first name">
                                </div>
                                <div>
                                    <label for="lastName">Last Name</label>
                                    <input type="text"
                                           id="lastName"
                                           v-model="userProfile.lastName"
                                           placeholder="Enter your last name">
                                </div>
                            </div>
                            <div>
                                <label for="email">Email Address</label>
                                <input type="email"
                                       id="email"
                                       v-model="userProfile.email"
                                       placeholder="your.email@example.com"
                                       required>
                            </div>
                            <div>
                                <label for="department">Department</label>
                                <input type="text"
                                       id="department"
                                       v-model="userProfile.department"
                                       placeholder="Your department"
                                       disabled>
                            </div>
                            <div class="settings-actions">
                                <button type="submit"
                                        class="settings-btn primary"
                                        :disabled="profileLoading">
                                    {{ profileLoading ? 'Saving...' : 'Save Changes' }}
                                </button>
                            </div>
                            <div class="settings-feedback"
                                 :class="profileFeedback.type"
                                 role="status">
                                {{ profileFeedback.message }}
                            </div>
                        </form>
=======
                        <div class="settings-feedback" id="notificationFeedback" role="status"></div>
>>>>>>> f00053134ca7dca831b15d8e6b5e24fe42a175b5
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // Password form data
                    passwordForm: {
                        currentPassword: '',
                        newPassword: '',
                        confirmPassword: ''
                    },

                    // User preferences
                    preferences: {
                        darkMode: false,
                        twoFactorEnabled: false
                    },

                    // User profile data
                    userProfile: {
                        firstName: '<%= user.firstName || "" %>',
                        lastName: '<%= user.lastName || "" %>',
                        email: '<%= user.email || "" %>',
                        department: '<%= user.department || "" %>'
                    },

                    // Loading states
                    passwordLoading: false,
                    profileLoading: false,

                    // Feedback messages
                    passwordFeedback: {
                        type: '', // 'success' or 'error'
                        message: ''
                    },
                    securityFeedback: {
                        type: '',
                        message: ''
                    },
                    profileFeedback: {
                        type: '',
                        message: ''
                    }
                }
            },
            mounted() {
                this.loadUserPreferences();
                this.loadUserProfile();

                // Initialize Lucide icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            },
            methods: {
                // Load user preferences from localStorage or API
                loadUserPreferences() {
                    // Load from localStorage for demo purposes
                    const savedDarkMode = localStorage.getItem('memofy_darkMode') === 'true';
                    const savedTwoFactor = localStorage.getItem('memofy_twoFactorEnabled') === 'true';

                    this.preferences.darkMode = savedDarkMode;
                    this.preferences.twoFactorEnabled = savedTwoFactor;

                    // Apply dark mode if enabled
                    if (savedDarkMode) {
                        document.body.classList.add('dark-mode');
                    }
                },

                // Load user profile data
                loadUserProfile() {
                    // In a real app, you might fetch this from an API
                    // For now, we're using EJS template data passed to userProfile
                    console.log('Profile loaded:', this.userProfile);
                },

                // Update password
                async updatePassword() {
                    // Reset feedback
                    this.passwordFeedback = { type: '', message: '' };

                    // Validation
                    if (!this.passwordForm.currentPassword) {
                        this.passwordFeedback = {
                            type: 'error',
                            message: 'Please enter your current password.'
                        };
                        return;
                    }

                    if (this.passwordForm.newPassword.length < 8) {
                        this.passwordFeedback = {
                            type: 'error',
                            message: 'New password must be at least 8 characters long.'
                        };
                        return;
                    }

                    if (this.passwordForm.newPassword !== this.passwordForm.confirmPassword) {
                        this.passwordFeedback = {
                            type: 'error',
                            message: 'New passwords do not match.'
                        };
                        return;
                    }

                    this.passwordLoading = true;

                    try {
                        // Simulate API call
                        await new Promise(resolve => setTimeout(resolve, 1500));

                        // In a real app, you would make an API call like:
                        /*
                        const response = await fetch('/api/user/change-password', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(this.passwordForm)
                        });

                        if (response.ok) {
                            this.passwordFeedback = {
                                type: 'success',
                                message: 'Password updated successfully!'
                            };
                            this.passwordForm = {
                                currentPassword: '',
                                newPassword: '',
                                confirmPassword: ''
                            };
                        } else {
                            throw new Error('Failed to update password');
                        }
                        */

                        // Simulate successful password update
                        this.passwordFeedback = {
                            type: 'success',
                            message: 'Password updated successfully!'
                        };

                        // Clear form
                        this.passwordForm = {
                            currentPassword: '',
                            newPassword: '',
                            confirmPassword: ''
                        };

                    } catch (error) {
                        console.error('Error updating password:', error);
                        this.passwordFeedback = {
                            type: 'error',
                            message: 'Failed to update password. Please try again.'
                        };
                    } finally {
                        this.passwordLoading = false;
                    }
                },

                // Update preference (dark mode, 2FA, etc.)
                async updatePreference(setting, value) {
                    // Reset feedback
                    this.securityFeedback = { type: '', message: '' };

                    try {
                        // Save to localStorage for demo
                        localStorage.setItem(`memofy_${setting}`, value);

                        // In a real app, you would make an API call like:
                        /*
                        const response = await fetch('/api/user/preferences', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                [setting]: value
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Failed to update preference');
                        }
                        */

                        // Handle specific preferences
                        if (setting === 'darkMode') {
                            if (value) {
                                document.body.classList.add('dark-mode');
                            } else {
                                document.body.classList.remove('dark-mode');
                            }
                        }

                        this.securityFeedback = {
                            type: 'success',
                            message: 'Preference updated successfully!'
                        };

                        // Clear feedback after 3 seconds
                        setTimeout(() => {
                            this.securityFeedback = { type: '', message: '' };
                        }, 3000);

                    } catch (error) {
                        console.error('Error updating preference:', error);

                        // Revert the toggle
                        this.preferences[setting] = !value;

                        this.securityFeedback = {
                            type: 'error',
                            message: 'Failed to update preference. Please try again.'
                        };
                    }
                },

                // Update user profile
                async updateProfile() {
                    // Reset feedback
                    this.profileFeedback = { type: '', message: '' };

                    // Validation
                    if (!this.userProfile.email) {
                        this.profileFeedback = {
                            type: 'error',
                            message: 'Email address is required.'
                        };
                        return;
                    }

                    this.profileLoading = true;

                    try {
                        // Simulate API call
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        // In a real app, you would make an API call like:
                        /*
                        const response = await fetch('/api/user/profile', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(this.userProfile)
                        });

                        if (response.ok) {
                            this.profileFeedback = {
                                type: 'success',
                                message: 'Profile updated successfully!'
                            };
                        } else {
                            throw new Error('Failed to update profile');
                        }
                        */

                        // Simulate successful profile update
                        this.profileFeedback = {
                            type: 'success',
                            message: 'Profile updated successfully!'
                        };

                    } catch (error) {
                        console.error('Error updating profile:', error);
                        this.profileFeedback = {
                            type: 'error',
                            message: 'Failed to update profile. Please try again.'
                        };
                    } finally {
                        this.profileLoading = false;
                    }
                },

                // Additional utility method to check password strength
                checkPasswordStrength(password) {
                    if (!password) return 0;

                    let strength = 0;

                    // Length check
                    if (password.length >= 8) strength++;
                    if (password.length >= 12) strength++;

                    // Character variety checks
                    if (/[a-z]/.test(password)) strength++;
                    if (/[A-Z]/.test(password)) strength++;
                    if (/[0-9]/.test(password)) strength++;
                    if (/[^a-zA-Z0-9]/.test(password)) strength++;

                    return strength;
                }
            },
            watch: {
                // Watch for dark mode changes to apply immediately
                'preferences.darkMode': function(newVal) {
                    if (newVal) {
                        document.body.classList.add('dark-mode');
                    } else {
                        document.body.classList.remove('dark-mode');
                    }
                },

                // Watch new password for strength indicator (optional enhancement)
                'passwordForm.newPassword': function(newVal) {
                    // You could add a password strength indicator here
                    const strength = this.checkPasswordStrength(newVal);
                    // console.log('Password strength:', strength);
                }
            }
        }).mount('#app');
    </script>

    <!-- Optional: Add some CSS for the new profile section and feedback states -->
    <style>
        .settings-feedback.success {
            color: #10b981;
            background-color: #ecfdf5;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #d1fae5;
        }

        .settings-feedback.error {
            color: #ef4444;
            background-color: #fef2f2;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #fecaca;
        }

        .settings-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .dark-mode {
            background-color: #1f2937;
            color: #f9fafb;
        }

        .dark-mode .settings-card {
            background-color: #374151;
            border-color: #4b5563;
        }

        .dark-mode input,
        .dark-mode select,
        .dark-mode textarea {
            background-color: #4b5563;
            border-color: #6b7280;
            color: #f9fafb;
        }

        .dark-mode input:disabled {
            background-color: #6b7280;
            color: #d1d5db;
        }
    </style>
</body>
</html>
