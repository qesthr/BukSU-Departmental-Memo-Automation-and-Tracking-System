<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archive | Memofy</title>
    <link rel="stylesheet" href="/css/faculty-memos.css">
    <link rel="stylesheet" href="/css/log.css">
    <link rel="stylesheet" href="/css/fal-topbar.css">
    <link rel="stylesheet" href="/css/fal-nav.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Google Analytics Tracking -->
    <%- include('google-analytics', { propertyId: typeof gaPropertyId !=='undefined' ? gaPropertyId : null }); %>

    <script src="/js/lucide.min.js"></script>
</head>

<body>
    <div class="dashboard-container">
        <%- include('../components/fal-nav'); %>

        <main class="main-content">
            <%- include('../components/fal-topbar'); %>

            <div class="dashboard-content">
                <div class="log-layout">

                    <!-- Archive Memo List Area -->
                    <section class="memo-list-area" style="flex:1 1 auto;">
                        <div class="memo-container">
                            <div class="memo-list-header">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                    <i data-lucide="archive" style="width: 24px; height: 24px; color: #6366f1;"></i>
                                    <h2 style="margin: 0; font-size: 24px; font-weight: 600; color: #1f2937;">Archived Received Memos</h2>
                                </div>
                                <div class="header-controls">
                                    <button id="refreshBtn" class="icon-btn-sm" title="Refresh">
                                        <i data-lucide="rotate-cw"></i>
                                    </button>
                                </div>
                                <div class="department-filters">
                                    <div class="priority-dropdown-wrapper">
                                        <select id="priorityFilterDropdown" class="priority-filter-dropdown">
                                            <option value="all">All Priorities</option>
                                            <option value="urgent">ðŸ”´ Urgent</option>
                                            <option value="high">ðŸŸ  High</option>
                                            <option value="medium">ðŸŸ¡ Medium</option>
                                            <option value="low">ðŸ”µ Low</option>
                                        </select>
                                    </div>
                                    <div class="sort-dropdown-wrapper">
                                        <select id="sortDropdown" class="sort-dropdown">
                                            <option value="newest">Newest</option>
                                            <option value="oldest">Oldest</option>
                                            <option value="priority">Priority</option>
                                            <option value="subject">Subject (A-Z)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="memo-list-container">
                                <div id="archiveList" class="memo-list"></div>
                            </div>
                        </div>
                    </section>

                    <!-- Viewer Area -->
                    <section id="memoViewerArea" class="memo-viewer-area">
                        <div id="emptyState" class="empty-state-view">
                            <i data-lucide="archive"></i>
                            <p>Select a memo to view</p>
                        </div>
                        <div id="memoViewer" class="memo-viewer">
                            <div class="viewer-header">
                                <button id="backBtn" class="icon-btn"><i data-lucide="arrow-left"></i></button>
                                <div class="nav-buttons">
                                    <button id="prevBtn" class="icon-btn"><i data-lucide="chevron-left"></i></button>
                                    <span id="memoCounter" class="memo-counter">0 of 0</span>
                                    <button id="nextBtn" class="icon-btn"><i data-lucide="chevron-right"></i></button>
                                </div>
                                <div class="viewer-actions">
                                    <button id="starBtn" class="icon-btn" title="Toggle Favorite"><i data-lucide="bookmark"></i></button>
                                    <button id="unarchiveBtn" class="icon-btn" title="Unarchive Memo"><i data-lucide="archive-restore"></i></button>
                                    <button id="downloadBtn" class="icon-btn" title="Download Memo"><i data-lucide="download"></i></button>
                                </div>
                            </div>
                            <div class="memo-content">
                                <div class="memo-pdf-header">
                                    <h1 class="memo-title">MEMO</h1>
                                    <div class="memo-details">
                                        <div class="memo-detail-row"><span class="memo-detail-label">Subject:</span><span id="memoDetailSubject" class="memo-detail-value"></span></div>
                                        <div class="memo-detail-row"><span class="memo-detail-label">From:</span><span id="memoDetailFrom" class="memo-detail-value"></span></div>
                                        <div class="memo-detail-row"><span class="memo-detail-label">To:</span><span id="memoDetailTo" class="memo-detail-value"></span></div>
                                        <div class="memo-detail-row"><span class="memo-detail-label">Department:</span><span id="memoDetailDepartment" class="memo-detail-value"></span></div>
                                        <div class="memo-detail-row"><span class="memo-detail-label">Priority:</span><span id="memoDetailPriority" class="memo-detail-value"></span></div>
                                        <div class="memo-detail-row"><span class="memo-detail-label">Date:</span><span id="memoDetailDate" class="memo-detail-value"></span></div>
                                    </div>
                                </div>
                                <div id="memoBodyContent" class="memo-body-content"></div>
                                <div id="attachments" class="attachments-section"></div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script>
        window.currentUser = {
            id: '<%= user._id %>',
            email: '<%= user.email %>',
            role: '<%= user.role %>',
            department: '<%= user.department || "" %>'
        };

        window.archivedMemos = <%- JSON.stringify(archivedMemos || []) %>;
    </script>
    <script src="/js/log.js"></script>
    <script src="/js/log-viewer.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const archiveList = document.getElementById('archiveList');
            const refreshBtn = document.getElementById('refreshBtn');
            const priorityFilter = document.getElementById('priorityFilterDropdown');
            const sortDropdown = document.getElementById('sortDropdown');
            const unarchiveBtn = document.getElementById('unarchiveBtn');
            const backBtn = document.getElementById('backBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const starBtn = document.getElementById('starBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const memoViewerArea = document.getElementById('memoViewerArea');
            const emptyState = document.getElementById('emptyState');
            const memoViewer = document.getElementById('memoViewer');
            const memoCounter = document.getElementById('memoCounter');

            let filteredMemos = [...(window.archivedMemos || [])];
            let currentMemoIndex = -1;
            let currentMemoId = null;

            // Render archived memos
            function renderArchiveList() {
                if (!archiveList) return;

                if (filteredMemos.length === 0) {
                    archiveList.innerHTML = `
                        <div class="memo-item">
                            <i data-lucide="archive" class="memo-icon"></i>
                            <div class="memo-info">
                                <h4>No archived memos</h4>
                                <p>Archived received memos will appear here</p>
                            </div>
                        </div>`;
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                    return;
                }

                archiveList.innerHTML = filteredMemos.map((memo, idx) => {
                    const senderName = ((memo.sender?.firstName || '') + ' ' + (memo.sender?.lastName || '')).trim();
                    const senderEmail = memo.sender?.email || '';
                    const realAvatar = memo.sender?.profilePicture;
                    const avatarSrc = realAvatar || '/images/memofy-logo.png';
                    const dateStr = new Date(memo.createdAt).toLocaleDateString();
                    const pr = (memo.priority || '').toLowerCase();
                    let badge = '';
                    if (pr === 'urgent') badge = '<span class="priority-badge priority-urgent" title="Urgent">ðŸ”´ URGENT</span>';
                    else if (pr === 'high') badge = '<span class="priority-badge priority-high" title="High">ðŸŸ  HIGH</span>';
                    else if (pr === 'medium') badge = '<span class="priority-badge priority-medium" title="Medium">ðŸŸ¡ MEDIUM</span>';
                    else if (pr === 'low') badge = '<span class="priority-badge priority-low" title="Low">ðŸ”µ LOW</span>';

                    const hasAvatar = realAvatar ? '1' : '0';
                    return '<div class="memo-item archived-item" data-index="' + idx + '" data-id="' + memo._id + '">' +
                        '<img src="' + avatarSrc + '" alt="' + senderName + '" class="memo-avatar" data-has-avatar="' + hasAvatar + '">' +
                        '<div class="memo-sender-info">' +
                        '<div class="memo-sender-name">From: ' + (senderName || 'Unknown') + '</div>' +
                        '<div class="memo-sender-email">' + senderEmail + '</div>' +
                        '</div>' +
                        '<div class="memo-item-actions">' + badge + '</div>' +
                        '<div class="memo-subject">' + (memo.subject || '') + '</div>' +
                        '<div class="memo-date">' + dateStr + '</div>' +
                        '</div>';
                }).join('');

                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                // Add click handlers
                archiveList.querySelectorAll('.archived-item').forEach(el => {
                    el.addEventListener('click', async () => {
                        const id = el.getAttribute('data-id');
                        if (id) {
                            try {
                                const res = await fetch('/api/log/memos/' + id);
                                const data = await res.json();
                                if (data && data.success && data.memo) {
                                    openMemo(data.memo);
                                    return;
                                }
                            } catch (e) { /* fallback below */ }
                        }
                        const idx = Number(el.getAttribute('data-index'));
                        const fallback = filteredMemos[idx];
                        if (fallback) openMemo(fallback);
                    });
                });

                // Lazy-load avatars
                archiveList.querySelectorAll('img.memo-avatar[data-has-avatar="0"]').forEach(img => {
                    img.addEventListener('error', function() {
                        this.src = '/images/memofy-logo.png';
                    });
                });
            }

            // Open memo in viewer
            function openMemo(memo) {
                if (!memo) return;
                currentMemoId = memo._id;
                currentMemoIndex = filteredMemos.findIndex(m => m._id === memo._id);

                const subjectEl = document.getElementById('memoDetailSubject');
                const fromEl = document.getElementById('memoDetailFrom');
                const toEl = document.getElementById('memoDetailTo');
                const deptEl = document.getElementById('memoDetailDepartment');
                const prioEl = document.getElementById('memoDetailPriority');
                const dateEl = document.getElementById('memoDetailDate');
                const contentEl = document.getElementById('memoBodyContent');
                const attachmentsEl = document.getElementById('attachments');

                if (subjectEl) subjectEl.textContent = memo.subject || '(No subject)';
                const senderName = ((memo.sender?.firstName || '') + ' ' + (memo.sender?.lastName || '')).trim();
                if (fromEl) fromEl.textContent = (senderName || 'Unknown') + ' (' + (memo.sender?.email || '') + ')';
                const recipName = ((memo.recipient?.firstName || '') + ' ' + (memo.recipient?.lastName || '')).trim();
                if (toEl) toEl.textContent = (recipName || 'Unknown') + ' (' + (memo.recipient?.email || '') + ')';
                if (deptEl) deptEl.textContent = memo.department || 'N/A';
                if (prioEl) prioEl.textContent = memo.priority || 'medium';
                if (dateEl) dateEl.textContent = new Date(memo.createdAt).toLocaleString();
                if (contentEl) {
                    if (memo.htmlContent) {
                        contentEl.innerHTML = memo.htmlContent;
                    } else {
                        const safeContent = (memo.content || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        contentEl.innerHTML = '<div style="white-space: pre-wrap; line-height: 1.6; color: #111827;">' + safeContent + '</div>';
                    }
                }

                // Render attachments
                if (attachmentsEl && memo.attachments && memo.attachments.length > 0) {
                    attachmentsEl.innerHTML = '<h3 style="margin: 20px 0 10px; font-size: 16px; font-weight: 600;">Attachments:</h3>' +
                        memo.attachments.map(att => {
                            const url = att.url || att.path || '';
                            return `<div style="margin: 8px 0;">
                                <a href="${url}" target="_blank" style="color: #1C89E3; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                                    <i data-lucide="paperclip" style="width: 16px; height: 16px;"></i>
                                    <span>${att.filename || 'Attachment'}</span>
                                </a>
                            </div>`;
                        }).join('');
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                } else if (attachmentsEl) {
                    attachmentsEl.innerHTML = '';
                }

                if (memoCounter) {
                    memoCounter.textContent = `${currentMemoIndex + 1} of ${filteredMemos.length}`;
                }

                if (emptyState) emptyState.style.display = 'none';
                if (memoViewer) memoViewer.style.display = 'block';
                if (memoViewerArea) {
                    memoViewerArea.style.display = 'block';
                    memoViewerArea.style.flex = '0 0 55%';
                }
            }

            // Unarchive memo
            async function unarchiveMemo(memoId) {
                if (!memoId) return;
                try {
                    const response = await fetch('/api/log/memos/' + memoId, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'same-origin',
                        body: JSON.stringify({ status: 'sent' })
                    });
                    const data = await response.json();
                    if (data && data.success) {
                        // Remove from list
                        filteredMemos = filteredMemos.filter(m => m._id !== memoId);
                        window.archivedMemos = window.archivedMemos.filter(m => m._id !== memoId);
                        renderArchiveList();
                        if (emptyState) emptyState.style.display = 'block';
                        if (memoViewer) memoViewer.style.display = 'none';
                        if (typeof showNotification === 'function') {
                            showNotification('Memo unarchived successfully', 'success');
                        }
                    }
                } catch (error) {
                    console.error('Error unarchiving memo:', error);
                }
            }

            // Event listeners
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async () => {
                    window.location.reload();
                });
            }

            if (unarchiveBtn) {
                unarchiveBtn.addEventListener('click', () => {
                    if (currentMemoId) {
                        unarchiveMemo(currentMemoId);
                    }
                });
            }

            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    if (emptyState) emptyState.style.display = 'block';
                    if (memoViewer) memoViewer.style.display = 'none';
                    if (memoViewerArea) memoViewerArea.style.display = 'none';
                });
            }

            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (currentMemoIndex > 0) {
                        currentMemoIndex--;
                        openMemo(filteredMemos[currentMemoIndex]);
                    }
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if (currentMemoIndex < filteredMemos.length - 1) {
                        currentMemoIndex++;
                        openMemo(filteredMemos[currentMemoIndex]);
                    }
                });
            }

            // Apply filters
            if (priorityFilter) {
                priorityFilter.addEventListener('change', () => {
                    const priority = priorityFilter.value;
                    if (priority === 'all') {
                        filteredMemos = [...(window.archivedMemos || [])];
                    } else {
                        filteredMemos = (window.archivedMemos || []).filter(m => (m.priority || '').toLowerCase() === priority);
                    }
                    renderArchiveList();
                });
            }

            if (sortDropdown) {
                sortDropdown.addEventListener('change', () => {
                    const sort = sortDropdown.value;
                    filteredMemos.sort((a, b) => {
                        if (sort === 'newest') return new Date(b.createdAt) - new Date(a.createdAt);
                        if (sort === 'oldest') return new Date(a.createdAt) - new Date(b.createdAt);
                        if (sort === 'priority') {
                            const priorityOrder = { urgent: 4, high: 3, medium: 2, low: 1 };
                            return (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
                        }
                        if (sort === 'subject') return (a.subject || '').localeCompare(b.subject || '');
                        return 0;
                    });
                    renderArchiveList();
                });
            }

            // Initial render
            renderArchiveList();
            lucide.createIcons();
        });
    </script>
</body>
</html>

