<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archive | Memofy</title>
    <link rel="stylesheet" href="/css/faculty-memos.css">
    <link rel="stylesheet" href="/css/log.css">
    <link rel="stylesheet" href="/css/fal-topbar.css">
    <link rel="stylesheet" href="/css/fal-nav.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Google Analytics Tracking -->
    <%- include('google-analytics', { propertyId: typeof gaPropertyId !=='undefined' ? gaPropertyId : null }); %>

    <script src="/js/lucide.min.js"></script>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>

<body
    data-current-user='<%- JSON.stringify({
        id: user._id,
        email: user.email,
        role: user.role,
        department: user.department || ""
    }) %>'
    data-archived-memos='<%- JSON.stringify(archivedMemos || []) %>'>

    <div id="app" class="dashboard-container">
        <%- include('../components/fal-nav'); %>

        <main class="main-content">
            <%- include('../components/fal-topbar'); %>

            <div class="dashboard-content">
                <div class="log-layout">
                    <!-- Archive Memo List Area -->
                    <section class="memo-list-area" style="flex:1 1 auto;">
                        <div class="memo-container">
                            <div class="memo-list-header">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                    <i data-lucide="archive" style="width: 24px; height: 24px; color: #6366f1;"></i>
                                    <h2 style="margin: 0; font-size: 24px; font-weight: 600; color: #1f2937;">Archived Received Memos</h2>
                                </div>
                                <div class="header-controls">
                                    <button @click="refreshArchive" class="icon-btn-sm" title="Refresh">
                                        <i data-lucide="rotate-cw"></i>
                                    </button>
                                </div>
                                <div class="department-filters">
                                    <div class="priority-dropdown-wrapper">
                                        <select v-model="filters.priority" class="priority-filter-dropdown">
                                            <option value="all">All Priorities</option>
                                            <option value="urgent">ðŸ”´ Urgent</option>
                                            <option value="high">ðŸŸ  High</option>
                                            <option value="medium">ðŸŸ¡ Medium</option>
                                            <option value="low">ðŸ”µ Low</option>
                                        </select>
                                    </div>
                                    <div class="sort-dropdown-wrapper">
                                        <select v-model="filters.sortBy" class="sort-dropdown">
                                            <option value="newest">Newest</option>
                                            <option value="oldest">Oldest</option>
                                            <option value="priority">Priority</option>
                                            <option value="subject">Subject (A-Z)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="memo-list-container">
                                <div class="memo-list">
                                    <div v-if="filteredMemos.length === 0" class="memo-item">
                                        <i data-lucide="archive" class="memo-icon"></i>
                                        <div class="memo-info">
                                            <h4>No archived memos</h4>
                                            <p>Archived received memos will appear here</p>
                                        </div>
                                    </div>

                                    <div
                                        v-for="(memo, index) in filteredMemos"
                                        :key="memo._id"
                                        class="memo-item archived-item"
                                        @click="openMemo(memo)"
                                    >
                                        <img
                                            :src="getAvatar(memo.sender)"
                                            :alt="getSenderName(memo.sender)"
                                            class="memo-avatar"
                                            @error="handleAvatarError"
                                        >
                                        <div class="memo-sender-info">
                                            <div class="memo-sender-name">From: {{ getSenderName(memo.sender) }}</div>
                                            <div class="memo-sender-email">{{ memo.sender?.email || '' }}</div>
                                        </div>
                                        <div class="memo-item-actions">
                                            <span :class="getPriorityClass(memo.priority)" :title="memo.priority">
                                                {{ getPriorityBadge(memo.priority) }}
                                            </span>
                                        </div>
                                        <div class="memo-subject">{{ memo.subject || '' }}</div>
                                        <div class="memo-date">{{ formatDate(memo.createdAt) }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Viewer Area -->
                    <section
                        class="memo-viewer-area"
                        :style="{ display: viewerVisible ? 'block' : 'none', flex: viewerVisible ? '0 0 55%' : 'none' }"
                    >
                        <div v-if="!currentMemo" class="empty-state-view">
                            <i data-lucide="archive"></i>
                            <p>Select a memo to view</p>
                        </div>

                        <div v-else class="memo-viewer">
                            <div class="viewer-header">
                                <button @click="closeViewer" class="icon-btn">
                                    <i data-lucide="arrow-left"></i>
                                </button>
                                <div class="nav-buttons">
                                    <button @click="prevMemo" class="icon-btn" :disabled="currentMemoIndex === 0">
                                        <i data-lucide="chevron-left"></i>
                                    </button>
                                    <span class="memo-counter">{{ currentMemoIndex + 1 }} of {{ filteredMemos.length }}</span>
                                    <button @click="nextMemo" class="icon-btn" :disabled="currentMemoIndex === filteredMemos.length - 1">
                                        <i data-lucide="chevron-right"></i>
                                    </button>
                                </div>
                                <div class="viewer-actions">
                                    <button @click="toggleFavorite" class="icon-btn" title="Toggle Favorite">
                                        <i data-lucide="bookmark"></i>
                                    </button>
                                    <button @click="unarchiveCurrentMemo" class="icon-btn" title="Unarchive Memo">
                                        <i data-lucide="archive-restore"></i>
                                    </button>
                                    <button @click="downloadMemo" class="icon-btn" title="Download Memo">
                                        <i data-lucide="download"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="memo-content">
                                <div class="memo-pdf-header">
                                    <h1 class="memo-title">MEMO</h1>
                                    <div class="memo-details">
                                        <div class="memo-detail-row">
                                            <span class="memo-detail-label">Subject:</span>
                                            <span class="memo-detail-value">{{ currentMemo.subject || '(No subject)' }}</span>
                                        </div>
                                        <div class="memo-detail-row">
                                            <span class="memo-detail-label">From:</span>
                                            <span class="memo-detail-value">
                                                {{ getSenderName(currentMemo.sender) }} ({{ currentMemo.sender?.email || '' }})
                                            </span>
                                        </div>
                                        <div class="memo-detail-row">
                                            <span class="memo-detail-label">To:</span>
                                            <span class="memo-detail-value">
                                                {{ getRecipientName(currentMemo.recipient) }} ({{ currentMemo.recipient?.email || '' }})
                                            </span>
                                        </div>
                                        <div class="memo-detail-row">
                                            <span class="memo-detail-label">Department:</span>
                                            <span class="memo-detail-value">{{ currentMemo.department || 'N/A' }}</span>
                                        </div>
                                        <div class="memo-detail-row">
                                            <span class="memo-detail-label">Priority:</span>
                                            <span class="memo-detail-value">{{ currentMemo.priority || 'medium' }}</span>
                                        </div>
                                        <div class="memo-detail-row">
                                            <span class="memo-detail-label">Date:</span>
                                            <span class="memo-detail-value">{{ formatDateTime(currentMemo.createdAt) }}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="memo-body-content" v-html="getMemoContent(currentMemo)"></div>

                                <div v-if="currentMemo.attachments && currentMemo.attachments.length > 0" class="attachments-section">
                                    <h3 style="margin: 20px 0 10px; font-size: 16px; font-weight: 600;">Attachments:</h3>
                                    <div v-for="attachment in currentMemo.attachments" :key="attachment.filename" style="margin: 8px 0;">
                                        <a :href="attachment.url || attachment.path" target="_blank"
                                           style="color: #1C89E3; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                                            <i data-lucide="paperclip" style="width: 16px; height: 16px;"></i>
                                            <span>{{ attachment.filename || 'Attachment' }}</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    archivedMemos: [],
                    currentMemo: null,
                    currentMemoIndex: -1,
                    viewerVisible: false,
                    filters: {
                        priority: 'all',
                        sortBy: 'newest'
                    }
                };
            },
            computed: {
                filteredMemos() {
                    let memos = [...this.archivedMemos];

                    if (this.filters.priority !== 'all') {
                        memos = memos.filter(memo => (memo.priority || '').toLowerCase() === this.filters.priority);
                    }

                    memos.sort((a, b) => {
                        switch (this.filters.sortBy) {
                            case 'newest':
                                return new Date(b.createdAt) - new Date(a.createdAt);
                            case 'oldest':
                                return new Date(a.createdAt) - new Date(b.createdAt);
                            case 'priority':
                                const priorityOrder = { urgent: 4, high: 3, medium: 2, low: 1 };
                                return (priorityOrder[(b.priority || '').toLowerCase()] || 0) -
                                       (priorityOrder[(a.priority || '').toLowerCase()] || 0);
                            case 'subject':
                                return (a.subject || '').localeCompare(b.subject || '');
                            default:
                                return 0;
                        }
                    });

                    return memos;
                }
            },
            mounted() {
                this.loadInitialData();
                this.refreshLucideIcons();
            },
            methods: {
                loadInitialData() {
                    try {
                        const memoData = document.body.getAttribute('data-archived-memos');
                        if (memoData) {
                            this.archivedMemos = JSON.parse(memoData);
                        }
                    } catch (error) {
                        console.error('Error parsing archived memo data:', error);
                    }
                },

                refreshLucideIcons() {
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                },

                refreshArchive() {
                    window.location.reload();
                },

                getSenderName(sender) {
                    if (!sender) return 'Unknown';
                    return `${sender.firstName || ''} ${sender.lastName || ''}`.trim() || 'Unknown';
                },

                getRecipientName(recipient) {
                    if (!recipient) return 'Unknown';
                    return `${recipient.firstName || ''} ${recipient.lastName || ''}`.trim() || 'Unknown';
                },

                getAvatar(sender) {
                    return sender?.profilePicture || '/images/memofy-logo.png';
                },

                handleAvatarError(event) {
                    event.target.src = '/images/memofy-logo.png';
                },

                getPriorityBadge(priority) {
                    const pr = (priority || '').toLowerCase();
                    switch (pr) {
                        case 'urgent': return 'ðŸ”´ URGENT';
                        case 'high': return 'ðŸŸ  HIGH';
                        case 'medium': return 'ðŸŸ¡ MEDIUM';
                        case 'low': return 'ðŸ”µ LOW';
                        default: return '';
                    }
                },

                getPriorityClass(priority) {
                    const pr = (priority || '').toLowerCase();
                    return `priority-badge priority-${pr}`;
                },

                formatDate(dateString) {
                    return new Date(dateString).toLocaleDateString();
                },

                formatDateTime(dateString) {
                    return new Date(dateString).toLocaleString();
                },

                getMemoContent(memo) {
                    if (memo.htmlContent) {
                        return memo.htmlContent;
                    }

                    const safeContent = (memo.content || '')
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;');
                    return `<div style="white-space: pre-wrap; line-height: 1.6; color: #111827;">${safeContent}</div>`;
                },

                async openMemo(memo) {
                    if (!memo) return;

                    try {
                        const response = await fetch(`/api/log/memos/${memo._id}`);
                        const data = await response.json();

                        if (data && data.success && data.memo) {
                            this.currentMemo = data.memo;
                        } else {
                            this.currentMemo = memo;
                        }
                    } catch (error) {
                        console.error('Error fetching memo details:', error);
                        this.currentMemo = memo;
                    }

                    this.currentMemoIndex = this.filteredMemos.findIndex(m => m._id === memo._id);
                    this.viewerVisible = true;
                    this.$nextTick(() => this.refreshLucideIcons());
                },

                closeViewer() {
                    this.currentMemo = null;
                    this.currentMemoIndex = -1;
                    this.viewerVisible = false;
                },

                prevMemo() {
                    if (this.currentMemoIndex > 0) {
                        this.currentMemoIndex--;
                        this.currentMemo = this.filteredMemos[this.currentMemoIndex];
                        this.$nextTick(() => this.refreshLucideIcons());
                    }
                },

                nextMemo() {
                    if (this.currentMemoIndex < this.filteredMemos.length - 1) {
                        this.currentMemoIndex++;
                        this.currentMemo = this.filteredMemos[this.currentMemoIndex];
                        this.$nextTick(() => this.refreshLucideIcons());
                    }
                },

                async unarchiveCurrentMemo() {
                    if (!this.currentMemo) return;

                    try {
                        const response = await fetch(`/api/log/memos/${this.currentMemo._id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin',
                            body: JSON.stringify({ status: 'sent' })
                        });

                        const data = await response.json();
                        if (data && data.success) {
                            this.archivedMemos = this.archivedMemos.filter(m => m._id !== this.currentMemo._id);
                            this.closeViewer();

                            if (typeof showNotification === 'function') {
                                showNotification('Memo unarchived successfully', 'success');
                            }
                        }
                    } catch (error) {
                        console.error('Error unarchiving memo:', error);
                    }
                },

                toggleFavorite() {
                    console.log('Toggle favorite', this.currentMemo?._id);
                },

                downloadMemo() {
                    console.log('Download memo', this.currentMemo?._id);
                }
            },
            watch: {
                filteredMemos() {
                    this.$nextTick(() => this.refreshLucideIcons());
                }
            }
        }).mount('#app');
    </script>
</body>
</html>

