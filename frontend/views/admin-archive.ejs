<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archive | Memofy</title>
    <link rel="stylesheet" href="/css/secretary-memos.css">
    <link rel="stylesheet" href="/css/log.css">
    <link rel="stylesheet" href="/css/admintopbar.css">
    <link rel="stylesheet" href="/css/user-management.css">
    <!-- Preconnect to Google Fonts for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Google Analytics Tracking -->
    <%- include('google-analytics', { propertyId: typeof gaPropertyId !=='undefined' ? gaPropertyId : null }); %>

    <script src="/js/lucide.min.js" defer></script>
</head>

<body>
    <div class="dashboard-container">
        <%- include('../components/nav'); %>

        <main class="main-content">
            <%- include('../components/admintopbar'); %>

            <div class="dashboard-content" style="height: 630px; margin-top: 10px;">
                <div class="log-layout">

                            <!-- Archive Memo List Area -->
                    <section class="memo-list-area" style="flex:1 1 auto;">
                        <div class="memo-container" style="height: 620px">
                            <div class="memo-list-header">
                                        <div
                                            style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                            <i data-lucide="archive"
                                                style="width: 24px; height: 24px; color: #6366f1;"></i>
                                            <h2 style="margin: 0; font-size: 24px; font-weight: 600; color: #1f2937;">
                                                Archive</h2>
                                </div>
                                <div class="header-controls">
                                            <button id="refreshBtn" class="icon-btn-sm" title="Refresh">
                                                <i data-lucide="rotate-cw"></i>
                                    </button>
                                </div>
                                <div class="department-filters">
                                    <div class="priority-dropdown-wrapper">
                                                <select id="priorityFilterDropdown" class="priority-filter-dropdown">
                                            <option value="all">All Priorities</option>
                                            <option value="urgent">üî¥ Urgent</option>
                                            <option value="high">üü† High</option>
                                            <option value="medium">üü° Medium</option>
                                            <option value="low">üîµ Low</option>
                                        </select>
                                    </div>
                                    <div class="sort-dropdown-wrapper">
                                                <select id="sortDropdown" class="sort-dropdown">
                                            <option value="newest">Newest</option>
                                            <option value="oldest">Oldest</option>
                                            <option value="priority">Priority</option>
                                            <option value="subject">Subject (A-Z)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="memo-list-container">
                                        <div id="archiveList" class="memo-list"></div>
                            </div>
                        </div>
                    </section>

                            <!-- Empty State (shown when no memo is selected) -->
                            <div id="emptyState" class="empty-state-view"
                                style="display: flex; align-items: center; justify-content: center; flex: 1; min-height: 400px;">
                                <div style="text-align: center;">
                                    <i data-lucide="archive"
                                        style="width: 48px; height: 48px; color: #9ca3af; margin-bottom: 1rem;"></i>
                                    <p style="color: #6b7280; font-size: 14px;">Select a memo to view</p>
                                </div>
                            </div>
                        </div>
                    </div>
            </main>
    </div>

    <!-- Memo Viewer Modal (converted from side view) -->
    <div id="memoViewerModal" class="modal memo-viewer-modal" style="display: none;">
        <div class="modal-content memo-viewer-modal-content">
            <div id="memoViewer" class="memo-viewer" style="display: none;">
                <div class="viewer-header">
                    <button id="backBtn" class="icon-btn" title="Close">
                        <i data-lucide="x"></i>
                    </button>
                    <div class="nav-buttons">
                        <button id="prevBtn" class="icon-btn"><i data-lucide="chevron-left"></i></button>
                        <span id="memoCounter" class="memo-counter">0 of 0</span>
                        <button id="nextBtn" class="icon-btn"><i data-lucide="chevron-right"></i></button>
                    </div>
                    <div class="viewer-actions">
                        <button id="starBtn" class="icon-btn" title="Toggle Favorite"><i
                                data-lucide="bookmark"></i></button>
                        <button id="unarchiveBtn" class="icon-btn" title="Unarchive Memo"><i
                                data-lucide="archive-restore"></i></button>
                        <button id="downloadBtn" class="icon-btn" title="Download Memo"><i
                                data-lucide="download"></i></button>
                    </div>
                </div>
                <div class="memo-content">
                    <div class="memo-gmail-header">
                        <h2 id="memoDetailSubject" class="memo-subject-title"></h2>
                        <div class="memo-sender-header">
                            <img id="memoSenderAvatar" src="/images/memofy-logo.png" alt="Sender"
                                class="memo-sender-avatar-img">
                            <div class="memo-sender-info-header">
                                <div class="memo-sender-name-header" id="memoDetailFromName"></div>
                                <div class="memo-sender-email-header" id="memoDetailFromEmail"></div>
                            </div>
                        </div>
                        <div class="memo-to-dropdown-header" id="toDropdownToggle"
                            style="cursor: pointer; padding: 8px 0; color: #6b7280; font-size: 13px; position: relative;">
                            <span id="memoDetailToPreview" style="text-decoration: underline;">to me</span>
                            <i data-lucide="chevron-down" style="width: 16px; height: 16px; margin-left: 4px;"></i>
                            <div id="memoDetailsPopup" class="memo-details-popup" style="display: none;">
                                <div class="memo-details-popup-content">
                                    <div class="memo-detail-popup-row">
                                        <span class="memo-detail-popup-label">Subject:</span>
                                        <span id="memoDetailSubjectPopup" class="memo-detail-popup-value"></span>
                                    </div>
                                    <div class="memo-detail-popup-row">
                                        <span class="memo-detail-popup-label">From:</span>
                                        <span id="memoDetailFromPopup" class="memo-detail-popup-value"></span>
                                    </div>
                                    <div class="memo-detail-popup-row">
                                        <span class="memo-detail-popup-label">To:</span>
                                        <span id="memoDetailToPopup" class="memo-detail-popup-value"></span>
                                    </div>
                                    <div class="memo-detail-popup-row">
                                        <span class="memo-detail-popup-label">Department:</span>
                                        <span id="memoDetailDepartmentPopup" class="memo-detail-popup-value"></span>
                                    </div>
                                    <div class="memo-detail-popup-row">
                                        <span class="memo-detail-popup-label">Priority:</span>
                                        <span id="memoDetailPriorityPopup" class="memo-detail-popup-value"></span>
                                    </div>
                                    <div class="memo-detail-popup-row">
                                        <span class="memo-detail-popup-label">Date:</span>
                                        <span id="memoDetailDatePopup" class="memo-detail-popup-value"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="memo-body">
                        <div id="memoBodyContent"></div>
                    </div>
                    <div id="acknowledgmentStatus" class="acknowledgment-status" style="display: none;">
                        <div class="acknowledgment-header-compact">
                            <span class="acknowledgment-label">Acknowledgment Status:</span>
                            <div id="acknowledgmentAvatars" class="acknowledgment-avatars"></div>
                            <button id="reminderBtnCompact" class="reminder-btn-compact" title="Send Reminder" style="display: none;">
                                <i data-lucide="bell"></i>
                                <span>Reminder</span>
                            </button>
                        </div>
                    </div>
                    <div id="attachments" class="memo-attachments"></div>
                </div>
            </div>
        </div>
    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        window.currentUser = {
            id: '<%= user._id %>',
            email: '<%= user.email %>',
            role: '<%= user.role %>',
            department: '<%= user.department || "" %>',
            canCrossSend: <%= user.canCrossSend || false %>
        };

        window.archivedMemos = <%- JSON.stringify(archivedMemos || []) %>;
        window.archivedEvents = <%- JSON.stringify(archivedEvents || []) %>;
        window.archivedSignatures = <%- JSON.stringify(archivedSignatures || []) %>;
    </script>
    <script src="/js/log.js"></script>
    <script src="/js/log-viewer.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const archiveList = document.getElementById('archiveList');
            const refreshBtn = document.getElementById('refreshBtn');
            const priorityFilter = document.getElementById('priorityFilterDropdown');
            const sortDropdown = document.getElementById('sortDropdown');
            const unarchiveBtn = document.getElementById('unarchiveBtn');
            const backBtn = document.getElementById('backBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const starBtn = document.getElementById('starBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const memoViewerModal = document.getElementById('memoViewerModal');
            const emptyState = document.getElementById('emptyState');
            const memoViewer = document.getElementById('memoViewer');
            const memoCounter = document.getElementById('memoCounter');

            // Combine memos, calendar events, and signatures
            const allArchivedItems = [
                ...(window.archivedMemos || []).map(m => ({ ...m, type: 'memo' })),
                ...(window.archivedEvents || []).map(e => ({ ...e, type: 'event' })),
                ...(window.archivedSignatures || []).map(s => ({ ...s, type: 'signature' }))
            ];

            // Sort by newest first (most recently archived at top)
            // Use updatedAt (when archived) or createdAt as fallback
            allArchivedItems.sort((a, b) => {
                const aDate = new Date(a.updatedAt || a.createdAt || 0);
                const bDate = new Date(b.updatedAt || b.createdAt || 0);
                return bDate - aDate; // Newest first
            });

            // Expose allArchivedItems globally for search functionality
            window.allArchivedItems = allArchivedItems;

            let filteredMemos = [...allArchivedItems];
            
            // Expose filteredMemos globally for search functionality
            window.filteredMemos = filteredMemos;
            
            let currentMemoIndex = -1;
            let currentMemoId = null;

            // Render archived memos and events
            function renderArchiveList() {
                // Update global filteredMemos reference
                window.filteredMemos = filteredMemos;
                if (!archiveList) return;

                if (filteredMemos.length === 0) {
                    archiveList.innerHTML = `
                        <div class="memo-item">
                            <i data-lucide="archive" class="memo-icon"></i>
                            <div class="memo-info">
                                <h4>No archived items</h4>
                                <p>Archived memos, calendar events, and signatures will appear here</p>
                            </div>
                        </div>`;
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                    return;
                }

                archiveList.innerHTML = filteredMemos.map((item, idx) => {
                    // Handle signatures differently
                    if (item.type === 'signature') {
                        const signature = item;
                        const imageUrl = signature.imageUrl || '/images/memofy-logo.png';
                        const archivedDate = new Date(signature.updatedAt || signature.createdAt).toLocaleDateString();
                        
                        return '<div class="memo-item archived-item archived-signature" data-index="' + idx + '" data-id="' + signature._id + '" data-type="signature">' +
                            '<img src="' + imageUrl + '" alt="' + (signature.displayName || signature.roleTitle) + '" class="memo-avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">' +
                            '<div class="memo-sender-info">' +
                            '<div class="memo-sender-name">‚úçÔ∏è Signature</div>' +
                            '<div class="memo-sender-email">' + (signature.roleTitle || 'No Role') + '</div>' +
                            '</div>' +
                            '<div class="memo-item-actions"></div>' +
                            '<div class="memo-subject">' + (signature.displayName || 'Untitled Signature') + '</div>' +
                            '<div class="memo-date">' + archivedDate + '</div>' +
                            '</div>';
                    }
                    
                    // Handle calendar events differently
                    if (item.type === 'event') {
                        const event = item;
                        const dateStr = new Date(event.start).toLocaleDateString();
                        const startTime = new Date(event.start).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        const endTime = new Date(event.end).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        const category = event.category || 'standard';
                        let badge = '';
                        if (category === 'urgent') badge = '<span class="priority-badge priority-urgent" title="Urgent">üî¥ URGENT</span>';
                        else if (category === 'high') badge = '<span class="priority-badge priority-high" title="High">üü† HIGH</span>';
                        else if (category === 'meeting') badge = '<span class="priority-badge priority-high" title="Meeting">üü£ MEETING</span>';
                        else if (category === 'deadline') badge = '<span class="priority-badge priority-urgent" title="Deadline">‚è∞ DEADLINE</span>';
                        else if (category === 'reminder') badge = '<span class="priority-badge priority-medium" title="Reminder">üîî REMINDER</span>';
                        else if (category === 'low') badge = '<span class="priority-badge priority-low" title="Low">üîµ LOW</span>';
                        else badge = '<span class="priority-badge priority-medium" title="Standard">üü¢ STANDARD</span>';

                        return '<div class="memo-item archived-item archived-event" data-index="' + idx + '" data-id="' + event._id + '" data-type="event">' +
                            '<i data-lucide="calendar" class="memo-icon" style="width: 40px; height: 40px; color: #6366f1;"></i>' +
                            '<div class="memo-sender-info">' +
                            '<div class="memo-sender-name">Calendar Event</div>' +
                            '<div class="memo-sender-email">' + dateStr + ' ‚Ä¢ ' + startTime + ' - ' + endTime + '</div>' +
                            '</div>' +
                            '<div class="memo-item-actions">' + badge + '</div>' +
                            '<div class="memo-subject">' + (event.title || 'Untitled Event') + '</div>' +
                            '<div class="memo-date">' + new Date(event.updatedAt || event.createdAt).toLocaleDateString() + '</div>' +
                            '</div>';
                    }

                    // Handle memos (existing code)
                    const memo = item;
                    const recipientName = ((memo.recipient?.firstName || '') + ' ' + (memo.recipient?.lastName || '')).trim();
                    const recipientEmail = memo.recipient?.email || '';
                    const realAvatar = memo.recipient?.profilePicture;
                    const avatarSrc = realAvatar || '/images/memofy-logo.png';
                    const dateStr = new Date(memo.createdAt).toLocaleDateString();
                    const pr = (memo.priority || '').toLowerCase();
                    let badge = '';
                    if (pr === 'urgent') badge = '<span class="priority-badge priority-urgent" title="Urgent">üî¥ URGENT</span>';
                    else if (pr === 'high') badge = '<span class="priority-badge priority-high" title="High">üü† HIGH</span>';
                    else if (pr === 'medium') badge = '<span class="priority-badge priority-medium" title="Medium">üü° MEDIUM</span>';
                    else if (pr === 'low') badge = '<span class="priority-badge priority-low" title="Low">üîµ LOW</span>';

                    const hasAvatar = realAvatar ? '1' : '0';
                    return '<div class="memo-item archived-item" data-index="' + idx + '" data-id="' + memo._id + '">' +
                        '<img src="' + avatarSrc + '" alt="' + recipientName + '" class="memo-avatar" data-has-avatar="' + hasAvatar + '">' +
                        '<div class="memo-sender-info">' +
                        '<div class="memo-sender-name">To: ' + (recipientName || 'Unknown') + '</div>' +
                        '<div class="memo-sender-email">' + recipientEmail + '</div>' +
                        '</div>' +
                        '<div class="memo-item-actions">' + badge + '</div>' +
                        '<div class="memo-subject">' + (memo.subject || '') + '</div>' +
                        '<div class="memo-date">' + dateStr + '</div>' +
                        '</div>';
                }).join('');

                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                // Add click handlers
                archiveList.querySelectorAll('.archived-item').forEach(el => {
                    el.addEventListener('click', async () => {
                        const id = el.getAttribute('data-id');
                        const type = el.getAttribute('data-type');
                        const idx = Number(el.getAttribute('data-index'));
                        const item = filteredMemos[idx];

                        if (type === 'signature') {
                            // Handle signature - show signature details
                            if (item) {
                                showSignatureDetails(item);
                            }
                        } else if (type === 'event') {
                            // Handle calendar event
                            if (item) {
                                openEvent(item);
                            }
                        } else {
                            // Handle memo
                            if (id) {
                                try {
                                    const res = await fetch('/api/log/memos/' + id);
                                    const data = await res.json();
                                    if (data && data.success && data.memo) {
                                        openMemo(data.memo);
                                        return;
                                    }
                                } catch (e) { /* fallback below */ }
                            }
                            if (item) openMemo(item);
                        }
                    });
                });

                // Lazy-load avatars
                archiveList.querySelectorAll('img.memo-avatar[data-has-avatar="0"]').forEach(img => {
                    img.addEventListener('error', function () {
                        this.src = '/images/memofy-logo.png';
                    });
                });
            }

            // Open calendar event in viewer
            function openEvent(event) {
                if (!event) return;
                currentMemoId = event._id;
                currentMemoIndex = filteredMemos.findIndex(e => e._id === event._id && e.type === 'event');

                const subjectEl = document.getElementById('memoDetailSubject');
                const fromEl = document.getElementById('memoDetailFrom');
                const toEl = document.getElementById('memoDetailTo');
                const deptEl = document.getElementById('memoDetailDepartment');
                const prioEl = document.getElementById('memoDetailPriority');
                const dateEl = document.getElementById('memoDetailDate');
                const contentEl = document.getElementById('memoBodyContent');

                if (subjectEl) subjectEl.textContent = event.title || '(No title)';
                const creatorName = ((event.createdBy?.firstName || '') + ' ' + (event.createdBy?.lastName || '')).trim();
                if (fromEl) fromEl.textContent = (creatorName || 'Unknown') + ' (' + (event.createdBy?.email || '') + ')';

                // Format participants
                let participantsText = 'None';
                if (event.participants) {
                    const parts = [];
                    if (event.participants.departments && Array.isArray(event.participants.departments) && event.participants.departments.length > 0) {
                        parts.push('Departments: ' + event.participants.departments.join(', '));
                    }
                    if (event.participants.emails && Array.isArray(event.participants.emails) && event.participants.emails.length > 0) {
                        const emailList = event.participants.emails.map(e => typeof e === 'string' ? e : e.email).join(', ');
                        parts.push('Emails: ' + emailList);
                    }
                    participantsText = parts.length > 0 ? parts.join('; ') : 'None';
                }
                if (toEl) toEl.textContent = participantsText;
                if (deptEl) deptEl.textContent = 'N/A';

                const categoryLabels = {
                    urgent: 'üî¥ Urgent',
                    high: 'üü† High Priority',
                    standard: 'üü¢ Standard',
                    meeting: 'üü£ Meeting',
                    deadline: '‚è∞ Deadline',
                    reminder: 'üîî Reminder',
                    low: 'üîµ Low Priority',
                    archived: 'üì¶ Archived'
                };
                if (prioEl) prioEl.textContent = categoryLabels[event.category] || event.category || 'Standard';

                const startDate = new Date(event.start);
                const endDate = new Date(event.end);
                const dateStr = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const startTime = startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                const endTime = endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                if (dateEl) dateEl.textContent = dateStr + ' ‚Ä¢ ' + startTime + ' - ' + endTime;

                if (contentEl) {
                    const safeContent = (event.description || '(No description)').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    contentEl.innerHTML = '<div style="white-space: pre-wrap; line-height: 1.6; color: #111827;">' + safeContent + '</div>';
                }

                if (memoCounter) {
                    memoCounter.textContent = `${currentMemoIndex + 1} of ${filteredMemos.length}`;
                }

                // Open modal and show memo
                openMemoModal();
            }

            // Show signature details in viewer
            function showSignatureDetails(signature) {
                if (!signature) return;
                currentMemoId = signature._id;
                currentMemoIndex = filteredMemos.findIndex(s => s._id === signature._id && s.type === 'signature');

                const subjectEl = document.getElementById('memoDetailSubject');
                const fromEl = document.getElementById('memoDetailFrom');
                const toEl = document.getElementById('memoDetailTo');
                const deptEl = document.getElementById('memoDetailDepartment');
                const prioEl = document.getElementById('memoDetailPriority');
                const dateEl = document.getElementById('memoDetailDate');
                const contentEl = document.getElementById('memoBodyContent');

                if (subjectEl) subjectEl.textContent = signature.displayName || signature.roleTitle || 'Signature';
                if (fromEl) fromEl.textContent = 'Role: ' + (signature.roleTitle || 'N/A');
                if (toEl) toEl.textContent = 'Display Name: ' + (signature.displayName || 'N/A');
                if (deptEl) deptEl.textContent = 'N/A';
                if (prioEl) prioEl.textContent = 'Archived';
                if (dateEl) dateEl.textContent = 'Archived: ' + new Date(signature.updatedAt || signature.createdAt).toLocaleString();
                
                if (contentEl) {
                    const imageUrl = signature.imageUrl || '/images/memofy-logo.png';
                    contentEl.innerHTML = '<div style="text-align: center; padding: 20px;">' +
                        '<img src="' + imageUrl + '" alt="' + (signature.displayName || signature.roleTitle) + '" ' +
                        'style="max-width: 100%; max-height: 400px; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">' +
                        '</div>';
                }

                if (memoCounter) {
                    memoCounter.textContent = `${currentMemoIndex + 1} of ${filteredMemos.length}`;
                }

                // Open modal and show signature
                openMemoModal();
            }

            // Open memo in viewer
            function openMemo(memo) {
                if (!memo) return;
                currentMemoId = memo._id;
                currentMemoIndex = filteredMemos.findIndex(m => m._id === memo._id && m.type === 'memo');

                const subjectEl = document.getElementById('memoDetailSubject');
                const fromEl = document.getElementById('memoDetailFrom');
                const toEl = document.getElementById('memoDetailTo');
                const deptEl = document.getElementById('memoDetailDepartment');
                const prioEl = document.getElementById('memoDetailPriority');
                const dateEl = document.getElementById('memoDetailDate');
                const contentEl = document.getElementById('memoBodyContent');

                if (subjectEl) subjectEl.textContent = memo.subject || '(No subject)';
                const senderName = ((memo.sender?.firstName || '') + ' ' + (memo.sender?.lastName || '')).trim();
                if (fromEl) fromEl.textContent = (senderName || 'Unknown') + ' (' + (memo.sender?.email || '') + ')';
                const recipName = ((memo.recipient?.firstName || '') + ' ' + (memo.recipient?.lastName || '')).trim();
                if (toEl) toEl.textContent = (recipName || 'Unknown') + ' (' + (memo.recipient?.email || '') + ')';
                if (deptEl) deptEl.textContent = memo.department || 'N/A';
                if (prioEl) prioEl.textContent = memo.priority || 'medium';
                if (dateEl) dateEl.textContent = new Date(memo.createdAt).toLocaleString();
                if (contentEl) {
                    const safeContent = (memo.content || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    contentEl.innerHTML = '<div style="white-space: pre-wrap; line-height: 1.6; color: #111827;">' + safeContent + '</div>';
                }

                if (memoCounter) {
                    memoCounter.textContent = `${currentMemoIndex + 1} of ${filteredMemos.length}`;
                }

                // Open modal and show memo
                openMemoModal();
            }

            // Function to open the modal
            function openMemoModal() {
                if (memoViewerModal && memoViewer) {
                    memoViewerModal.style.display = 'block';
                    memoViewer.style.display = 'block';
                    document.body.style.overflow = 'hidden'; // Prevent background scrolling
                    if (emptyState) emptyState.style.display = 'none';
                    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
                    }
                }
            }

            // Function to close the modal
            function closeMemoModal() {
                if (memoViewerModal && memoViewer) {
                    memoViewerModal.style.display = 'none';
                    memoViewer.style.display = 'none';
                    document.body.style.overflow = ''; // Restore scrolling
                    if (emptyState) emptyState.style.display = 'flex';
                }
            }

            // Unarchive memo, event, or signature
            async function unarchiveItem(itemId, itemType) {
                if (!itemId) return;
                try {
                    if (itemType === 'signature') {
                        // Unarchive signature
                        const response = await fetch('/api/signatures/' + itemId + '/unarchive', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin'
                        });
                        const data = await response.json();
                        if (data && data.success) {
                            // Remove from list
                            filteredMemos = filteredMemos.filter(s => !(s._id === itemId && s.type === 'signature'));
                            window.archivedSignatures = (window.archivedSignatures || []).filter(s => s._id !== itemId);
                            renderArchiveList();
                            closeMemoModal();
                            if (typeof showNotification === 'function') {
                                showNotification('Signature unarchived successfully', 'success');
                            }
                        }
                    } else if (itemType === 'event') {
                        // Unarchive calendar event (change category back to standard)
                        const response = await fetch('/api/calendar/events/' + itemId, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin',
                            body: JSON.stringify({ category: 'standard' })
                        });
                        if (response.ok) {
                            // Remove from list
                            filteredMemos = filteredMemos.filter(e => !(e._id === itemId && e.type === 'event'));
                            window.archivedEvents = (window.archivedEvents || []).filter(e => e._id !== itemId);
                            renderArchiveList();
                            closeMemoModal();
                            if (typeof showNotification === 'function') {
                                showNotification('Event unarchived successfully', 'success');
                            }
                        }
                    } else {
                        // Unarchive memo
                        const response = await fetch('/api/log/memos/' + itemId, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin',
                            body: JSON.stringify({ status: 'sent' })
                        });
                        const data = await response.json();
                        if (data && data.success) {
                            // Remove from list
                            filteredMemos = filteredMemos.filter(m => !(m._id === itemId && m.type === 'memo'));
                            window.archivedMemos = (window.archivedMemos || []).filter(m => m._id !== itemId);
                            renderArchiveList();
                            closeMemoModal();
                            if (typeof showNotification === 'function') {
                                showNotification('Memo unarchived successfully', 'success');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error unarchiving item:', error);
                }
            }

            // Event listeners
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async () => {
                    try {
                        const response = await fetch('/api/log/memos?folder=archive', { credentials: 'same-origin' });
                        const data = await response.json();
                        if (data && data.success && Array.isArray(data.memos)) {
                            filteredMemos = data.memos;
                            window.archivedMemos = data.memos;
                            renderArchiveList();
                        }
                    } catch (error) {
                        console.error('Error refreshing archive:', error);
                    }
                });
            }

            if (unarchiveBtn) {
                unarchiveBtn.addEventListener('click', () => {
                    if (currentMemoId && currentMemoIndex >= 0) {
                        const item = filteredMemos[currentMemoIndex];
                        if (item) {
                            unarchiveItem(currentMemoId, item.type || 'memo');
                        }
                    }
                });
            }

            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    closeMemoModal();
                });
            }

            // Close modal on backdrop click
            if (memoViewerModal) {
                memoViewerModal.addEventListener('click', (e) => {
                    if (e.target === memoViewerModal) {
                        closeMemoModal();
                    }
                });
            }

            // Close modal on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (memoViewerModal && memoViewerModal.style.display === 'block') {
                        closeMemoModal();
                    }
                }
            });

            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (currentMemoIndex > 0) {
                        currentMemoIndex--;
                        openMemo(filteredMemos[currentMemoIndex]);
                    }
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if (currentMemoIndex < filteredMemos.length - 1) {
                        currentMemoIndex++;
                        openMemo(filteredMemos[currentMemoIndex]);
                    }
                });
            }

            // Apply filters (including search term from topbar)
            if (priorityFilter) {
                priorityFilter.addEventListener('change', () => {
                    applyArchiveFilters();
                });
            }
            
            // Function to apply all filters including search
            function applyArchiveFilters() {
                const priority = priorityFilter ? priorityFilter.value : 'all';
                const searchTerm = (window.archiveSearchTerm || '').trim().toLowerCase();
                
                // Start with all items
                let items = [...allArchivedItems];
                
                // Apply priority filter
                if (priority !== 'all') {
                    items = items.filter(item => {
                        if (item.type === 'event') {
                            const category = (item.category || '').toLowerCase();
                            // Map event categories to priority filter
                            if (priority === 'urgent') return category === 'urgent' || category === 'deadline';
                            if (priority === 'high') return category === 'high' || category === 'meeting';
                            if (priority === 'medium') return category === 'standard' || category === 'reminder';
                            if (priority === 'low') return category === 'low';
                            return false;
                        } else {
                            return (item.priority || '').toLowerCase() === priority;
                        }
                    });
                }
                
                // Apply search filter
                if (searchTerm) {
                    items = items.filter(item => {
                        const subject = (item.subject || item.title || '').toLowerCase();
                        const content = (item.content || item.description || '').toLowerCase();
                        const department = (item.department || '').toLowerCase();
                        const priority = (item.priority || item.category || '').toLowerCase();
                        
                        if (subject.includes(searchTerm) || content.includes(searchTerm) || 
                            department.includes(searchTerm) || priority.includes(searchTerm)) {
                            return true;
                        }
                        
                        if (item.sender) {
                            const senderName = `${item.sender.firstName || ''} ${item.sender.lastName || ''}`.toLowerCase();
                            if (senderName.includes(searchTerm)) return true;
                        }
                        
                        return false;
                    });
                }
                
                filteredMemos = items;
                window.filteredMemos = filteredMemos;
                
                // Apply sorting
                if (sortDropdown) {
                    const sort = sortDropdown.value;
                    filteredMemos.sort((a, b) => {
                        if (sort === 'newest') {
                            const aDate = new Date(a.updatedAt || a.createdAt || 0);
                            const bDate = new Date(b.updatedAt || b.createdAt || 0);
                            return bDate - aDate;
                        } else if (sort === 'oldest') {
                            const aDate = new Date(a.updatedAt || a.createdAt || 0);
                            const bDate = new Date(b.updatedAt || b.createdAt || 0);
                            return aDate - bDate;
                        } else if (sort === 'priority') {
                            const priorityOrder = { urgent: 4, high: 3, medium: 2, low: 1 };
                            const aPriority = a.type === 'event' ? (a.category === 'urgent' || a.category === 'deadline' ? 'urgent' : a.category === 'high' || a.category === 'meeting' ? 'high' : a.category === 'low' ? 'low' : 'medium') : (a.priority || 'medium');
                            const bPriority = b.type === 'event' ? (b.category === 'urgent' || b.category === 'deadline' ? 'urgent' : b.category === 'high' || b.category === 'meeting' ? 'high' : b.category === 'low' ? 'low' : 'medium') : (b.priority || 'medium');
                            return (priorityOrder[bPriority] || 0) - (priorityOrder[aPriority] || 0);
                        } else if (sort === 'subject') {
                            const aTitle = a.type === 'event' ? (a.title || '') : (a.subject || '');
                            const bTitle = b.type === 'event' ? (b.title || '') : (b.subject || '');
                            return aTitle.localeCompare(bTitle);
                        }
                        return 0;
                    });
                }
                
                renderArchiveList();
            }

            if (sortDropdown) {
                sortDropdown.addEventListener('change', () => {
                    applyArchiveFilters();
                });
            }
            
            // Listen for search updates from topbar
            window.addEventListener('archiveSearchUpdate', () => {
                applyArchiveFilters();
            });

            // Expose renderArchiveList globally for search functionality
            window.renderArchiveList = renderArchiveList;
            
            // Initial render
            renderArchiveList();
        });
    </script>
</body>

</html>
