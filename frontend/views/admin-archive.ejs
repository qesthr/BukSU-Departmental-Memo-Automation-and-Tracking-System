<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archive | Memofy</title>
    <link rel="stylesheet" href="/css/secretary-memos.css">
    <link rel="stylesheet" href="/css/log.css">
    <link rel="stylesheet" href="/css/admintopbar.css">
    <link rel="stylesheet" href="/css/user-management.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Google Analytics Tracking -->
    <%- include('google-analytics', { propertyId: typeof gaPropertyId !=='undefined' ? gaPropertyId : null }); %>

    <script src="/js/lucide.min.js"></script>
</head>

<body data-current-user='<%- JSON.stringify({
        id: user._id,
        email: user.email,
        role: user.role,
        department: user.department || "",
        canCrossSend: !!user.canCrossSend
    }) %>'
    data-archived-items='<%- JSON.stringify({
        memos: archivedMemos || [],
        events: archivedEvents || [],
        signatures: archivedSignatures || []
    }) %>'>

    <!-- Vue Components -->
    <script>
        // Archive Item Component
        const ArchiveItem = {
            props: {
                item: Object,
                index: Number,
                selected: Boolean
            },
            emits: ['select'],
            computed: {
                itemType() {
                    return this.item.type;
                },
                itemIcon() {
                    const icons = {
                        memo: 'file-text',
                        event: 'calendar',
                        signature: 'pen-tool'
                    };
                    return icons[this.itemType] || 'archive';
                },
                itemIconColor() {
                    const colors = {
                        memo: '#6366f1',
                        event: '#8b5cf6',
                        signature: '#f59e0b'
                    };
                    return colors[this.itemType] || '#6b7280';
                },
                itemTitle() {
                    if (this.itemType === 'memo') {
                        return this.item.subject || '(No subject)';
                    } else if (this.itemType === 'event') {
                        return this.item.title || 'Untitled Event';
                    } else if (this.itemType === 'signature') {
                        return this.item.displayName || 'Signature';
                    }
                    return 'Unknown Item';
                },
                itemSubtitle() {
                    if (this.itemType === 'memo') {
                        const recipientName = ((this.item.recipient?.firstName || '') + ' ' + (this.item.recipient?.lastName || '')).trim();
                        return `To: ${recipientName || 'Unknown'}`;
                    } else if (this.itemType === 'event') {
                        const dateStr = new Date(this.item.start).toLocaleDateString();
                        const startTime = new Date(this.item.start).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        const endTime = new Date(this.item.end).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        return `${dateStr} ‚Ä¢ ${startTime} - ${endTime}`;
                    } else if (this.itemType === 'signature') {
                        return this.item.roleTitle || 'Signature';
                    }
                    return '';
                },
                itemDate() {
                    const date = new Date(this.item.updatedAt || this.item.createdAt);
                    return date.toLocaleDateString();
                },
                priorityBadge() {
                    if (this.itemType === 'memo') {
                        const pr = (this.item.priority || '').toLowerCase();
                        const badges = {
                            urgent: { text: 'üî¥ URGENT', class: 'priority-urgent' },
                            high: { text: 'üü† HIGH', class: 'priority-high' },
                            medium: { text: 'üü° MEDIUM', class: 'priority-medium' },
                            low: { text: 'üîµ LOW', class: 'priority-low' }
                        };
                        return badges[pr] || null;
                    } else if (this.itemType === 'event') {
                        const category = this.item.category || 'standard';
                        const badges = {
                            urgent: { text: 'üî¥ URGENT', class: 'priority-urgent' },
                            high: { text: 'üü† HIGH', class: 'priority-high' },
                            meeting: { text: 'üü£ MEETING', class: 'priority-high' },
                            deadline: { text: '‚è∞ DEADLINE', class: 'priority-urgent' },
                            reminder: { text: 'üîî REMINDER', class: 'priority-medium' },
                            low: { text: 'üîµ LOW', class: 'priority-low' },
                            standard: { text: 'üü¢ STANDARD', class: 'priority-medium' }
                        };
                        return badges[category] || badges.standard;
                    }
                    return null;
                },
                hasAvatar() {
                    return this.itemType === 'memo' && this.item.recipient?.profilePicture;
                },
                avatarSrc() {
                    return this.item.recipient?.profilePicture || '/images/memofy-logo.png';
                }
            },
            methods: {
                handleClick() {
                    this.$emit('select', this.item, this.index);
                },
                handleAvatarError(event) {
                    event.target.src = '/images/memofy-logo.png';
                }
            },
            template: `
                <div
                    :class="['memo-item', 'archived-item', 'archived-' + itemType, { selected }]"
                    @click="handleClick">

                    <!-- Avatar/Icon -->
                    <template v-if="itemType === 'memo' && hasAvatar">
                        <img
                            :src="avatarSrc"
                            :alt="itemSubtitle"
                            class="memo-avatar"
                            @error="handleAvatarError">
                    </template>
                    <template v-else>
                        <i :data-lucide="itemIcon" class="memo-icon" :style="{ color: itemIconColor, width: '40px', height: '40px' }"></i>
                    </template>

                    <!-- Content -->
                    <div class="memo-sender-info">
                        <div class="memo-sender-name">
                            <template v-if="itemType === 'memo'">üìÑ Memo</template>
                            <template v-else-if="itemType === 'event'">üìÖ Calendar Event</template>
                            <template v-else-if="itemType === 'signature'">‚úçÔ∏è Signature</template>
                        </div>
                        <div class="memo-sender-email">{{ itemSubtitle }}</div>
                    </div>

                    <!-- Priority Badge -->
                    <div class="memo-item-actions" v-if="priorityBadge">
                        <span :class="['priority-badge', priorityBadge.class]" :title="priorityBadge.text.replace(/[üî¥üü†üü°üîµüü£üîî‚è∞]/g, '')">
                            {{ priorityBadge.text }}
                        </span>
                    </div>

                    <!-- Subject/Title -->
                    <div class="memo-subject">{{ itemTitle }}</div>

                    <!-- Date -->
                    <div class="memo-date">Archived: {{ itemDate }}</div>
                </div>
            `,
            mounted() {
                lucide.createIcons();
            }
        };

        // Archive Viewer Component
        const ArchiveViewer = {
            props: {
                item: Object,
                currentIndex: Number,
                totalItems: Number
            },
            emits: ['close', 'navigate', 'unarchive'],
            computed: {
                itemType() {
                    return this.item?.type;
                },
                formattedDate() {
                    if (!this.item) return '';
                    const date = new Date(this.item.updatedAt || this.item.createdAt);
                    return date.toLocaleString();
                },
                canNavigate() {
                    return this.totalItems > 1;
                }
            },
            methods: {
                handleBack() {
                    this.$emit('close');
                },
                handlePrev() {
                    this.$emit('navigate', -1);
                },
                handleNext() {
                    this.$emit('navigate', 1);
                },
                handleUnarchive() {
                    this.$emit('unarchive', this.item);
                }
            },
            template: `
                <div class="memo-viewer">
                    <div class="viewer-header">
                        <button @click="handleBack" class="icon-btn">
                            <i data-lucide="arrow-left"></i>
                        </button>
                        <div class="nav-buttons" v-if="canNavigate">
                            <button @click="handlePrev" class="icon-btn" :disabled="currentIndex <= 0">
                                <i data-lucide="chevron-left"></i>
                            </button>
                            <span class="memo-counter">{{ currentIndex + 1 }} of {{ totalItems }}</span>
                            <button @click="handleNext" class="icon-btn" :disabled="currentIndex >= totalItems - 1">
                                <i data-lucide="chevron-right"></i>
                            </button>
                        </div>
                        <div class="viewer-actions">
                            <button @click="handleUnarchive" class="icon-btn" title="Unarchive">
                                <i data-lucide="archive-restore"></i>
                            </button>
                        </div>
                    </div>

                    <div class="memo-content">
                        <div class="memo-pdf-header">
                            <h1 class="memo-title">
                                <template v-if="itemType === 'memo'">MEMO</template>
                                <template v-else-if="itemType === 'event'">CALENDAR EVENT</template>
                                <template v-else-if="itemType === 'signature'">SIGNATURE</template>
                            </h1>
                            <div class="memo-details">
                                <!-- Memo Details -->
                                <template v-if="itemType === 'memo'">
                                    <div class="memo-detail-row"><span class="memo-detail-label">Subject:</span><span class="memo-detail-value">{{ item.subject || '(No subject)' }}</span></div>
                                    <div class="memo-detail-row"><span class="memo-detail-label">From:</span><span class="memo-detail-value">
                                        {{ (item.sender?.firstName + ' ' + (item.sender?.lastName || '')).trim() || 'Unknown' }} ({{ item.sender?.email || '' }})
                                    </span></div>
                                    <div class="memo-detail-row"><span class="memo-detail-label">To:</span><span class="memo-detail-value">
                                        {{ (item.recipient?.firstName + ' ' + (item.recipient?.lastName || '')).trim() || 'Unknown' }} ({{ item.recipient?.email || '' }})
                                    </span></div>
                                    <div class="memo-detail-row"><span class="memo-detail-label">Department:</span><span class="memo-detail-value">{{ item.department || 'N/A' }}</span></div>
                                    <div class="memo-detail-row"><span class="memo-detail-label">Priority:</span><span class="memo-detail-value">{{ item.priority || 'medium' }}</span></div>
                                </template>

                                <!-- Event Details -->
                                <template v-else-if="itemType === 'event'">
                                    <div class="memo-detail-row"><span class="memo-detail-label">Title:</span><span class="memo-detail-value">{{ item.title || '(No title)' }}</span></div>
                                    <div class="memo-detail-row"><span class="memo-detail-label">Created By:</span><span class="memo-detail-value">
                                        {{ (item.createdBy?.firstName + ' ' + (item.createdBy?.lastName || '')).trim() || 'Unknown' }} ({{ item.createdBy?.email || '' }})
                                    </span></div>
                                    <div class="memo-detail-row"><span class="memo-detail-label">Date:</span><span class="memo-detail-value">
                                        {{ new Date(item.start).toLocaleDateString() }} ‚Ä¢ {{ new Date(item.start).toLocaleTimeString() }} - {{ new Date(item.end).toLocaleTimeString() }}
                                    </span></div>
                                    <div class="memo-detail-row"><span class="memo-detail-label">Category:</span><span class="memo-detail-value">{{ item.category || 'standard' }}</span></div>
                                </template>

                                <!-- Signature Details -->
                                <template v-else-if="itemType === 'signature'">
                                    <div class="memo-detail-row"><span class="memo-detail-label">Name:</span><span class="memo-detail-value">{{ item.displayName || '(No name)' }}</span></div>
                                    <div class="memo-detail-row"><span class="memo-detail-label">Title:</span><span class="memo-detail-value">{{ item.roleTitle || 'N/A' }}</span></div>
                                    <div class="memo-detail-row"><span class="memo-detail-label">Created By:</span><span class="memo-detail-value">
                                        {{ (item.createdBy?.firstName + ' ' + (item.createdBy?.lastName || '')).trim() || 'Unknown' }} ({{ item.createdBy?.email || '' }})
                                    </span></div>
                                </template>

                                <div class="memo-detail-row"><span class="memo-detail-label">Archived:</span><span class="memo-detail-value">{{ formattedDate }}</span></div>
                            </div>
                            <div class="memo-separator"></div>
                        </div>

                        <!-- Content Area -->
                        <div class="memo-body-content">
                            <template v-if="itemType === 'memo'">
                                <div style="white-space: pre-wrap; line-height: 1.6; color: #111827;">
                                    {{ item.content || '(No content)' }}
                                </div>
                            </template>

                            <template v-else-if="itemType === 'event'">
                                <div style="white-space: pre-wrap; line-height: 1.6; color: #111827;">
                                    {{ item.description || '(No description)' }}
                                </div>
                            </template>

                            <template v-else-if="itemType === 'signature'">
                                <div style="text-align: center; padding: 2rem;">
                                    <img
                                        :src="item.imageUrl || '/images/placeholder.png'"
                                        :alt="item.displayName"
                                        style="max-width: 100%; max-height: 300px; object-fit: contain; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; background: #fff;"
                                        @error="$event.target.src='/images/placeholder.png'">
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            `,
            mounted() {
                lucide.createIcons();
            }
        };

        // Empty State Component
        const EmptyState = {
            props: ['message'],
            template: `
                <div class="empty-state-view">
                    <i data-lucide="archive"></i>
                    <p>{{ message || 'Select an item to view' }}</p>
                </div>
            `,
            mounted() {
                lucide.createIcons();
            }
        };
    </script>

    <!-- Main Vue App -->
    <script>
        const { createApp, ref, computed, watch, onMounted } = Vue;

        const app = createApp({
            components: {
                ArchiveItem,
                ArchiveViewer,
                EmptyState
            },
            setup() {
                // Reactive state
                const currentUser = ref({});
                const archivedItems = ref([]);
                const filteredItems = ref([]);
                const currentItem = ref(null);
                const currentIndex = ref(-1);
                const loading = ref(false);

                // Filters
                const archiveTypeFilter = ref('all');
                const priorityFilter = ref('all');
                const sortBy = ref('newest');

                // Initialize from data attributes
                try {
                    const userData = document.body.getAttribute('data-current-user');
                    const archiveData = document.body.getAttribute('data-archived-items');

                    if (userData) {
                        currentUser.value = JSON.parse(userData);
                    }
                    if (archiveData) {
                        const data = JSON.parse(archiveData);
                        // Combine all archived items with their types
                        archivedItems.value = [
                            ...(data.memos || []).map(m => ({ ...m, type: 'memo' })),
                            ...(data.events || []).map(e => ({ ...e, type: 'event' })),
                            ...(data.signatures || []).map(s => ({ ...s, type: 'signature' }))
                        ];

                        // Sort by newest first
                        sortItems('newest');
                        filteredItems.value = [...archivedItems.value];
                    }
                } catch (err) {
                    console.error('Error parsing archive data:', err);
                }

                // Computed properties
                const totalItems = computed(() => filteredItems.value.length);
                const showViewer = computed(() => currentItem.value !== null);

                // Filter and sort items
                watch([archiveTypeFilter, priorityFilter, sortBy], () => {
                    applyFilters();
                });

                const applyFilters = () => {
                    let result = [...archivedItems.value];

                    // Apply type filter
                    if (archiveTypeFilter.value !== 'all') {
                        result = result.filter(item => item.type === archiveTypeFilter.value);
                    }

                    // Apply priority filter
                    if (priorityFilter.value !== 'all') {
                        result = result.filter(item => {
                            if (item.type === 'memo') {
                                return (item.priority || '').toLowerCase() === priorityFilter.value;
                            } else if (item.type === 'event') {
                                const category = (item.category || '').toLowerCase();
                                const priorityMap = {
                                    urgent: ['urgent', 'deadline'],
                                    high: ['high', 'meeting'],
                                    medium: ['standard', 'reminder'],
                                    low: ['low']
                                };
                                return priorityMap[priorityFilter.value]?.includes(category) || false;
                            }
                            // Signatures don't have priority, show all when type is filtered
                            return true;
                        });
                    }

                    // Apply sorting
                    sortItems(sortBy.value, result);
                    filteredItems.value = result;
                };

                const sortItems = (sortType, items = archivedItems.value) => {
                    items.sort((a, b) => {
                        if (sortType === 'newest') {
                            const aDate = new Date(a.updatedAt || a.createdAt || 0);
                            const bDate = new Date(b.updatedAt || b.createdAt || 0);
                            return bDate - aDate;
                        }
                        if (sortType === 'oldest') {
                            const aDate = new Date(a.updatedAt || a.createdAt || 0);
                            const bDate = new Date(b.updatedAt || b.createdAt || 0);
                            return aDate - bDate;
                        }
                        if (sortType === 'priority') {
                            const priorityOrder = { urgent: 4, high: 3, medium: 2, low: 1 };
                            const getPriority = (item) => {
                                if (item.type === 'event') {
                                    const category = item.category || 'standard';
                                    if (category === 'urgent' || category === 'deadline') return 'urgent';
                                    if (category === 'high' || category === 'meeting') return 'high';
                                    if (category === 'low') return 'low';
                                    return 'medium';
                                }
                                return item.priority || 'medium';
                            };
                            const aPriority = getPriority(a);
                            const bPriority = getPriority(b);
                            return (priorityOrder[bPriority] || 0) - (priorityOrder[aPriority] || 0);
                        }
                        if (sortType === 'subject') {
                            const getTitle = (item) => {
                                if (item.type === 'memo') return item.subject || '';
                                if (item.type === 'event') return item.title || '';
                                if (item.type === 'signature') return item.displayName || '';
                                return '';
                            };
                            return getTitle(a).localeCompare(getTitle(b));
                        }
                        return 0;
                    });
                };

                // Item actions
                const selectItem = (item, index) => {
                    currentItem.value = item;
                    currentIndex.value = index;
                };

                const closeViewer = () => {
                    currentItem.value = null;
                    currentIndex.value = -1;
                };

                const navigateItem = (direction) => {
                    const newIndex = currentIndex.value + direction;
                    if (newIndex >= 0 && newIndex < filteredItems.value.length) {
                        selectItem(filteredItems.value[newIndex], newIndex);
                    }
                };

                const unarchiveItem = async (item) => {
                    if (!item) return;

                    try {
                        let endpoint = '';
                        let method = 'POST';
                        let body = {};

                        if (item.type === 'signature') {
                            endpoint = `/api/signatures/${item._id}/unarchive`;
                        } else if (item.type === 'event') {
                            endpoint = `/api/calendar/events/${item._id}`;
                            method = 'PUT';
                            body = { category: 'standard' };
                        } else {
                            endpoint = `/api/log/memos/${item._id}`;
                            method = 'PUT';
                            body = { status: 'sent' };
                        }

                        const response = await fetch(endpoint, {
                            method,
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin',
                            body: Object.keys(body).length ? JSON.stringify(body) : undefined
                        });

                        if (response.ok) {
                            // Remove item from lists
                            archivedItems.value = archivedItems.value.filter(i => i._id !== item._id);
                            applyFilters();
                            closeViewer();

                            // Show success message
                            if (typeof Swal !== 'undefined') {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Unarchived',
                                    text: `${item.type} has been unarchived successfully`,
                                    timer: 2000,
                                    showConfirmButton: false,
                                    toast: true,
                                    position: 'top-end'
                                });
                            }
                        } else {
                            throw new Error('Failed to unarchive item');
                        }
                    } catch (error) {
                        console.error('Error unarchiving item:', error);
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Failed to unarchive item. Please try again.',
                                timer: 3000,
                                showConfirmButton: false,
                                toast: true,
                                position: 'top-end'
                            });
                        }
                    }
                };

                const refreshArchive = async () => {
                    loading.value = true;
                    try {
                        // Reload the page to get fresh data
                        window.location.reload();
                    } catch (error) {
                        console.error('Error refreshing archive:', error);
                    } finally {
                        loading.value = false;
                    }
                };

                // Lifecycle
                onMounted(() => {
                    lucide.createIcons();
                });

                return {
                    // State
                    currentUser,
                    archivedItems: filteredItems,
                    currentItem,
                    currentIndex,
                    loading,
                    archiveTypeFilter,
                    priorityFilter,
                    sortBy,
                    // Computed
                    totalItems,
                    showViewer,
                    // Methods
                    selectItem,
                    closeViewer,
                    navigateItem,
                    unarchiveItem,
                    refreshArchive
                };
            }
        });

        app.mount('#app');
    </script>

    <!-- Vue App Container -->
    <div id="app" class="dashboard-container">
        <%- include('../components/nav'); %>

        <main class="main-content">
            <%- include('../components/admintopbar'); %>

            <div class="dashboard-content">
                <div class="log-layout">
                    <!-- Archive List Area -->
                    <section class="memo-list-area" style="flex:1 1 auto;">
                        <div class="memo-container">
                            <div class="memo-list-header">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                    <i data-lucide="archive" style="width: 24px; height: 24px; color: #6366f1;"></i>
                                    <h2 style="margin: 0; font-size: 24px; font-weight: 600; color: #1f2937;">Archive</h2>
                                </div>
                                <div class="header-controls">
                                    <button @click="refreshArchive" :disabled="loading" class="icon-btn-sm" title="Refresh">
                                        <i data-lucide="rotate-cw" :class="{ 'spin': loading }"></i>
                                    </button>
                                </div>
                                <div class="department-filters">
                                    <div class="priority-dropdown-wrapper">
                                        <select v-model="archiveTypeFilter" class="priority-filter-dropdown">
                                            <option value="all">All Types</option>
                                            <option value="memo">üìÑ Memos</option>
                                            <option value="event">üìÖ Calendar Events</option>
                                            <option value="signature">‚úçÔ∏è Signatures</option>
                                        </select>
                                    </div>
                                    <div class="priority-dropdown-wrapper">
                                        <select v-model="priorityFilter" class="priority-filter-dropdown">
                                            <option value="all">All Priorities</option>
                                            <option value="urgent">üî¥ Urgent</option>
                                            <option value="high">üü† High</option>
                                            <option value="medium">üü° Medium</option>
                                            <option value="low">üîµ Low</option>
                                        </select>
                                    </div>
                                    <div class="sort-dropdown-wrapper">
                                        <select v-model="sortBy" class="sort-dropdown">
                                            <option value="newest">Newest</option>
                                            <option value="oldest">Oldest</option>
                                            <option value="priority">Priority</option>
                                            <option value="subject">Subject (A-Z)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="memo-list-container">
                                <div class="memo-list">
                                    <div v-if="loading" class="loading-state">
                                        <i data-lucide="loader" class="spin"></i>
                                        <span>Loading archive...</span>
                                    </div>

                                    <div v-else-if="archivedItems.length === 0" class="empty-state">
                                        <i data-lucide="archive"></i>
                                        <p>No archived items found</p>
                                    </div>

                                    <archive-item
                                        v-else
                                        v-for="(item, index) in archivedItems"
                                        :key="`${item.type}-${item._id}`"
                                        :item="item"
                                        :index="index"
                                        :selected="currentItem && currentItem._id === item._id"
                                        @select="selectItem">
                                    </archive-item>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Viewer Area -->
                    <section class="memo-viewer-area" :style="{ display: showViewer ? 'block' : 'none', flex: showViewer ? '0 0 55%' : 'none' }">
                        <empty-state
                            v-if="!showViewer"
                            message="Select an item to view">
                        </empty-state>

                        <archive-viewer
                            v-else
                            :item="currentItem"
                            :current-index="currentIndex"
                            :total-items="totalItems"
                            @close="closeViewer"
                            @navigate="navigateItem"
                            @unarchive="unarchiveItem">
                        </archive-viewer>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Add CSS for loading spinner
        const style = document.createElement('style');
        style.textContent = `
            .spin {
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
            .loading-state {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
                padding: 2rem;
                color: #6b7280;
            }
            .empty-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 3rem 2rem;
                color: #6b7280;
                text-align: center;
            }
            .empty-state i {
                width: 48px;
                height: 48px;
                margin-bottom: 1rem;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
