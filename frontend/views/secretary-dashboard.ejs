<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secretary Dashboard | Memofy</title>
    <link rel="stylesheet" href="/css/secretary-dashboard.css">
    <link rel="stylesheet" href="/css/sec-topbar.css">
    <link rel="stylesheet" href="/css/sec-nav.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <div class="dashboard-container">
        <%- include('../components/sec-nav'); %>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <%- include('../components/sec-topbar'); %>

            <!-- Dashboard Content -->
            <div class="dashboard-content">
                <!-- Welcome Section -->
                <div class="welcome-section" style="margin-bottom: 30px;">
                    <h1 style="font-size: 28px; color: #1f2937; margin-bottom: 8px;">
                        Secretary Dashboard
                    </h1>
                    <p style="color: #6b7280; font-size: 16px;">
                        Welcome, <%= user.fullName || user.firstName %>! Manage your department memos.
                    </p>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üìù</div>
                        <div class="stat-info">
                            <h3>Drafted Memos</h3>
                            <div class="stat-value">0</div>
                            <div class="stat-change">Ready to send</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üì§</div>
                        <div class="stat-info">
                            <h3>Sent Memos</h3>
                            <div class="stat-value">0</div>
                            <div class="stat-change">This month</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-info">
                            <h3>Acknowledged</h3>
                            <div class="stat-value">0</div>
                            <div class="stat-change">Completed</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-info">
                            <h3>Pending</h3>
                            <div class="stat-value">0</div>
                            <div class="stat-change">Awaiting response</div>
                        </div>
                    </div>
                </div>

                <!-- Main Grid -->
                <div class="main-grid">
                    <!-- Recent Memos Section -->
                    <section class="recent-memos-section">
                        <h2>My Recent Memos</h2>
                        <div class="memo-list">
                            <% if (Array.isArray(memos) && memos.length > 0) { %>
                                <% memos.forEach(function(memo) { %>
                                    <div class="memo-item">
                                        <i data-lucide="file-text" class="memo-icon blue"></i>
                                        <div class="memo-info">
                                            <h4><%= memo.subject %></h4>
                                            <p>To: <%= memo.recipient && (memo.recipient.firstName || memo.recipient.email) ? (memo.recipient.firstName + ' ' + (memo.recipient.lastName || '')) : '' %></p>
                                        </div>
                                        <span class="memo-date"><%= new Date(memo.createdAt).toLocaleDateString() %></span>
                                    </div>
                                <% }); %>
                            <% } else { %>
                                <div class="memo-item">
                                    <i data-lucide="file-text" class="memo-icon blue"></i>
                                    <div class="memo-info">
                                        <h4>No memos created yet</h4>
                                        <p>Your drafted and sent memos will appear here</p>
                                    </div>
                                    <span class="memo-date">--</span>
                                </div>
                            <% } %>
                        </div>
                    </section>

                    <!-- Quick Actions -->
                    <div class="side-grid">
                        <div style="padding: 20px; background: white; border-radius: 12px;">
                            <h3 style="margin: 0 0 16px; color: #1f2937; font-size: 18px;">Quick Actions</h3>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <button class="compose-btn" style="padding: 12px 16px; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;" onclick="openDistributeModal()">
                                    <i data-lucide=\"plus\"></i> Distribute Memo
                                </button>
                                <button style="padding: 12px 16px; background: white; color: #6366f1; border: 1px solid #6366f1; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                    <i data-lucide="list"></i> View All Memos
                                </button>
                                <button style="padding: 12px 16px; background: white; color: #6366f1; border: 1px solid #6366f1; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                    <i data-lucide="user"></i> My Profile
                                </button>
                            </div>
                        </div>

                        <!-- User Info Card -->
                        <div style="padding: 20px; background: white; border-radius: 12px;">
                            <div style="text-align: center; margin-bottom: 16px;">
                                <img src="<%= user.profilePicture || '/images/default-avatar.png' %>"
                                     alt="Profile"
                                     style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #10b981; margin-bottom: 12px;">
                                <h3 style="margin: 0 0 4px; color: #1f2937;"><%= user.fullName || user.firstName %></h3>
                                <p style="margin: 0; color: #10b981; font-size: 14px; font-weight: 600;">Secretary</p>
                            </div>
                            <div style="border-top: 1px solid #e5e7eb; padding-top: 16px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: #6b7280;">Department:</span>
                                    <span style="color: #1f2937; font-weight: 600;"><%= user.department || 'N/A' %></span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #6b7280;">Email:</span>
                                    <span style="color: #1f2937; font-weight: 600;"><%= user.email %></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Distribute Memo Modal -->
    <div id="distributeModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width:720px; border-radius:12px;">
            <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0;">Distribute Memo</h2>
                <button class="close" onclick="closeDistributeModal()">&times;</button>
            </div>
            <div class="modal-body" style="display:flex; flex-direction:column; gap:12px;">
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:6px;">Subject</label>
                    <input id="dmSubject" type="text" style="width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:8px;" />
                </div>
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:6px;">Message</label>
                    <textarea id="dmMessage" rows="5" style="width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:8px;"></textarea>
                </div>
                <div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                        <label style="font-weight:600;">To:</label>
                        <button id="sendDeptBtn" type="button" class="btn-primary" style="padding:8px 12px; border:none; border-radius:8px; background:#1C89E3; color:#fff; cursor:pointer;">Send to <%= user.department || 'Department' %></button>
                    </div>
                    <input id="userSearch" type="text" placeholder="Search users in your department..." style="width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:8px;" />
                    <div style="margin-top:8px;">
                        <label><input type="checkbox" id="selectAllChk" /> Select All</label>
                    </div>
                    <div id="userList" style="max-height:220px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; padding:8px; display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:8px;"></div>
                </div>
            </div>
            <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
                <button class="btn-secondary" type="button" onclick="closeDistributeModal()" style="padding:10px 14px; border:1px solid #e5e7eb; border-radius:8px; background:#fff;">Cancel</button>
                <button class="btn-primary" type="button" onclick="submitDistributeMemo()" style="padding:10px 14px; border:none; border-radius:8px; background:#1C89E3; color:#fff;">Send Memo</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Basic logging
        console.log('Secretary Dashboard loaded');
        console.log('User:', '<%= user.fullName %>');
        console.log('Department:', '<%= user.department %>');

        // Distribute modal logic
        let deptUsers = [];
        function openDistributeModal(){
            document.getElementById('distributeModal').style.display='block';
            loadDepartmentUsers();
        }
        function closeDistributeModal(){
            document.getElementById('distributeModal').style.display='none';
        }
        async function loadDepartmentUsers(){
            try{
                const res = await fetch('/api/log/department-users');
                const data = await res.json();
                deptUsers = (data.users||[]);
                renderUserList(deptUsers);
            }catch(e){ console.error(e); }
        }
        function renderUserList(list){
            const ul = document.getElementById('userList');
            ul.innerHTML = '';
            list.forEach(u=>{
                const id = `u_${u._id}`;
                const div = document.createElement('label');
                div.style.display='flex';
                div.style.alignItems='center';
                div.style.gap='8px';
                div.innerHTML = `<input type="checkbox" class="userChk" value="${u._id}"> <span>${u.firstName||''} ${u.lastName||''}</span><span style="color:#64748b; font-size:12px;">${u.email}</span>`;
                ul.appendChild(div);
            });
        }
        document.getElementById('userSearch').addEventListener('input', (e)=>{
            const q = e.target.value.toLowerCase();
            const filtered = deptUsers.filter(u => `${u.firstName||''} ${u.lastName||''} ${u.email}`.toLowerCase().includes(q));
            renderUserList(filtered);
        });
        document.getElementById('selectAllChk').addEventListener('change', (e)=>{
            document.querySelectorAll('#userList .userChk').forEach(ch => ch.checked = e.target.checked);
        });
        document.getElementById('sendDeptBtn').addEventListener('click', ()=>{
            document.getElementById('selectAllChk').checked = true;
            document.querySelectorAll('#userList .userChk').forEach(ch => ch.checked = true);
        });
        async function submitDistributeMemo(){
            const subject = document.getElementById('dmSubject').value.trim();
            const message = document.getElementById('dmMessage').value.trim();
            const recipients = Array.from(document.querySelectorAll('#userList .userChk:checked')).map(el=>el.value);
            if(!subject || !message || recipients.length===0){
                alert('Please fill subject, message, and select at least one recipient.');
                return;
            }
            try{
                const res = await fetch('/api/log/memos/distribute', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ subject, message, recipients }) });
                const data = await res.json();
                if(data.success){
                    alert('Memo submitted successfully and is pending admin approval.');
                    closeDistributeModal();
                    location.reload();
                } else {
                    alert(data.message || 'Failed to submit memo');
                }
            }catch(e){ alert('Failed to submit memo'); }
        }
    </script>
</body>

</html>

