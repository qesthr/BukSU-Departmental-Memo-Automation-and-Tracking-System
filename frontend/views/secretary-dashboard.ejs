<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secretary Dashboard | Memofy</title>
    <link rel="stylesheet" href="/css/admin-dash.css">
    <link rel="stylesheet" href="/css/secretary-side-css.css">
    <link rel="stylesheet" href="/css/sec-topbar.css">
    <link rel="stylesheet" href="/css/sec-nav.css">
    <link rel="stylesheet" href="/css/calendar.css">
    <link rel="stylesheet" href="/css/custom-calendar.css">
    <link rel="stylesheet" href="/css/log.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Google Analytics Tracking -->
    <%- include('google-analytics', { propertyId: typeof gaPropertyId !=='undefined' ? gaPropertyId : null }); %>

    <!-- SweetAlert2 -->
    <%- include('../components/sweetalert2'); %>

    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="/js/lucide.min.js"></script>
</head>

<body data-current-user='<%- JSON.stringify({
    id: user._id,
    email: user.email,
    role: user.role,
    department: user.department || "",
    firstName: user.firstName,
    fullName: user.fullName || user.firstName,
    canCrossSend: user.canCrossSend || false
}) %>'
    data-calendar-connected="<%= (user.calendarAccessToken || user.calendarRefreshToken) ? 'true' : 'false' %>"
    data-initial-stats='<%- JSON.stringify({
        drafted: 0,
        sent: 0,
        acknowledged: 0,
        pending: 0
    }) %>'>

    <!-- Define Vue Components -->
    <script>
        // Stats Card Component
        const StatsCard = {
            props: ['stat'],
            template: `
                <div class="stat-card">
                    <div class="stat-icon">{{ stat.icon }}</div>
                    <div class="stat-info">
                        <h3>{{ stat.title }}</h3>
                        <div class="stat-value">{{ stat.value }}</div>
                        <div class="stat-change">{{ stat.change }}</div>
                    </div>
                </div>
            `
        };

        // Memo List Component
        const MemoList = {
            props: ['memos', 'loading'],
            methods: {
                formatDate(dateString) {
                    return new Date(dateString).toLocaleDateString();
                },
                getRecipientName(recipient) {
                    if (!recipient) return 'Unknown';
                    return `${recipient.firstName || ''} ${recipient.lastName || ''}`.trim() || recipient.email || 'Unknown';
                },
                getMemoIcon(status) {
                    return status === 'pending' ? 'alert-triangle' : 'file-text';
                },
                getMemoIconClass(status) {
                    return status === 'pending' ? 'memo-icon orange' : 'memo-icon blue';
                }
            },
            template: `
                <section class="recent-memos-section">
                    <h2>Recent Memos</h2>
                    <div class="memo-container">
                        <div class="memo-list">
                            <div v-if="memos.length === 0 && !loading" class="memo-item">
                                <i data-lucide="inbox" class="memo-icon"></i>
                                <div class="memo-info">
                                    <h4>No memos yet</h4>
                                    <p>Your drafted and sent memos will appear here</p>
                                </div>
                            </div>

                            <div v-for="memo in memos" :key="memo._id" class="memo-item">
                                <i :data-lucide="getMemoIcon(memo.status)" :class="getMemoIconClass(memo.status)"></i>
                                <div class="memo-info">
                                    <h4>{{ memo.subject }}</h4>
                                    <p>To: {{ getRecipientName(memo.recipient) }}</p>
                                </div>
                                <span class="memo-date">{{ formatDate(memo.createdAt) }}</span>
                            </div>
                        </div>
                    </div>
                </section>
            `
        };

        // Hero Header Component
        const HeroHeader = {
            props: ['userName'],
            template: `
                <header class="hero-header">
                    <div class="hero-overlay">
                        <div class="hero-texts">
                            <h1>Secretary Dashboard</h1>
                            <p>Welcome back, {{ userName }}!</p>
                        </div>
                    </div>
                </header>
            `
        };

        // Quick Actions Component
        const QuickActions = {
            methods: {
                composeMemo() {
                    this.$emit('compose-memo');
                },
                viewAllMemos() {
                    window.location.href = '/secretary/memos';
                },
                viewDeptMembers() {
                    this.$emit('view-dept-members');
                },
                viewProfile() {
                    this.$emit('view-profile');
                }
            },
            template: `
                <div class="backup-section" style="position: relative; z-index: 1;">
                    <h3 style="margin: 0 0 16px; color: #1f2937; font-size: 18px;">Quick Actions</h3>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button type="button" class="compose-btn" @click="composeMemo"
                            style="padding: 12px 16px; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; position: relative; z-index: 2; pointer-events: auto;">
                            <i data-lucide="plus"></i> Distribute Memo
                        </button>
                        <button type="button" @click="viewAllMemos"
                            style="padding: 12px 16px; background: white; color: #6366f1; border: 1px solid #6366f1; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; position: relative; z-index: 2; pointer-events: auto;">
                            <i data-lucide="list"></i> View All Memos
                        </button>
                        <button type="button" @click="viewDeptMembers"
                            style="padding: 12px 16px; background: white; color: #6366f1; border: 1px solid #6366f1; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; position: relative; z-index: 2; pointer-events: auto;">
                            <i data-lucide="users"></i> Department Members
                        </button>
                        <button type="button" @click="viewProfile"
                            style="padding: 12px 16px; background: white; color: #6366f1; border: 1px solid #6366f1; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; position: relative; z-index: 2; pointer-events: auto;">
                            <i data-lucide="user"></i> My Profile
                        </button>
                    </div>
                </div>
            `
        };

        // Signature Modal Component
        const SignatureModal = {
            props: ['show'],
            emits: ['close', 'signature-added'],
            data() {
                return {
                    displayName: '',
                    roleTitle: '',
                    imageFile: null,
                    fileName: 'No file chosen',
                    submitting: false
                };
            },
            watch: {
                show(newVal) {
                    if (!newVal) {
                        this.resetForm();
                    }
                }
            },
            methods: {
                handleFileChange(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.imageFile = file;
                        this.fileName = file.name;
                    } else {
                        this.imageFile = null;
                        this.fileName = 'No file chosen';
                    }
                },
                resetForm() {
                    this.displayName = '';
                    this.roleTitle = '';
                    this.imageFile = null;
                    this.fileName = 'No file chosen';
                    this.submitting = false;
                    // Reset file input
                    const fileInput = this.$refs.fileInput;
                    if (fileInput) {
                        fileInput.value = '';
                    }
                },
                closeModal() {
                    this.$emit('close');
                },
                async handleSubmit() {
                    // Validation
                    if (!this.displayName.trim() || !this.roleTitle.trim() || !this.imageFile) {
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Missing Fields',
                                text: 'Please fill all fields including signature image'
                            });
                        }
                        return;
                    }

                    this.submitting = true;

                    try {
                        const formData = new FormData();
                        formData.append('displayName', this.displayName.trim());
                        formData.append('roleTitle', this.roleTitle.trim());
                        formData.append('image', this.imageFile);

                        const res = await fetch('/api/signatures/', {
                            method: 'POST',
                            body: formData,
                            credentials: 'same-origin'
                        });

                        const data = await res.json().catch(() => ({}));

                        if (res.ok && data.success) {
                            // Reload signatures
                            if (typeof window.preloadTemplatesAndSignatures === 'function') {
                                await window.preloadTemplatesAndSignatures();
                            }

                            // Refresh template dropdown in compose modal
                            const composeModal = document.getElementById('composeModal');
                            if (composeModal) {
                                const container = composeModal.querySelector('#templateSignaturesContainer');
                                if (container) {
                                    try {
                                        const sigRes = await fetch('/api/log/memos/signatures/allowed', {
                                            credentials: 'same-origin'
                                        });
                                        const sigData = await sigRes.json().catch(() => ({ signatures: [] }));
                                        if (sigData.success && sigData.signatures) {
                                            window.allowedSignatures = sigData.signatures || [];
                                        }
                                    } catch (e) {
                                        console.warn('Failed to refresh signatures after adding:', e);
                                    }

                                    const signatures = window.allowedSignatures || [];
                                    container.innerHTML = '';
                                    if (signatures.length === 0) {
                                        container.innerHTML = '<div style="padding:8px; color:#6b7280; font-size:12px; text-align:center;">No signatures available</div>';
                                    } else {
                                        signatures.forEach(sig => {
                                            const label = document.createElement('label');
                                            label.className = 'dept-checkbox-label';
                                            label.style.cursor = 'pointer';
                                            label.innerHTML = `
                                                <input type="checkbox" class="template-checkbox" value="${sig.id || sig._id}">
                                                <span>${sig.displayName || sig.roleTitle}</span>
                                            `;
                                            container.appendChild(label);
                                        });
                                    }
                                }
                            }

                            // Close modal and reset form
                            this.resetForm();
                            this.closeModal();

                            if (typeof Swal !== 'undefined') {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success',
                                    text: 'Signature added successfully!'
                                });
                            }

                            this.$emit('signature-added');
                        } else {
                            if (typeof Swal !== 'undefined') {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: data.message || 'Failed to add signature'
                                });
                            }
                        }
                    } catch (err) {
                        console.error('Error adding signature:', err);
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Error adding signature'
                            });
                        }
                    } finally {
                        this.submitting = false;
                    }
                }
            },
            template: `
                <div v-if="show" class="modal" style="display: block;">
                    <div class="modal-content signature-modal" style="max-width:520px;">
                        <div class="modal-header">
                            <h2>Add Signature</h2>
                            <button class="close-modal" @click="closeModal" aria-label="Close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form @submit.prevent="handleSubmit">
                                <div class="signature-form-content">
                                    <div class="form-group">
                                        <label for="signatureName">Name</label>
                                        <input
                                            type="text"
                                            id="signatureName"
                                            v-model="displayName"
                                            class="signature-input"
                                            placeholder="e.g., Dr. John Doe"
                                            required>
                                    </div>
                                    <div class="form-group">
                                        <label for="signatureTitle">Title/Role</label>
                                        <input
                                            type="text"
                                            id="signatureTitle"
                                            v-model="roleTitle"
                                            class="signature-input"
                                            placeholder="e.g., University President"
                                            required>
                                    </div>
                                    <div class="form-group">
                                        <label for="signatureImage">Signature Image</label>
                                        <div class="file-upload-wrapper">
                                            <input
                                                type="file"
                                                id="signatureImage"
                                                ref="fileInput"
                                                @change="handleFileChange"
                                                accept="image/*"
                                                required
                                                class="file-input">
                                            <label for="signatureImage" class="file-label">
                                                <span class="file-icon">üìé</span>
                                                <span class="file-text">Choose File</span>
                                                <span class="file-name" :style="{ color: fileName !== 'No file chosen' ? '#1f2937' : '#6b7280', fontWeight: fileName !== 'No file chosen' ? '500' : 'normal' }">{{ fileName }}</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button
                                        type="button"
                                        class="btn btn-secondary"
                                        @click="closeModal"
                                        :disabled="submitting">
                                        Cancel
                                    </button>
                                    <button
                                        type="submit"
                                        class="btn btn-primary"
                                        :disabled="submitting">
                                        {{ submitting ? 'Adding...' : 'Add Signature' }}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `
        };
    </script>

    <!-- Main Vue App -->
    <script>
        const { createApp } = Vue;

        const app = createApp({
            data() {
                return {
                    currentUser: {},
                    calendarConnected: false,
                    dashboardData: { stats: [], memos: [] },
                    secretaryMemos: [],
                    loading: false,
                    showSignatureModal: false,
                    statsData: [
                        {
                            title: 'Drafted Memos',
                            value: '0',
                            change: 'Ready to send',
                            icon: 'üìù'
                        },
                        {
                            title: 'Sent Memos',
                            value: '0',
                            change: 'This month',
                            icon: 'üì§'
                        },
                        {
                            title: 'Acknowledged',
                            value: '0',
                            change: 'Completed',
                            icon: '‚úÖ'
                        },
                        {
                            title: 'Pending',
                            value: '0',
                            change: 'Awaiting response',
                            icon: '‚è≥'
                        }
                    ]
                }
            },
            computed: {
                userFullName() {
                    return this.currentUser.fullName || this.currentUser.firstName || 'Secretary';
                },
                canCrossSend() {
                    return this.currentUser.canCrossSend || false;
                }
            },
            methods: {
                async loadDashboardStats() {
                    try {
                        this.loading = true;
                        const res = await fetch('/api/log/dashboard/stats/secretary', {
                            credentials: 'same-origin'
                        });
                        const data = await res.json();

                        if (data && data.success && data.stats) {
                            const stats = data.stats;

                            // Update stats data
                            this.statsData[0].value = String(stats.drafted || 0);
                            this.statsData[1].value = String(stats.sent || 0);
                            this.statsData[2].value = String(stats.acknowledged || 0);
                            this.statsData[3].value = String(stats.pending || 0);
                        }
                    } catch (e) {
                        console.error('Error fetching dashboard stats:', e);
                    } finally {
                        this.loading = false;
                    }
                },

                openComposeModal() {
                    // Use existing compose modal functionality
                    if (typeof window.openComposeModal === 'function') {
                        window.openComposeModal();
                    } else {
                        const composeModal = document.getElementById('composeModal');
                        if (composeModal) {
                            composeModal.style.display = 'block';
                            lucide.createIcons();
                        }
                    }
                },

                openDepartmentMembersModal() {
                    // Use existing department members modal functionality
                    if (typeof window.openDepartmentMembersModal === 'function') {
                        window.openDepartmentMembersModal();
                    } else {
                        const modal = document.getElementById('departmentMembersModal');
                        if (modal) {
                            modal.style.display = 'block';
                            if (typeof window.loadAndDisplayDepartmentMembers === 'function') {
                                window.loadAndDisplayDepartmentMembers();
                            }
                        }
                    }
                },

                openProfileModal() {
                    // Use existing profile functionality
                    if (typeof window.openProfileModal === 'function') {
                        window.openProfileModal();
                    } else {
                        const profileSection = document.getElementById('profileSection');
                        if (profileSection) {
                            profileSection.click();
                        }
                    }
                },

                openSignatureModal() {
                    this.showSignatureModal = true;
                },

                closeSignatureModal() {
                    this.showSignatureModal = false;
                },

                onSignatureAdded() {
                    // Signature was successfully added
                    // Any additional logic can go here
                },

                loadInitialData() {
                    // Load initial stats from data attribute
                    try {
                        const statsData = JSON.parse(document.body.getAttribute('data-initial-stats') || '{}');
                        if (statsData.drafted !== undefined) {
                            this.statsData[0].value = statsData.drafted.toString();
                        }
                        if (statsData.sent !== undefined) {
                            this.statsData[1].value = statsData.sent.toString();
                        }
                        if (statsData.acknowledged !== undefined) {
                            this.statsData[2].value = statsData.acknowledged.toString();
                        }
                        if (statsData.pending !== undefined) {
                            this.statsData[3].value = statsData.pending.toString();
                        }
                    } catch (err) {
                        console.error('Error loading initial stats:', err);
                    }
                }
            },
            mounted() {
                // Initialize from data attributes
                try {
                    this.currentUser = JSON.parse(document.body.getAttribute('data-current-user') || '{}');
                    const calAttr = document.body.getAttribute('data-calendar-connected');
                    this.calendarConnected = calAttr === 'true';
                } catch (err) {
                    this.currentUser = {};
                }

                // Initialize dashboard data
                if (window.initialSecretaryData) {
                    this.dashboardData = window.initialSecretaryData;
                    this.secretaryMemos = window.initialSecretaryData.memos || [];
                }

                // Load initial data and stats
                this.loadInitialData();
                this.loadDashboardStats();

                // Initialize lucide icons
                lucide.createIcons();
            }
        });

        // Register components
        app.component('stats-card', StatsCard);
        app.component('memo-list', MemoList);
        app.component('hero-header', HeroHeader);
        app.component('quick-actions', QuickActions);
        app.component('signature-modal', SignatureModal);

        // Store app instance globally so we can mount it after DOM is ready
        window.vueApp = app;
    </script>

    <!-- Vue App Container -->
    <div id="app">
        <div class="dashboard-container">
            <%- include('../components/sec-nav'); %>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Header -->
                <%- include('../components/sec-topbar'); %>

                <div class="content-area">
                    <!-- Main Grid -->
                    <div class="main-grid">
                        <!-- Hero Header Component -->
                        <hero-header :user-name="userFullName"></hero-header>

                        <!-- Dashboard Content -->
                        <div class="dashboard-content">
                            <!-- Stats Cards -->
                            <div class="stats-grid">
                                <div class="stat-card-container">
                                    <stats-card v-for="stat in statsData" :key="stat.title" :stat="stat"></stats-card>
                                </div>
                            </div>
                        </div>

                        <!-- Memo List Component -->
                        <memo-list
                            :memos="secretaryMemos"
                            :loading="loading">
                        </memo-list>

                        <!-- Calendar and Quick Actions -->
                        <div class="side-grid">
                            <div class="calendar-section">
                                <div class="mini-cal-header" style="margin-bottom: 12px;">
                                    <h3 id="dashboardMiniCalMonth" style="margin: 0; font-size: 1rem; color: #1f2937; font-weight: 600;">Calendar</h3>
                                    <div class="mini-cal-nav">
                                        <button id="dashboardMiniPrev" class="btn-icon" aria-label="Prev" style="border: 1px solid #e2e8f0; background: #fff; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 14px;">&#8249;</button>
                                        <button id="dashboardMiniNext" class="btn-icon" aria-label="Next" style="border: 1px solid #e2e8f0; background: #fff; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 14px;">&#8250;</button>
                                    </div>
                                </div>
                                <div id="dashboardMiniCalendar" class="mini-calendar"></div>
                            </div>

                            <!-- Quick Actions Component -->
                            <quick-actions
                                @compose-memo="openComposeModal"
                                @view-dept-members="openDepartmentMembersModal"
                                @view-profile="openProfileModal">
                            </quick-actions>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Signature Modal Vue Component -->
        <signature-modal
            :show="showSignatureModal"
            @close="closeSignatureModal"
            @signature-added="onSignatureAdded">
        </signature-modal>
    </div>

    <!-- Compose Modal (Keep existing functionality) -->
    <div id="composeModal" class="modal" style="display:none;">
        <!-- ... existing compose modal content ... -->
    </div>

    <!-- Department Members Modal -->
    <div id="departmentMembersModal" class="modal" style="display: none;">
        <!-- ... existing department members modal content ... -->
    </div>

    <!-- Date Details Modal for Mini Calendar -->
    <div id="dashboardDateModal" class="custom-modal" style="display: none;">
        <div class="custom-modal-overlay"></div>
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 id="dashboardDateModalTitle">Date Details</h3>
                <button class="custom-modal-close" id="dashboardDateModalClose">&times;</button>
            </div>
            <div class="custom-modal-body">
                <div id="dashboardDateModalContent"></div>
            </div>
            <div class="custom-modal-footer">
                <button class="custom-modal-btn custom-modal-btn-secondary" id="dashboardDateModalCancel">Close</button>
                <button class="custom-modal-btn custom-modal-btn-primary" id="dashboardDateModalViewCalendar">View Full Calendar</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize lucide icons for non-Vue parts
        lucide.createIcons();

        // Keep existing JavaScript functionality for modals
        // These functions will be called by Vue components
        window.openComposeModal = function() {
            const composeModal = document.getElementById('composeModal');
            if (composeModal) {
                composeModal.style.display = 'block';
                lucide.createIcons();
            }
        };

        window.openDepartmentMembersModal = function() {
            const modal = document.getElementById('departmentMembersModal');
            if (modal) {
                modal.style.display = 'block';
                if (typeof window.loadAndDisplayDepartmentMembers === 'function') {
                    window.loadAndDisplayDepartmentMembers();
                }
            }
        };

        window.openProfileModal = function() {
            const profileSection = document.getElementById('profileSection');
            if (profileSection) {
                profileSection.click();
            }
        };

        // openSignatureModal is now exposed from Vue app's mounted hook
    </script>

    <script src="/js/log.js"></script>
    <script src="/js/dashboard-mini-calendar.js"></script>
    <script src="/js/error-handler.js"></script>

    <script>
        // Initialize secretary data from backend Joenil please ko fix
        window.initialSecretaryData = {
            stats: [],
            memos: <%- JSON.stringify(memos || []) %>
        };

        // Mount Vue app after DOM is ready (ensures #app element exists)
        if (window.vueApp) {
            const appElement = document.querySelector('#app');
            if (appElement && !appElement.__vue_app__) {
                const vueApp = window.vueApp.mount('#app');

                // Expose method to window for compatibility with existing code
                window.openSignatureModal = function() {
                    if (vueApp && vueApp.openSignatureModal) {
                        vueApp.openSignatureModal();
                    }
                };

                // Wait for Vue to render, then initialize calendar
                if (vueApp && vueApp.$nextTick) {
                    vueApp.$nextTick(() => {
                        setTimeout(() => {
                            if (window.initDashboardMiniCalendar) {
                                window.initDashboardMiniCalendar();
                            }
                        }, 200);
                    });
                } else {
                    setTimeout(() => {
                        if (window.initDashboardMiniCalendar) {
                            window.initDashboardMiniCalendar();
                        }
                    }, 300);
                }
            }
        }
    </script>
</body>
</html>
