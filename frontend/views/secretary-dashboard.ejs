<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secretary Dashboard | Memofy</title>
    <link rel="stylesheet" href="/css/admin-dash.css">
    <link rel="stylesheet" href="/css/secretary-side-css.css">
    <link rel="stylesheet" href="/css/sec-topbar.css">
    <link rel="stylesheet" href="/css/sec-nav.css">
    <link rel="stylesheet" href="/css/calendar.css">
    <link rel="stylesheet" href="/css/custom-calendar.css">
    <link rel="stylesheet" href="/css/log.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Google Analytics Tracking -->
    <%- include('google-analytics', { propertyId: typeof gaPropertyId !=='undefined' ? gaPropertyId : null }); %>

    <!-- SweetAlert2 -->
    <%- include('../components/sweetalert2'); %>

<<<<<<< HEAD
        <!-- Google APIs -->
        <script src="https://apis.google.com/js/api.js"></script>
        <script src="https://accounts.google.com/gsi/client"></script>
        <script src="/js/lucide.min.js"></script>
        <script>
            window.currentUser = {
                id: '<%= user._id %>',
                email: '<%= user.email %>',
                role: '<%= user.role %>',
                department: '<%= user.department || "" %>',
                canCrossSend: <%= user.canCrossSend || false %>
            };
            // Set calendar connection status for mini calendar
            window.calendarConnected = <%= (user.calendarAccessToken || user.calendarRefreshToken) ? 'true' : 'false' %>;
        </script>
=======
    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="/js/lucide.min.js"></script>
>>>>>>> 5209f543e09b04e324156c8c9bf3891d0fe547ed
</head>

<body data-current-user='<%- JSON.stringify({
    id: user._id,
    email: user.email,
    role: user.role,
    department: user.department || "",
    firstName: user.firstName,
    fullName: user.fullName || user.firstName,
    canCrossSend: user.canCrossSend || false
}) %>'
    data-calendar-connected="<%= (user.calendarAccessToken || user.calendarRefreshToken) ? 'true' : 'false' %>"
    data-initial-stats='<%- JSON.stringify({
        drafted: 0,
        sent: 0,
        acknowledged: 0,
        pending: 0
    }) %>'>

    <!-- Define Vue Components -->
    <script>
        // Stats Card Component
        const StatsCard = {
            props: ['stat'],
            template: `
                <div class="stat-card">
                    <div class="stat-icon">{{ stat.icon }}</div>
                    <div class="stat-info">
                        <h3>{{ stat.title }}</h3>
                        <div class="stat-value">{{ stat.value }}</div>
                        <div class="stat-change">{{ stat.change }}</div>
                    </div>
                </div>
            `
        };

        // Memo List Component
        const MemoList = {
            props: ['memos', 'loading'],
            methods: {
                formatDate(dateString) {
                    return new Date(dateString).toLocaleDateString();
                },
                getRecipientName(recipient) {
                    if (!recipient) return 'Unknown';
                    return `${recipient.firstName || ''} ${recipient.lastName || ''}`.trim() || recipient.email || 'Unknown';
                },
                getMemoIcon(status) {
                    return status === 'pending' ? 'alert-triangle' : 'file-text';
                },
                getMemoIconClass(status) {
                    return status === 'pending' ? 'memo-icon orange' : 'memo-icon blue';
                }
            },
            template: `
                <section class="recent-memos-section">
                    <h2>Recent Memos</h2>
                    <div class="memo-container">
                        <div class="memo-list">
                            <div v-if="memos.length === 0 && !loading" class="memo-item">
                                <i data-lucide="inbox" class="memo-icon"></i>
                                <div class="memo-info">
                                    <h4>No memos yet</h4>
                                    <p>Your drafted and sent memos will appear here</p>
                                </div>
                            </div>

                            <div v-for="memo in memos" :key="memo._id" class="memo-item">
                                <i :data-lucide="getMemoIcon(memo.status)" :class="getMemoIconClass(memo.status)"></i>
                                <div class="memo-info">
                                    <h4>{{ memo.subject }}</h4>
                                    <p>To: {{ getRecipientName(memo.recipient) }}</p>
                                </div>
                                <span class="memo-date">{{ formatDate(memo.createdAt) }}</span>
                            </div>
                        </div>
                    </div>
                </section>
            `
        };

        // Hero Header Component
        const HeroHeader = {
            props: ['userName'],
            template: `
                <header class="hero-header">
                    <div class="hero-overlay">
                        <div class="hero-texts">
                            <h1>Secretary Dashboard</h1>
                            <p>Welcome back, {{ userName }}!</p>
                        </div>
                    </div>
                </header>
            `
        };

        // Quick Actions Component
        const QuickActions = {
            methods: {
                composeMemo() {
                    this.$emit('compose-memo');
                },
                viewAllMemos() {
                    window.location.href = '/secretary/memos';
                },
                viewDeptMembers() {
                    this.$emit('view-dept-members');
                },
                viewProfile() {
                    this.$emit('view-profile');
                }
            },
            template: `
                <div class="backup-section" style="position: relative; z-index: 1;">
                    <h3 style="margin: 0 0 16px; color: #1f2937; font-size: 18px;">Quick Actions</h3>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button type="button" class="compose-btn" @click="composeMemo"
                            style="padding: 12px 16px; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; position: relative; z-index: 2; pointer-events: auto;">
                            <i data-lucide="plus"></i> Distribute Memo
                        </button>
                        <button type="button" @click="viewAllMemos"
                            style="padding: 12px 16px; background: white; color: #6366f1; border: 1px solid #6366f1; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; position: relative; z-index: 2; pointer-events: auto;">
                            <i data-lucide="list"></i> View All Memos
                        </button>
                        <button type="button" @click="viewDeptMembers"
                            style="padding: 12px 16px; background: white; color: #6366f1; border: 1px solid #6366f1; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; position: relative; z-index: 2; pointer-events: auto;">
                            <i data-lucide="users"></i> Department Members
                        </button>
                        <button type="button" @click="viewProfile"
                            style="padding: 12px 16px; background: white; color: #6366f1; border: 1px solid #6366f1; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; position: relative; z-index: 2; pointer-events: auto;">
                            <i data-lucide="user"></i> My Profile
                        </button>
                    </div>
                </div>
            `
        };

        // Signature Modal Component
        const SignatureModal = {
            props: ['show'],
            emits: ['close', 'signature-added'],
            data() {
                return {
                    displayName: '',
                    roleTitle: '',
                    imageFile: null,
                    fileName: 'No file chosen',
                    submitting: false
                };
            },
            watch: {
                show(newVal) {
                    if (!newVal) {
                        this.resetForm();
                    }
                }
            },
            methods: {
                handleFileChange(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.imageFile = file;
                        this.fileName = file.name;
                    } else {
                        this.imageFile = null;
                        this.fileName = 'No file chosen';
                    }
                },
                resetForm() {
                    this.displayName = '';
                    this.roleTitle = '';
                    this.imageFile = null;
                    this.fileName = 'No file chosen';
                    this.submitting = false;
                    // Reset file input
                    const fileInput = this.$refs.fileInput;
                    if (fileInput) {
                        fileInput.value = '';
                    }
                },
                closeModal() {
                    this.$emit('close');
                },
                async handleSubmit() {
                    // Validation
                    if (!this.displayName.trim() || !this.roleTitle.trim() || !this.imageFile) {
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Missing Fields',
                                text: 'Please fill all fields including signature image'
                            });
                        }
                        return;
                    }

                    this.submitting = true;

                    try {
                        const formData = new FormData();
                        formData.append('displayName', this.displayName.trim());
                        formData.append('roleTitle', this.roleTitle.trim());
                        formData.append('image', this.imageFile);

                        const res = await fetch('/api/signatures/', {
                            method: 'POST',
                            body: formData,
                            credentials: 'same-origin'
                        });

                        const data = await res.json().catch(() => ({}));

                        if (res.ok && data.success) {
                            // Reload signatures
                            if (typeof window.preloadTemplatesAndSignatures === 'function') {
                                await window.preloadTemplatesAndSignatures();
                            }

                            // Refresh template dropdown in compose modal
                            const composeModal = document.getElementById('composeModal');
                            if (composeModal) {
                                const container = composeModal.querySelector('#templateSignaturesContainer');
                                if (container) {
                                    try {
                                        const sigRes = await fetch('/api/log/memos/signatures/allowed', {
                                            credentials: 'same-origin'
                                        });
                                        const sigData = await sigRes.json().catch(() => ({ signatures: [] }));
                                        if (sigData.success && sigData.signatures) {
                                            window.allowedSignatures = sigData.signatures || [];
                                        }
                                    } catch (e) {
                                        console.warn('Failed to refresh signatures after adding:', e);
                                    }

                                    const signatures = window.allowedSignatures || [];
                                    container.innerHTML = '';
                                    if (signatures.length === 0) {
                                        container.innerHTML = '<div style="padding:8px; color:#6b7280; font-size:12px; text-align:center;">No signatures available</div>';
                                    } else {
                                        signatures.forEach(sig => {
                                            const label = document.createElement('label');
                                            label.className = 'dept-checkbox-label';
                                            label.style.cursor = 'pointer';
                                            label.innerHTML = `
                                                <input type="checkbox" class="template-checkbox" value="${sig.id || sig._id}">
                                                <span>${sig.displayName || sig.roleTitle}</span>
                                            `;
                                            container.appendChild(label);
                                        });
                                    }
                                }
                            }

                            // Close modal and reset form
                            this.resetForm();
                            this.closeModal();

                            if (typeof Swal !== 'undefined') {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success',
                                    text: 'Signature added successfully!'
                                });
                            }

                            this.$emit('signature-added');
                        } else {
                            if (typeof Swal !== 'undefined') {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: data.message || 'Failed to add signature'
                                });
                            }
                        }
                    } catch (err) {
                        console.error('Error adding signature:', err);
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Error adding signature'
                            });
                        }
                    } finally {
                        this.submitting = false;
                    }
                }
            },
            template: `
                <div v-if="show" class="modal" style="display: block;">
                    <div class="modal-content signature-modal" style="max-width:520px;">
                        <div class="modal-header">
                            <h2>Add Signature</h2>
                            <button class="close-modal" @click="closeModal" aria-label="Close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form @submit.prevent="handleSubmit">
                                <div class="signature-form-content">
                                    <div class="form-group">
                                        <label for="signatureName">Name</label>
                                        <input
                                            type="text"
                                            id="signatureName"
                                            v-model="displayName"
                                            class="signature-input"
                                            placeholder="e.g., Dr. John Doe"
                                            required>
                                    </div>
                                    <div class="form-group">
                                        <label for="signatureTitle">Title/Role</label>
                                        <input
                                            type="text"
                                            id="signatureTitle"
                                            v-model="roleTitle"
                                            class="signature-input"
                                            placeholder="e.g., University President"
                                            required>
                                    </div>
                                    <div class="form-group">
                                        <label for="signatureImage">Signature Image</label>
                                        <div class="file-upload-wrapper">
                                            <input
                                                type="file"
                                                id="signatureImage"
                                                ref="fileInput"
                                                @change="handleFileChange"
                                                accept="image/*"
                                                required
                                                class="file-input">
                                            <label for="signatureImage" class="file-label">
                                                <span class="file-icon">üìé</span>
                                                <span class="file-text">Choose File</span>
                                                <span class="file-name" :style="{ color: fileName !== 'No file chosen' ? '#1f2937' : '#6b7280', fontWeight: fileName !== 'No file chosen' ? '500' : 'normal' }">{{ fileName }}</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button
                                        type="button"
                                        class="btn btn-secondary"
                                        @click="closeModal"
                                        :disabled="submitting">
                                        Cancel
                                    </button>
                                    <button
                                        type="submit"
                                        class="btn btn-primary"
                                        :disabled="submitting">
                                        {{ submitting ? 'Adding...' : 'Add Signature' }}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `
        };
    </script>

    <!-- Main Vue App -->
    <script>
        const { createApp } = Vue;

        const app = createApp({
            data() {
                return {
                    currentUser: {},
                    calendarConnected: false,
                    dashboardData: { stats: [], memos: [] },
                    secretaryMemos: [],
                    loading: false,
                    showSignatureModal: false,
                    statsData: [
                        {
                            title: 'Drafted Memos',
                            value: '0',
                            change: 'Ready to send',
                            icon: 'üìù'
                        },
                        {
                            title: 'Sent Memos',
                            value: '0',
                            change: 'This month',
                            icon: 'üì§'
                        },
                        {
                            title: 'Acknowledged',
                            value: '0',
                            change: 'Completed',
                            icon: '‚úÖ'
                        },
                        {
                            title: 'Pending',
                            value: '0',
                            change: 'Awaiting response',
                            icon: '‚è≥'
                        }
                    ]
                }
            },
            computed: {
                userFullName() {
                    return this.currentUser.fullName || this.currentUser.firstName || 'Secretary';
                },
                canCrossSend() {
                    return this.currentUser.canCrossSend || false;
                }
            },
            methods: {
                async loadDashboardStats() {
                    try {
                        this.loading = true;
                        const res = await fetch('/api/log/dashboard/stats/secretary', {
                            credentials: 'same-origin'
                        });
                        const data = await res.json();

                        if (data && data.success && data.stats) {
                            const stats = data.stats;

                            // Update stats data
                            this.statsData[0].value = String(stats.drafted || 0);
                            this.statsData[1].value = String(stats.sent || 0);
                            this.statsData[2].value = String(stats.acknowledged || 0);
                            this.statsData[3].value = String(stats.pending || 0);
                        }
                    } catch (e) {
                        console.error('Error fetching dashboard stats:', e);
                    } finally {
                        this.loading = false;
                    }
                },

                openComposeModal() {
                    // Use existing compose modal functionality
                    if (typeof window.openComposeModal === 'function') {
                        window.openComposeModal();
                    } else {
                        const composeModal = document.getElementById('composeModal');
                        if (composeModal) {
                            composeModal.style.display = 'block';
                            lucide.createIcons();
                        }
                    }
                },

                openDepartmentMembersModal() {
                    // Use existing department members modal functionality
                    if (typeof window.openDepartmentMembersModal === 'function') {
                        window.openDepartmentMembersModal();
                    } else {
                        const modal = document.getElementById('departmentMembersModal');
                        if (modal) {
                            modal.style.display = 'block';
                            if (typeof window.loadAndDisplayDepartmentMembers === 'function') {
                                window.loadAndDisplayDepartmentMembers();
                            }
                        }
                    }
                },

                openProfileModal() {
                    // Use existing profile functionality
                    if (typeof window.openProfileModal === 'function') {
                        window.openProfileModal();
                    } else {
                        const profileSection = document.getElementById('profileSection');
                        if (profileSection) {
                            profileSection.click();
                        }
                    }
                },

                openSignatureModal() {
                    this.showSignatureModal = true;
                },

                closeSignatureModal() {
                    this.showSignatureModal = false;
                },

                onSignatureAdded() {
                    // Signature was successfully added
                    // Any additional logic can go here
                },

                loadInitialData() {
                    // Load initial stats from data attribute
                    try {
                        const statsData = JSON.parse(document.body.getAttribute('data-initial-stats') || '{}');
                        if (statsData.drafted !== undefined) {
                            this.statsData[0].value = statsData.drafted.toString();
                        }
                        if (statsData.sent !== undefined) {
                            this.statsData[1].value = statsData.sent.toString();
                        }
                        if (statsData.acknowledged !== undefined) {
                            this.statsData[2].value = statsData.acknowledged.toString();
                        }
                        if (statsData.pending !== undefined) {
                            this.statsData[3].value = statsData.pending.toString();
                        }
                    } catch (err) {
                        console.error('Error loading initial stats:', err);
                    }
                }
            },
            mounted() {
                // Initialize from data attributes
                try {
                    this.currentUser = JSON.parse(document.body.getAttribute('data-current-user') || '{}');
                    const calAttr = document.body.getAttribute('data-calendar-connected');
                    this.calendarConnected = calAttr === 'true';
                } catch (err) {
                    this.currentUser = {};
                }

                // Initialize dashboard data
                if (window.initialSecretaryData) {
                    this.dashboardData = window.initialSecretaryData;
                    this.secretaryMemos = window.initialSecretaryData.memos || [];
                }

                // Load initial data and stats
                this.loadInitialData();
                this.loadDashboardStats();

                // Initialize lucide icons
                lucide.createIcons();
            }
        });

        // Register components
        app.component('stats-card', StatsCard);
        app.component('memo-list', MemoList);
        app.component('hero-header', HeroHeader);
        app.component('quick-actions', QuickActions);
        app.component('signature-modal', SignatureModal);

        const vueApp = app.mount('#app');

        // Expose method to window for compatibility with existing code
        window.openSignatureModal = function() {
            if (vueApp && vueApp.openSignatureModal) {
                vueApp.openSignatureModal();
            }
        };
    </script>

    <!-- Vue App Container -->
    <div id="app">
        <div class="dashboard-container">
            <%- include('../components/sec-nav'); %>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Header -->
                <%- include('../components/sec-topbar'); %>

                <div class="content-area">
                    <!-- Main Grid -->
                    <div class="main-grid">
                        <!-- Hero Header Component -->
                        <hero-header :user-name="userFullName"></hero-header>

                        <!-- Dashboard Content -->
                        <div class="dashboard-content">
                            <!-- Stats Cards -->
                            <div class="stats-grid">
                                <div class="stat-card-container">
                                    <stats-card v-for="stat in statsData" :key="stat.title" :stat="stat"></stats-card>
                                </div>
                            </div>
                        </div>

                        <!-- Memo List Component -->
                        <memo-list
                            :memos="secretaryMemos"
                            :loading="loading">
                        </memo-list>

                        <!-- Calendar and Quick Actions -->
                        <div class="side-grid">
                            <div class="calendar-section">
                                <div class="mini-cal-header" style="margin-bottom: 12px;">
                                    <h3 id="dashboardMiniCalMonth" style="margin: 0; font-size: 1rem; color: #1f2937; font-weight: 600;">Calendar</h3>
                                    <div class="mini-cal-nav">
                                        <button id="dashboardMiniPrev" class="btn-icon" aria-label="Prev" style="border: 1px solid #e2e8f0; background: #fff; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 14px;">&#8249;</button>
                                        <button id="dashboardMiniNext" class="btn-icon" aria-label="Next" style="border: 1px solid #e2e8f0; background: #fff; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 14px;">&#8250;</button>
                                    </div>
                                </div>
                                <div id="dashboardMiniCalendar" class="mini-calendar"></div>
                            </div>

                            <!-- Quick Actions Component -->
                            <quick-actions
                                @compose-memo="openComposeModal"
                                @view-dept-members="openDepartmentMembersModal"
                                @view-profile="openProfileModal">
                            </quick-actions>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Signature Modal Vue Component -->
        <signature-modal
            :show="showSignatureModal"
            @close="closeSignatureModal"
            @signature-added="onSignatureAdded">
        </signature-modal>
    </div>

    <!-- Compose Modal (Keep existing functionality) -->
    <div id="composeModal" class="modal" style="display:none;">
        <!-- ... existing compose modal content ... -->
    </div>

<<<<<<< HEAD
    <!-- Add Signature Modal -->
    <div id="addSignatureModal" class="modal" style="display:none;">
        <div class="modal-content signature-modal" style="max-width:520px;">
            <div class="modal-header">
                <h2>Add Signature</h2>
                <button class="close-modal" data-modal="addSignatureModal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addSignatureForm">
                    <div class="signature-form-content">
                        <div class="form-group">
                            <label for="signatureName">Name</label>
                            <input type="text" id="signatureName" name="displayName" class="signature-input"
                                placeholder="e.g., Dr. John Doe" required>
                </div>
                        <div class="form-group">
                            <label for="signatureTitle">Title/Role</label>
                            <input type="text" id="signatureTitle" name="roleTitle" class="signature-input"
                                placeholder="e.g., University President" required>
                </div>
                        <div class="form-group">
                            <label for="signatureImage">Signature Image</label>
                            <div class="file-upload-wrapper">
                                <input type="file" id="signatureImage" name="image" accept="image/*" required
                                    class="file-input">
                                <label for="signatureImage" class="file-label">
                                    <span class="file-icon">üìé</span>
                                    <span class="file-text">Choose File</span>
                                    <span class="file-name" id="fileName">No file chosen</span>
                                </label>
                    </div>
                </div>
            </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary close-modal" data-modal="addSignatureModal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Signature</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Basic logging
        console.log('Secretary Dashboard loaded');
        console.log('User:', '<%= user.fullName %>');
        console.log('Department:', '<%= user.department %>');

        // Ensure Quick Actions buttons are clickable
        document.addEventListener('DOMContentLoaded', () => {
            // Quick Actions button event listeners
            const quickActionCompose = document.getElementById('quickActionCompose');
            if (quickActionCompose) {
                quickActionCompose.addEventListener('click', () => {
                    openComposeModal();
                });
            }

            const quickActionViewMemos = document.getElementById('quickActionViewMemos');
            if (quickActionViewMemos) {
                quickActionViewMemos.addEventListener('click', () => {
                    window.location.href = '/secretary/memos';
                });
            }

            const quickActionDeptMembers = document.getElementById('quickActionDeptMembers');
            if (quickActionDeptMembers) {
                quickActionDeptMembers.addEventListener('click', () => {
                    openDepartmentMembersModal();
                });
            }

            const quickActionProfile = document.getElementById('quickActionProfile');
            if (quickActionProfile) {
                quickActionProfile.addEventListener('click', () => {
                    openProfileModal();
                });
            }

            // Close department members modal button
            const closeDeptMembersModalBtn = document.getElementById('closeDeptMembersModalBtn');
            if (closeDeptMembersModalBtn) {
                closeDeptMembersModalBtn.addEventListener('click', () => {
                    closeDepartmentMembersModal();
                });
            }
        });

        // Function to open compose modal
        function openComposeModal() {
            const composeModal = document.getElementById('composeModal');
            if (composeModal) {
                composeModal.style.display = 'block';
                // Reinitialize Lucide icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
        }

        // Distribute modal logic (kept for backward compatibility if needed)
        let deptUsers = [];
        function openDistributeModal() {
            openComposeModal(); // Redirect to compose modal
        }
        function closeDistributeModal() {
            const composeModal = document.getElementById('composeModal');
            if (composeModal) {
                composeModal.style.display = 'none';
            }
        }
        async function loadDepartmentUsers() {
            try {
                const res = await fetch('/api/log/department-users');
                const data = await res.json();
                deptUsers = (data.users || []);
                renderUserList(deptUsers);
            } catch (e) { console.error(e); }
        }
        function renderUserList(list) {
            const ul = document.getElementById('userList');
            if (!ul) return; // Element doesn't exist on dashboard
            ul.innerHTML = '';
            list.forEach(u => {
                const id = `u_${u._id}`;
                const div = document.createElement('label');
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.gap = '8px';
                div.innerHTML = `<input type="checkbox" class="userChk" value="${u._id}"> <span>${u.firstName || ''} ${u.lastName || ''}</span><span style="color:#64748b; font-size:12px;">${u.email}</span>`;
                ul.appendChild(div);
            });
        }

        // Only add event listeners if elements exist (these are from old distribute modal)
        const userSearch = document.getElementById('userSearch');
        if (userSearch) {
            userSearch.addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            const filtered = deptUsers.filter(u => `${u.firstName || ''} ${u.lastName || ''} ${u.email}`.toLowerCase().includes(q));
            renderUserList(filtered);
        });
        }

        const selectAllChk = document.getElementById('selectAllChk');
        if (selectAllChk) {
            selectAllChk.addEventListener('change', (e) => {
            document.querySelectorAll('#userList .userChk').forEach(ch => ch.checked = e.target.checked);
        });
        }

        const sendDeptBtn = document.getElementById('sendDeptBtn');
        if (sendDeptBtn) {
            sendDeptBtn.addEventListener('click', () => {
                const selectAll = document.getElementById('selectAllChk');
                if (selectAll) {
                    selectAll.checked = true;
                }
            document.querySelectorAll('#userList .userChk').forEach(ch => ch.checked = true);
        });
        }
        async function submitDistributeMemo() {
            const subject = document.getElementById('dmSubject').value.trim();
            const message = document.getElementById('dmMessage').value.trim();
            const recipients = Array.from(document.querySelectorAll('#userList .userChk:checked')).map(el => el.value);
            if (!subject || !message || recipients.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Missing Fields',
                    text: 'Please fill subject, message, and select at least one recipient.'
                });
                return;
            }
            try {
                const res = await fetch('/api/log/memos/distribute', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ subject, message, recipients }) });
                const data = await res.json();
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: 'Memo submitted successfully and is pending admin approval.'
                    });
                    closeDistributeModal();
                    location.reload();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'Failed to submit memo'
                    });
                }
            } catch (e) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to submit memo'
                });
            }
        }

        // Function to open profile modal
        function openProfileModal() {
            const profileSection = document.getElementById('profileSection');
            if (profileSection) {
                profileSection.click();
            } else {
                console.warn('Profile section not found');
            }
        }

        // Department Members functionality
        let departmentMembers = [];

        async function loadDepartmentMembers() {
            try {
                console.log('Loading department members...');
                const res = await fetch('/api/log/department-users', {
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!res.ok) {
                    console.error('Failed to fetch department members:', res.status, res.statusText);
                    return [];
                }

                const data = await res.json();
                console.log('Department members response:', data);

                if (data.success) {
                    departmentMembers = data.users || [];
                    console.log('Loaded department members:', departmentMembers.length, departmentMembers);
                    return departmentMembers;
                } else {
                    console.error('API returned error:', data.message);
                    return [];
                }
            } catch (e) {
                console.error('Error loading department members:', e);
                return [];
            }
        }

        function openDepartmentMembersModal() {
            const modal = document.getElementById('departmentMembersModal');
            if (modal) {
                modal.style.display = 'block';
                loadAndDisplayDepartmentMembers();
            }
        }

        function closeDepartmentMembersModal() {
            const modal = document.getElementById('departmentMembersModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function loadAndDisplayDepartmentMembers() {
            const content = document.getElementById('departmentMembersContent');
            if (!content) return;

            content.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;"><i data-lucide="loader" style="width: 24px; height: 24px; animation: spin 1s linear infinite;"></i><p style="margin-top: 12px;">Loading department faculty...</p></div>';
            lucide.createIcons();

            const members = await loadDepartmentMembers();

            if (members.length === 0) {
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;"><i data-lucide="users"></i><p style="margin-top: 12px;">No department faculty found</p></div>';
                lucide.createIcons();
                return;
            }

            const html = members.map(member => {
                const fullName = `${member.firstName || ''} ${member.lastName || ''}`.trim() || member.email;
                const initial = (member.firstName || member.email || 'U')[0].toUpperCase();
                const profilePicture = member.profilePicture || '';
                const hasAvatar = profilePicture && profilePicture.trim() !== '';
                return `
                    <div class="dept-member-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid #f3f4f6; transition: background 0.2s;">
                        ${hasAvatar ?
                            `<img src="${profilePicture}" alt="${fullName}" class="dept-member-avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid #e5e7eb;">
                            <div class="dept-member-avatar-fallback" style="width: 40px; height: 40px; border-radius: 50%; background: #6366f1; display: none; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; flex-shrink: 0;">${initial}</div>` :
                            `<div style="width: 40px; height: 40px; border-radius: 50%; background: #6366f1; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; flex-shrink: 0;">${initial}</div>`
                        }
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1f2937; font-size: 14px;">${fullName}</div>
                            <div style="color: #6b7280; font-size: 12px; margin-top: 2px;">${member.email}</div>
                            <div style="color: #9ca3af; font-size: 11px; margin-top: 4px; text-transform: capitalize;">${member.role || 'Member'}</div>
                        </div>
                    </div>
                `;
            }).join('');

            content.innerHTML = html;
            lucide.createIcons();

            // Handle avatar image errors (fallback to initial)
            content.querySelectorAll('.dept-member-avatar').forEach(img => {
                img.addEventListener('error', function() {
                    this.style.display = 'none';
                    const fallback = this.nextElementSibling;
                    if (fallback && fallback.classList.contains('dept-member-avatar-fallback')) {
                        fallback.style.display = 'flex';
                    }
                });
            });

            // Add hover effects to department member items
            const memberItems = content.querySelectorAll('.dept-member-item');
            memberItems.forEach(item => {
                item.addEventListener('mouseenter', () => {
                    item.style.background = '#f9fafb';
                });
                item.addEventListener('mouseleave', () => {
                    item.style.background = 'white';
                });
            });
        }

        // Compose Modal Department Members Dropdown
        document.addEventListener('DOMContentLoaded', () => {
            const selectDeptMembersBtn = document.getElementById('selectDeptMembersBtn');
            const deptMembersDropdown = document.getElementById('deptMembersDropdown');
            const closeDeptMembersDropdown = document.getElementById('closeDeptMembersDropdown');
            const deptMembersList = document.getElementById('deptMembersList');
            const recipientsInput = document.getElementById('recipients');
            const recipientChipsContainer = document.getElementById('recipient-chips');

            if (selectDeptMembersBtn && deptMembersDropdown) {
                selectDeptMembersBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    console.log('Select Faculty button clicked');
                    if (deptMembersDropdown.style.display === 'none' || !deptMembersDropdown.style.display) {
                        // Position dropdown below button, centered horizontally
                        deptMembersDropdown.style.position = 'absolute';
                        deptMembersDropdown.style.top = 'calc(100% + 4px)';
                        deptMembersDropdown.style.left = '50%';
                        deptMembersDropdown.style.transform = 'translateX(-50%)';
                        deptMembersDropdown.style.right = 'auto';
                        deptMembersDropdown.style.bottom = 'auto';
                        deptMembersDropdown.style.display = 'block';
                        await loadDeptMembersForDropdown();
                        // Re-initialize Lucide icons after content is loaded
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    } else {
                        deptMembersDropdown.style.display = 'none';
                    }
                });
            } else {
                console.error('Select Faculty button or dropdown element not found:', {
                    selectDeptMembersBtn: !!selectDeptMembersBtn,
                    deptMembersDropdown: !!deptMembersDropdown
                });
            }

            if (closeDeptMembersDropdown) {
                closeDeptMembersDropdown.addEventListener('click', () => {
                    if (deptMembersDropdown) {
                        deptMembersDropdown.style.display = 'none';
                    }
                });
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (deptMembersDropdown && selectDeptMembersBtn) {
                    const wrapper = selectDeptMembersBtn.parentElement;
                    if (!deptMembersDropdown.contains(e.target) &&
                        e.target !== selectDeptMembersBtn &&
                        !selectDeptMembersBtn.contains(e.target) &&
                        (!wrapper || !wrapper.contains(e.target))) {
                        deptMembersDropdown.style.display = 'none';
                    }
                }
            });

            async function loadDeptMembersForDropdown() {
                if (!deptMembersList) {
                    console.error('deptMembersList element not found');
                    return;
                }

                console.log('Loading department members for dropdown...');
                deptMembersList.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af;"><i data-lucide="loader" style="width: 24px; height: 24px; animation: spin 1s linear infinite;"></i><p style="margin-top: 8px;">Loading faculty members...</p></div>';

                const members = await loadDepartmentMembers();
                console.log('Members loaded for dropdown:', members.length, members);

                // Update the global departmentMembers variable
                departmentMembers = members;

                if (members.length === 0) {
                    deptMembersList.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af;">No department faculty found</div>';
                    return;
                }

                const html = `
                    <div style="padding: 6px 8px; border-bottom: 1px solid #e5e7eb;">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 2px;">
                            <input type="checkbox" id="selectAllDeptMembers" style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="font-weight: 600; font-size: 12px;">Select All</span>
                        </label>
                    </div>
                    ${members.map(member => {
                        const fullName = `${member.firstName || ''} ${member.lastName || ''}`.trim() || member.email;
                        const initial = (member.firstName || member.email || 'U')[0].toUpperCase();
                        const role = member.role || 'Faculty';
                        const profilePicture = member.profilePicture || '';
                        const hasAvatar = profilePicture && profilePicture.trim() !== '';
                        return `
                            <div class="dept-member-dropdown-item" style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; cursor: pointer; transition: background 0.2s; border-radius: 4px; border-bottom: 1px solid #f3f4f6;"
                                   data-email="${member.email}"
                                   data-user-id="${member._id}"
                                   title="Click to add ${fullName} to recipients">
                                <input type="checkbox" class="dept-member-checkbox" value="${member.email}" data-user-id="${member._id}" style="cursor: pointer; width: 16px; height: 16px; flex-shrink: 0;">
                                ${hasAvatar ?
                                    `<img src="${profilePicture}" alt="${fullName}" class="dept-member-avatar" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid #e5e7eb;">
                                    <div class="dept-member-avatar-fallback" style="width: 32px; height: 32px; border-radius: 50%; background: #6366f1; display: none; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; flex-shrink: 0;">${initial}</div>` :
                                    `<div style="width: 32px; height: 32px; border-radius: 50%; background: #6366f1; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; flex-shrink: 0;">${initial}</div>`
                                }
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 600; color: #1f2937; font-size: 13px; margin-bottom: 1px;">${fullName}</div>
                                    <div style="color: #6b7280; font-size: 11px; margin-bottom: 1px;">${member.email}</div>
                                    <div style="color: #9ca3af; font-size: 10px; text-transform: capitalize;">${role}</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;

                deptMembersList.innerHTML = html;

                // Handle avatar image errors (fallback to initial)
                deptMembersList.querySelectorAll('.dept-member-avatar').forEach(img => {
                    img.addEventListener('error', function() {
                        this.style.display = 'none';
                        const fallback = this.nextElementSibling;
                        if (fallback && fallback.classList.contains('dept-member-avatar-fallback')) {
                            fallback.style.display = 'flex';
                        }
                    });
                });

                // Add hover effects and click handlers to dropdown items
                const dropdownItems = deptMembersList.querySelectorAll('.dept-member-dropdown-item');
                dropdownItems.forEach(item => {
                    // Hover effects
                    item.addEventListener('mouseenter', () => {
                        item.style.background = '#f9fafb';
                    });
                    item.addEventListener('mouseleave', () => {
                        item.style.background = 'white';
                    });

                    // Make entire item clickable to toggle selection
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // Don't toggle if clicking directly on checkbox (it handles its own click)
                        if (e.target.type === 'checkbox' || e.target.closest('input[type="checkbox"]')) {
                            return;
                        }

                        const checkbox = item.querySelector('.dept-member-checkbox');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            // Trigger change event to add/remove recipient
                            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                            // Visual feedback
                            item.style.background = '#f0f9ff';
                            setTimeout(() => {
                                item.style.background = item.matches(':hover') ? '#f9fafb' : 'white';
                            }, 200);
                        }
                    });
                });

                // Sync checkboxes with already selected recipients
                if (window.recipientData && window.recipientData.length > 0) {
                    document.querySelectorAll('.dept-member-checkbox').forEach(cb => {
                        const email = cb.value.toLowerCase();
                        const isSelected = window.recipientData.some(r => r.email.toLowerCase() === email);
                        cb.checked = isSelected;
                    });

                    // Update select all checkbox
                    const selectAll = document.getElementById('selectAllDeptMembers');
                    if (selectAll) {
                        const allCheckboxes = document.querySelectorAll('.dept-member-checkbox');
                        const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                        selectAll.checked = allChecked && allCheckboxes.length > 0;
                    }
                }

                // Handle select all
                const selectAll = document.getElementById('selectAllDeptMembers');
                if (selectAll) {
                    selectAll.addEventListener('change', (e) => {
                        document.querySelectorAll('.dept-member-checkbox').forEach(cb => {
                            cb.checked = e.target.checked;
                            if (e.target.checked) {
                                addRecipientFromMember(cb);
                            } else {
                                removeRecipientByEmail(cb.value);
                            }
                        });
                    });
                }

                // Handle individual member selection
                document.querySelectorAll('.dept-member-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            addRecipientFromMember(e.target);
                        } else {
                            removeRecipientByEmail(e.target.value);
                        }
                    });
                });
            }

            function addRecipientFromMember(checkbox) {
                const email = checkbox.value;
                const userId = checkbox.getAttribute('data-user-id');
                console.log('Adding recipient from member:', { email, userId, departmentMembersCount: departmentMembers.length });

                // Try to find member in departmentMembers array
                let member = departmentMembers.find(m => m._id === userId || m.email === email);

                // If not found, try to get from the checkbox's parent element data
                if (!member && checkbox.closest('.dept-member-dropdown-item')) {
                    const item = checkbox.closest('.dept-member-dropdown-item');
                    const itemEmail = item.getAttribute('data-email');
                    const itemUserId = item.getAttribute('data-user-id');
                    member = departmentMembers.find(m => m._id === itemUserId || m.email === itemEmail);
                }

                // If still not found, construct from checkbox data
                if (!member) {
                    console.warn('Member not found in departmentMembers, constructing from checkbox data');
                    member = {
                        _id: userId,
                        email: email,
                        firstName: '',
                        lastName: '',
                        profilePicture: '/images/memofy-logo.png'
                    };
                }

                if (!member) {
                    console.error('Could not find or create member data');
                    return;
                }

                // Access recipientData from log.js (exposed globally)
                if (window.recipientData) {
                    // Check if already added
                    const exists = window.recipientData.find(u => u.email.toLowerCase() === email.toLowerCase());
                    if (exists) {
                        return; // Already added
                    }

                    // Add member to recipientData
                    window.recipientData.push({
                        _id: member._id,
                        email: member.email,
                        firstName: member.firstName,
                        lastName: member.lastName,
                        fullName: `${member.firstName || ''} ${member.lastName || ''}`.trim() || member.email,
                        profilePicture: member.profilePicture || '/images/memofy-logo.png'
                    });

                    // Trigger render if function exists
                    if (typeof window.renderRecipientChips === 'function') {
                        window.renderRecipientChips();
                    } else if (typeof renderRecipientChips === 'function') {
                        renderRecipientChips();
                    } else {
                        // Fallback: trigger via input event
                        const recipientsInput = document.getElementById('recipients');
                        if (recipientsInput && recipientsInput.dispatchEvent) {
                            recipientsInput.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    }
                } else {
                    // Fallback: use input method
                    const recipientsInput = document.getElementById('recipients');
                    if (recipientsInput) {
                        recipientsInput.value = member.email;
                        const enterEvent = new KeyboardEvent('keydown', {
                            key: 'Enter',
                            code: 'Enter',
                            keyCode: 13,
                            which: 13,
                            bubbles: true
                        });
                        recipientsInput.dispatchEvent(enterEvent);
                        recipientsInput.value = '';
                    }
                }
            }

            function removeRecipientByEmail(email) {
                // Find and remove the chip by clicking its remove button
                const chip = document.querySelector(`.recipient-chip[data-email="${email}"]`);
                if (chip) {
                    const removeBtn = chip.querySelector('.chip-remove');
                    if (removeBtn) {
                        removeBtn.click();
                    }
                }
            }
        });

        // Fetch and update all dashboard stats
        (async function updateDashboardStats() {
            try {
                const res = await fetch('/api/log/dashboard/stats/secretary', { credentials: 'same-origin' });
                const data = await res.json();
                if (data && data.success && data.stats) {
                    const stats = data.stats;

                    // Update all stat cards
                    const draftedEl = document.getElementById('draftedCount');
                    if (draftedEl) draftedEl.textContent = String(stats.drafted || 0);

                    const sentEl = document.getElementById('sentCount');
                    if (sentEl) sentEl.textContent = String(stats.sent || 0);

                    const acknowledgedEl = document.getElementById('acknowledgedCount');
                    if (acknowledgedEl) acknowledgedEl.textContent = String(stats.acknowledged || 0);

                    const pendingEl = document.getElementById('pendingCount');
                    if (pendingEl) pendingEl.textContent = String(stats.pending || 0);
                }
            } catch (e) {
                console.error('Error fetching dashboard stats:', e);
            }
        })();
    </script>

    <!-- Department Members Modal -->
=======
    <!-- Department Members Modal (Keep existing functionality) -->
>>>>>>> 5209f543e09b04e324156c8c9bf3891d0fe547ed
    <div id="departmentMembersModal" class="modal" style="display: none;">
        <!-- ... existing department members modal content ... -->
    </div>

    <!-- Date Details Modal for Mini Calendar -->
    <div id="dashboardDateModal" class="custom-modal" style="display: none;">
        <div class="custom-modal-overlay"></div>
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 id="dashboardDateModalTitle">Date Details</h3>
                <button class="custom-modal-close" id="dashboardDateModalClose">&times;</button>
            </div>
            <div class="custom-modal-body">
                <div id="dashboardDateModalContent"></div>
            </div>
            <div class="custom-modal-footer">
                <button class="custom-modal-btn custom-modal-btn-secondary" id="dashboardDateModalCancel">Close</button>
                <button class="custom-modal-btn custom-modal-btn-primary" id="dashboardDateModalViewCalendar">View Full Calendar</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize lucide icons for non-Vue parts
        lucide.createIcons();

        // Keep existing JavaScript functionality for modals
        // These functions will be called by Vue components
        window.openComposeModal = function() {
            const composeModal = document.getElementById('composeModal');
            if (composeModal) {
                composeModal.style.display = 'block';
                lucide.createIcons();
            }
        };

        window.openDepartmentMembersModal = function() {
            const modal = document.getElementById('departmentMembersModal');
            if (modal) {
                modal.style.display = 'block';
                if (typeof window.loadAndDisplayDepartmentMembers === 'function') {
                    window.loadAndDisplayDepartmentMembers();
                }
            }
        };

        window.openProfileModal = function() {
            const profileSection = document.getElementById('profileSection');
            if (profileSection) {
                profileSection.click();
            }
        };

        // openSignatureModal is now exposed from Vue app's mounted hook
    </script>

    <script src="/js/log.js"></script>
    <script src="/js/dashboard-mini-calendar.js"></script>
    <script src="/js/error-handler.js"></script>
<<<<<<< HEAD
</body>
=======
>>>>>>> 5209f543e09b04e324156c8c9bf3891d0fe547ed

    <script>
        // Initialize secretary data from backend
        window.initialSecretaryData = {
            stats: [],
            memos: <%- JSON.stringify(memos || []) %>
        };
    </script>
</body>
</html>
