<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secretary Dashboard | Memofy</title>
    <link rel="stylesheet" href="/css/admin-dash.css">
    <link rel="stylesheet" href="/css/secretary-side-css.css">
    <link rel="stylesheet" href="/css/sec-topbar.css">
    <link rel="stylesheet" href="/css/sec-nav.css">
    <link rel="stylesheet" href="/css/calendar.css">
    <link rel="stylesheet" href="/css/custom-calendar.css">
    <link rel="stylesheet" href="/css/log.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Google Analytics Tracking -->
    <%- include('google-analytics', { propertyId: typeof gaPropertyId !=='undefined' ? gaPropertyId : null }); %>

        <!-- Google APIs -->
        <script src="https://apis.google.com/js/api.js"></script>
        <script src="https://accounts.google.com/gsi/client"></script>
        <script src="/js/lucide.min.js"></script>
        <script>
            window.currentUser = {
                id: '<%= user._id %>',
                email: '<%= user.email %>',
                role: '<%= user.role %>',
                department: '<%= user.department || "" %>',
                canCrossSend: <%= user.canCrossSend || false %>
            };
            // Set calendar connection status for mini calendar
            window.calendarConnected = <%= (user.calendarAccessToken || user.calendarRefreshToken) ? 'true' : 'false' %>;
        </script>
</head>

<body>
    <div class="dashboard-container">
        <%- include('../components/sec-nav'); %>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Header -->
                <%- include('../components/sec-topbar'); %>
                <div class="content-area">
                    <!-- Main Grid -->
                    <div class="main-grid">
                        <!-- Header -->
                        <header class="hero-header">
                            <div class="hero-overlay">
                                <div class="hero-texts">
                                    <h1>Secretary Dashboard</h1>
                                    <p>Welcome back, <%= user.fullName || user.firstName %>!</p>
                                </div>
                            </div>
                        </header>

                    <!-- Dashboard Content -->
                    <div class="dashboard-content">
                            <!-- Stats Cards -->
                            <div class="stats-grid">
                                <div class="stat-card-container">
                                <div class="stat-card">
                                    <div class="stat-icon">üìù</div>
                                    <div class="stat-info">
                                        <h3>Drafted Memos</h3>
                                            <div class="stat-value" id="draftedCount">0</div>
                                        <div class="stat-change">Ready to send</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">üì§</div>
                                    <div class="stat-info">
                                        <h3>Sent Memos</h3>
                                            <div class="stat-value" id="sentCount">0</div>
                                        <div class="stat-change">This month</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">‚úÖ</div>
                                    <div class="stat-info">
                                        <h3>Acknowledged</h3>
                                            <div class="stat-value" id="acknowledgedCount">0</div>
                                        <div class="stat-change">Completed</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">‚è≥</div>
                                    <div class="stat-info">
                                        <h3>Pending</h3>
                                        <div class="stat-value" id="pendingCount">0</div>
                                        <div class="stat-change">Awaiting response</div>
                                        </div>
                                    </div>
                                    </div>
                                </div>
                            </div>

                                <!-- Recent Memos Section -->
                                <section class="recent-memos-section">
                            <h2>Recent Memos</h2>
                            <div class="memo-container">
                                    <div class="memo-list">
                                    <% if (Array.isArray(memos) && memos.length > 0) { %>
                                            <% memos.forEach(function(memo) { %>
                                                <div class="memo-item">
                                                <% if (memo.status === 'pending') { %>
                                                    <i data-lucide="alert-triangle" class="memo-icon orange"></i>
                                                <% } else { %>
                                                    <i data-lucide="file-text" class="memo-icon blue"></i>
                                                <% } %>
                                                    <div class="memo-info">
                                                    <h4><%= memo.subject %></h4>
                                                    <p>To: <%= memo.recipient && (memo.recipient.firstName || memo.recipient.email) ? (memo.recipient.firstName + ' ' + (memo.recipient.lastName || '')) : 'Unknown' %></p>
                                                    </div>
                                                    <span class="memo-date">
                                                        <%= new Date(memo.createdAt).toLocaleDateString() %>
                                                    </span>
                                                </div>
                                                <% }); %>
                                                    <% } else { %>
                                                        <div class="memo-item">
                                            <i data-lucide="inbox" class="memo-icon"></i>
                                                            <div class="memo-info">
                                                <h4>No memos yet</h4>
                                                                <p>Your drafted and sent memos will appear here</p>
                                                            </div>
                                                        </div>
                                                        <% } %>
                                </div>
                                    </div>
                                </section>

                        <!-- Calendar and Quick Actions -->
                                <div class="side-grid">
                            <div class="calendar-section">
                                <div class="mini-cal-header" style="margin-bottom: 12px;">
                                    <h3 id="dashboardMiniCalMonth" style="margin: 0; font-size: 1rem; color: #1f2937; font-weight: 600;">Calendar</h3>
                                    <div class="mini-cal-nav">
                                        <button id="dashboardMiniPrev" class="btn-icon" aria-label="Prev" style="border: 1px solid #e2e8f0; background: #fff; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 14px;">&#8249;</button>
                                        <button id="dashboardMiniNext" class="btn-icon" aria-label="Next" style="border: 1px solid #e2e8f0; background: #fff; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 14px;">&#8250;</button>
                                    </div>
                                </div>
                                <div id="dashboardMiniCalendar" class="mini-calendar"></div>
                            </div>
                            <div class="backup-section" style="position: relative; z-index: 1;">
                                <h3 style="margin: 0 0 16px; color: #1f2937; font-size: 18px;">Quick Actions</h3>
                                        <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <button type="button" class="compose-btn" id="quickActionCompose"
                                        style="padding: 12px 16px; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; position: relative; z-index: 2; pointer-events: auto;">
                                                <i data-lucide="plus"></i> Distribute Memo
                                            </button>
                                    <button type="button" id="quickActionViewMemos"
                                        style="padding: 12px 16px; background: white; color: #6366f1; border: 1px solid #6366f1; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; position: relative; z-index: 2; pointer-events: auto;">
                                                <i data-lucide="list"></i> View All Memos
                                            </button>
                                    <button type="button" id="quickActionDeptMembers"
                                        style="padding: 12px 16px; background: white; color: #6366f1; border: 1px solid #6366f1; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; position: relative; z-index: 2; pointer-events: auto;">
                                        <i data-lucide="users"></i> Department Members
                                    </button>
                                    <button type="button" id="quickActionProfile"
                                        style="padding: 12px 16px; background: white; color: #6366f1; border: 1px solid #6366f1; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; position: relative; z-index: 2; pointer-events: auto;">
                                                <i data-lucide="user"></i> My Profile
                                            </button>
                                        </div>
                                </div>
                            </div>
                        </div>
                    </div>
            </main>
                                    </div>

    <!-- Compose Modal -->
    <div id="composeModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Compose Memo</h2>
                <button class="close-modal">&times;</button>
                                        </div>
            <div class="modal-body">
                <form id="composeForm">
                    <div class="compose-header-fields">
                        <div class="recipient-input-container" style="overflow: visible;">
                            <label class="recipient-label">To</label>
                            <div class="recipient-input-wrapper" style="position: relative; overflow: visible;">
                                <div id="recipient-chips" class="recipient-chips-wrapper"></div>
                                    <input type="text" id="recipients" name="recipients" class="recipient-input"
                                    placeholder="Click to select department faculty or type email"
                                    style="cursor: pointer;">
                                    <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); z-index: 10002; overflow: visible;">
                                        <button type="button" id="selectDeptMembersBtn"
                                            style="background: #6366f1; color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; position: relative;"
                                            title="Select Department Faculty">
                                            <i data-lucide="users"></i> Select Faculty
                                        </button>
                                        <!-- Department Members Dropdown -->
                                        <div id="deptMembersDropdown" class="dept-members-dropdown" style="display: none; width: 350px; max-height: 350px;">
                                            <div style="padding: 6px 8px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                                                <span style="font-weight: 600; font-size: 13px; color: #1f2937;">Select Department Faculty</span>
                                                <button type="button" id="closeDeptMembersDropdown" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #6b7280;">&times;</button>
                                            </div>
                                            <div id="deptMembersList" style="padding: 4px 8px;">
                                                <!-- Department members will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                            </div>
                        </div>
                        <div class="compose-field-wrapper">
                            <label class="compose-field-label" style="display: none;">Subject</label>
                            <input type="text" id="subject" class="compose-field" placeholder="Subject" required>
                        </div>
                        <div class="compose-inline-fields">
                            <div class="custom-dropdown compose-field-dropdown compose-field-inline">
                                <button id="templateDropdownBtn" type="button" class="dept-dropdown-btn compose-field">
                                    <span class="template-placeholder">Template: None</span>
                                </button>
                                <div id="templateDropdownMenu" class="dept-dropdown-menu" style="max-height:300px;">
                                    <label class="dept-checkbox-label">
                                        <input type="checkbox" class="template-checkbox" value="none" checked>
                                        <span>None</span>
                                    </label>
                                    <div id="templateSignaturesContainer">
                                        <!-- Signatures loaded dynamically -->
                                    </div>
                                    <hr class="dept-dropdown-hr">
                                    <button type="button" id="addSignatureBtn" class="add-signature-btn"
                                        style="width:100%; padding:8px; margin-top:4px; background:#f3f4f6; border:1px dashed #d1d5db; border-radius:6px; cursor:pointer; color:#2563eb; font-size:13px; font-weight:500;">
                                        + Add Signature
                                    </button>
                                </div>
                            </div>
                            <!-- Department selection: checkbox for regular secretary, dropdown for canCrossSend secretary -->
                            <div id="secretaryDeptCheckboxWrapper" class="compose-field-wrapper compose-field-inline"
                                style="display: <%= user.canCrossSend ? 'none' : 'block' %>;">
                                <label class="compose-field-label"
                                    style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: #fff; margin: 0; height: 100%; min-height: 38px;">
                                    <input type="checkbox" id="sendToAllDeptCheckbox"
                                        style="width: 18px; height: 18px; cursor: pointer; accent-color: #2563eb; margin: 0;">
                                    <span style="font-size: 14px; color: #374151; white-space: nowrap;">
                                        <%= user.department || 'Department' %>
                                    </span>
                                </label>
                            </div>
                            <!-- Admin-style department dropdown for canCrossSend secretary -->
                            <div id="secretaryDeptDropdownWrapper" class="compose-field-wrapper compose-field-inline"
                                style="display: <%= user.canCrossSend ? 'block' : 'none' %>;">
                                <div class="custom-dropdown compose-field-dropdown">
                                    <button id="deptDropdownBtn" type="button" class="dept-dropdown-btn compose-field">
                                        <span class="dept-placeholder">Department</span>
                                    </button>
                                    <div id="deptDropdownMenu" class="dept-dropdown-menu">
                                        <label class="dept-checkbox-label" id="selectAllDeptsLabel"
                                            style="display: none;">
                                            <input type="checkbox" id="selectAllDepts">
                                            <span>Select All</span>
                                        </label>
                                        <hr class="dept-dropdown-hr" style="display: none;">
                                        <div id="deptCheckboxesContainer">
                                            <!-- Departments loaded dynamically -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="compose-field-wrapper compose-field-inline">
                                <select id="prioritySelect" name="priority"
                                    class="compose-field compose-priority-select">
                                    <option value="medium">üü° Medium</option>
                                    <option value="urgent">üî¥ Urgent</option>
                                    <option value="high">üü† High</option>
                                    <option value="low">üîµ Low</option>
                                </select>
                            </div>
                        </div>
                        <input type="hidden" id="selectedDepartments" name="departments" value="">
                    </div>
                    <div id="signatorySection" class="signatory-section" style="display:none; padding: 0 16px 8px;">
                    </div>
                    <div class="compose-content-area" id="composeContentArea">
                        <textarea id="content" name="content" class="compose-textarea"
                            placeholder="Enter memo content (plain text)..."></textarea>
                        <div id="attachment-preview" class="attachment-preview-container" style="display: none;"></div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-attach" id="attachBtn" title="Attach File or Image">
                            <i data-lucide="paperclip"></i>
                        </button>
                        <input type="file" id="attachments" name="attachments" style="display: none;" multiple>
                        <button type="button" class="btn btn-secondary close-modal"
                            style="padding: 21px 60px; font-size: 18px;">Cancel</button>
                        <button type="button" class="btn btn-secondary" id="previewMemoBtn"
                            title="Preview PDF">Preview</button>
                        <button type="submit" class="btn btn-primary" id="sendMemoBtn">
                            <span class="btn-text">Send</span>
                            <span class="btn-loading" style="display: none;"><span class="spinner"></span>
                                Sending...</span>
                        </button>
                    </div>
                </form>
                <div id="sendingModal" class="sending-modal" style="display: none;">
                    <div class="sending-modal-content">
                        <div class="sending-spinner"></div>
                        <p>Sending memo...</p>
                                </div>
                            </div>
                        </div>
                    </div>
    </div>

    <!-- Add Signature Modal -->
    <div id="addSignatureModal" class="modal" style="display:none;">
        <div class="modal-content signature-modal" style="max-width:520px;">
            <div class="modal-header">
                <h2>Add Signature</h2>
                <button class="close-modal" data-modal="addSignatureModal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addSignatureForm">
                    <div class="signature-form-content">
                        <div class="form-group">
                            <label for="signatureName">Name</label>
                            <input type="text" id="signatureName" name="displayName" class="signature-input"
                                placeholder="e.g., Dr. John Doe" required>
                </div>
                        <div class="form-group">
                            <label for="signatureTitle">Title/Role</label>
                            <input type="text" id="signatureTitle" name="roleTitle" class="signature-input"
                                placeholder="e.g., University President" required>
                </div>
                        <div class="form-group">
                            <label for="signatureImage">Signature Image</label>
                            <div class="file-upload-wrapper">
                                <input type="file" id="signatureImage" name="image" accept="image/*" required
                                    class="file-input">
                                <label for="signatureImage" class="file-label">
                                    <span class="file-icon">üìé</span>
                                    <span class="file-text">Choose File</span>
                                    <span class="file-name" id="fileName">No file chosen</span>
                                </label>
                    </div>
                </div>
            </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary close-modal" data-modal="addSignatureModal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Signature</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Basic logging
        console.log('Secretary Dashboard loaded');
        console.log('User:', '<%= user.fullName %>');
        console.log('Department:', '<%= user.department %>');

        // Ensure Quick Actions buttons are clickable
        document.addEventListener('DOMContentLoaded', () => {
            // Quick Actions button event listeners
            const quickActionCompose = document.getElementById('quickActionCompose');
            if (quickActionCompose) {
                quickActionCompose.addEventListener('click', () => {
                    openComposeModal();
                });
            }

            const quickActionViewMemos = document.getElementById('quickActionViewMemos');
            if (quickActionViewMemos) {
                quickActionViewMemos.addEventListener('click', () => {
                    window.location.href = '/secretary/memos';
                });
            }

            const quickActionDeptMembers = document.getElementById('quickActionDeptMembers');
            if (quickActionDeptMembers) {
                quickActionDeptMembers.addEventListener('click', () => {
                    openDepartmentMembersModal();
                });
            }

            const quickActionProfile = document.getElementById('quickActionProfile');
            if (quickActionProfile) {
                quickActionProfile.addEventListener('click', () => {
                    openProfileModal();
                });
            }

            // Close department members modal button
            const closeDeptMembersModalBtn = document.getElementById('closeDeptMembersModalBtn');
            if (closeDeptMembersModalBtn) {
                closeDeptMembersModalBtn.addEventListener('click', () => {
                    closeDepartmentMembersModal();
                });
            }
        });

        // Function to open compose modal
        function openComposeModal() {
            const composeModal = document.getElementById('composeModal');
            if (composeModal) {
                composeModal.style.display = 'block';
                // Reinitialize Lucide icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
        }

        // Distribute modal logic (kept for backward compatibility if needed)
        let deptUsers = [];
        function openDistributeModal() {
            openComposeModal(); // Redirect to compose modal
        }
        function closeDistributeModal() {
            const composeModal = document.getElementById('composeModal');
            if (composeModal) {
                composeModal.style.display = 'none';
            }
        }
        async function loadDepartmentUsers() {
            try {
                const res = await fetch('/api/log/department-users');
                const data = await res.json();
                deptUsers = (data.users || []);
                renderUserList(deptUsers);
            } catch (e) { console.error(e); }
        }
        function renderUserList(list) {
            const ul = document.getElementById('userList');
            if (!ul) return; // Element doesn't exist on dashboard
            ul.innerHTML = '';
            list.forEach(u => {
                const id = `u_${u._id}`;
                const div = document.createElement('label');
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.gap = '8px';
                div.innerHTML = `<input type="checkbox" class="userChk" value="${u._id}"> <span>${u.firstName || ''} ${u.lastName || ''}</span><span style="color:#64748b; font-size:12px;">${u.email}</span>`;
                ul.appendChild(div);
            });
        }

        // Only add event listeners if elements exist (these are from old distribute modal)
        const userSearch = document.getElementById('userSearch');
        if (userSearch) {
            userSearch.addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            const filtered = deptUsers.filter(u => `${u.firstName || ''} ${u.lastName || ''} ${u.email}`.toLowerCase().includes(q));
            renderUserList(filtered);
        });
        }

        const selectAllChk = document.getElementById('selectAllChk');
        if (selectAllChk) {
            selectAllChk.addEventListener('change', (e) => {
            document.querySelectorAll('#userList .userChk').forEach(ch => ch.checked = e.target.checked);
        });
        }

        const sendDeptBtn = document.getElementById('sendDeptBtn');
        if (sendDeptBtn) {
            sendDeptBtn.addEventListener('click', () => {
                const selectAll = document.getElementById('selectAllChk');
                if (selectAll) {
                    selectAll.checked = true;
                }
            document.querySelectorAll('#userList .userChk').forEach(ch => ch.checked = true);
        });
        }
        async function submitDistributeMemo() {
            const subject = document.getElementById('dmSubject').value.trim();
            const message = document.getElementById('dmMessage').value.trim();
            const recipients = Array.from(document.querySelectorAll('#userList .userChk:checked')).map(el => el.value);
            if (!subject || !message || recipients.length === 0) {
                alert('Please fill subject, message, and select at least one recipient.');
                return;
            }
            try {
                const res = await fetch('/api/log/memos/distribute', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ subject, message, recipients }) });
                const data = await res.json();
                if (data.success) {
                    alert('Memo submitted successfully and is pending admin approval.');
                    closeDistributeModal();
                    location.reload();
                } else {
                    alert(data.message || 'Failed to submit memo');
                }
            } catch (e) { alert('Failed to submit memo'); }
        }

        // Function to open profile modal
        function openProfileModal() {
            const profileSection = document.getElementById('profileSection');
            if (profileSection) {
                profileSection.click();
            } else {
                console.warn('Profile section not found');
            }
        }

        // Department Members functionality
        let departmentMembers = [];

        async function loadDepartmentMembers() {
            try {
                console.log('Loading department members...');
                const res = await fetch('/api/log/department-users', {
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!res.ok) {
                    console.error('Failed to fetch department members:', res.status, res.statusText);
                    return [];
                }

                const data = await res.json();
                console.log('Department members response:', data);

                if (data.success) {
                    departmentMembers = data.users || [];
                    console.log('Loaded department members:', departmentMembers.length, departmentMembers);
                    return departmentMembers;
                } else {
                    console.error('API returned error:', data.message);
                    return [];
                }
            } catch (e) {
                console.error('Error loading department members:', e);
                return [];
            }
        }

        function openDepartmentMembersModal() {
            const modal = document.getElementById('departmentMembersModal');
            if (modal) {
                modal.style.display = 'block';
                loadAndDisplayDepartmentMembers();
            }
        }

        function closeDepartmentMembersModal() {
            const modal = document.getElementById('departmentMembersModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function loadAndDisplayDepartmentMembers() {
            const content = document.getElementById('departmentMembersContent');
            if (!content) return;

            content.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;"><i data-lucide="loader" style="width: 24px; height: 24px; animation: spin 1s linear infinite;"></i><p style="margin-top: 12px;">Loading department faculty...</p></div>';
            lucide.createIcons();

            const members = await loadDepartmentMembers();

            if (members.length === 0) {
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;"><i data-lucide="users"></i><p style="margin-top: 12px;">No department faculty found</p></div>';
                lucide.createIcons();
                return;
            }

            const html = members.map(member => {
                const fullName = `${member.firstName || ''} ${member.lastName || ''}`.trim() || member.email;
                const initial = (member.firstName || member.email || 'U')[0].toUpperCase();
                const profilePicture = member.profilePicture || '';
                const hasAvatar = profilePicture && profilePicture.trim() !== '';
                return `
                    <div class="dept-member-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid #f3f4f6; transition: background 0.2s;">
                        ${hasAvatar ?
                            `<img src="${profilePicture}" alt="${fullName}" class="dept-member-avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid #e5e7eb;">
                            <div class="dept-member-avatar-fallback" style="width: 40px; height: 40px; border-radius: 50%; background: #6366f1; display: none; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; flex-shrink: 0;">${initial}</div>` :
                            `<div style="width: 40px; height: 40px; border-radius: 50%; background: #6366f1; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; flex-shrink: 0;">${initial}</div>`
                        }
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1f2937; font-size: 14px;">${fullName}</div>
                            <div style="color: #6b7280; font-size: 12px; margin-top: 2px;">${member.email}</div>
                            <div style="color: #9ca3af; font-size: 11px; margin-top: 4px; text-transform: capitalize;">${member.role || 'Member'}</div>
                        </div>
                    </div>
                `;
            }).join('');

            content.innerHTML = html;
            lucide.createIcons();

            // Handle avatar image errors (fallback to initial)
            content.querySelectorAll('.dept-member-avatar').forEach(img => {
                img.addEventListener('error', function() {
                    this.style.display = 'none';
                    const fallback = this.nextElementSibling;
                    if (fallback && fallback.classList.contains('dept-member-avatar-fallback')) {
                        fallback.style.display = 'flex';
                    }
                });
            });

            // Add hover effects to department member items
            const memberItems = content.querySelectorAll('.dept-member-item');
            memberItems.forEach(item => {
                item.addEventListener('mouseenter', () => {
                    item.style.background = '#f9fafb';
                });
                item.addEventListener('mouseleave', () => {
                    item.style.background = 'white';
                });
            });
        }

        // Compose Modal Department Members Dropdown
        document.addEventListener('DOMContentLoaded', () => {
            const selectDeptMembersBtn = document.getElementById('selectDeptMembersBtn');
            const deptMembersDropdown = document.getElementById('deptMembersDropdown');
            const closeDeptMembersDropdown = document.getElementById('closeDeptMembersDropdown');
            const deptMembersList = document.getElementById('deptMembersList');
            const recipientsInput = document.getElementById('recipients');
            const recipientChipsContainer = document.getElementById('recipient-chips');

            if (selectDeptMembersBtn && deptMembersDropdown) {
                selectDeptMembersBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    console.log('Select Faculty button clicked');
                    if (deptMembersDropdown.style.display === 'none' || !deptMembersDropdown.style.display) {
                        // Position dropdown below button, centered horizontally
                        deptMembersDropdown.style.position = 'absolute';
                        deptMembersDropdown.style.top = 'calc(100% + 4px)';
                        deptMembersDropdown.style.left = '50%';
                        deptMembersDropdown.style.transform = 'translateX(-50%)';
                        deptMembersDropdown.style.right = 'auto';
                        deptMembersDropdown.style.bottom = 'auto';
                        deptMembersDropdown.style.display = 'block';
                        await loadDeptMembersForDropdown();
                        // Re-initialize Lucide icons after content is loaded
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    } else {
                        deptMembersDropdown.style.display = 'none';
                    }
                });
            } else {
                console.error('Select Faculty button or dropdown element not found:', {
                    selectDeptMembersBtn: !!selectDeptMembersBtn,
                    deptMembersDropdown: !!deptMembersDropdown
                });
            }

            if (closeDeptMembersDropdown) {
                closeDeptMembersDropdown.addEventListener('click', () => {
                    if (deptMembersDropdown) {
                        deptMembersDropdown.style.display = 'none';
                    }
                });
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (deptMembersDropdown && selectDeptMembersBtn) {
                    const wrapper = selectDeptMembersBtn.parentElement;
                    if (!deptMembersDropdown.contains(e.target) &&
                        e.target !== selectDeptMembersBtn &&
                        !selectDeptMembersBtn.contains(e.target) &&
                        (!wrapper || !wrapper.contains(e.target))) {
                        deptMembersDropdown.style.display = 'none';
                    }
                }
            });

            async function loadDeptMembersForDropdown() {
                if (!deptMembersList) {
                    console.error('deptMembersList element not found');
                    return;
                }

                console.log('Loading department members for dropdown...');
                deptMembersList.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af;"><i data-lucide="loader" style="width: 24px; height: 24px; animation: spin 1s linear infinite;"></i><p style="margin-top: 8px;">Loading faculty members...</p></div>';

                const members = await loadDepartmentMembers();
                console.log('Members loaded for dropdown:', members.length, members);

                // Update the global departmentMembers variable
                departmentMembers = members;

                if (members.length === 0) {
                    deptMembersList.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af;">No department faculty found</div>';
                    return;
                }

                const html = `
                    <div style="padding: 6px 8px; border-bottom: 1px solid #e5e7eb;">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 2px;">
                            <input type="checkbox" id="selectAllDeptMembers" style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="font-weight: 600; font-size: 12px;">Select All</span>
                        </label>
                    </div>
                    ${members.map(member => {
                        const fullName = `${member.firstName || ''} ${member.lastName || ''}`.trim() || member.email;
                        const initial = (member.firstName || member.email || 'U')[0].toUpperCase();
                        const role = member.role || 'Faculty';
                        const profilePicture = member.profilePicture || '';
                        const hasAvatar = profilePicture && profilePicture.trim() !== '';
                        return `
                            <div class="dept-member-dropdown-item" style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; cursor: pointer; transition: background 0.2s; border-radius: 4px; border-bottom: 1px solid #f3f4f6;"
                                   data-email="${member.email}"
                                   data-user-id="${member._id}"
                                   title="Click to add ${fullName} to recipients">
                                <input type="checkbox" class="dept-member-checkbox" value="${member.email}" data-user-id="${member._id}" style="cursor: pointer; width: 16px; height: 16px; flex-shrink: 0;">
                                ${hasAvatar ?
                                    `<img src="${profilePicture}" alt="${fullName}" class="dept-member-avatar" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid #e5e7eb;">
                                    <div class="dept-member-avatar-fallback" style="width: 32px; height: 32px; border-radius: 50%; background: #6366f1; display: none; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; flex-shrink: 0;">${initial}</div>` :
                                    `<div style="width: 32px; height: 32px; border-radius: 50%; background: #6366f1; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; flex-shrink: 0;">${initial}</div>`
                                }
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 600; color: #1f2937; font-size: 13px; margin-bottom: 1px;">${fullName}</div>
                                    <div style="color: #6b7280; font-size: 11px; margin-bottom: 1px;">${member.email}</div>
                                    <div style="color: #9ca3af; font-size: 10px; text-transform: capitalize;">${role}</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;

                deptMembersList.innerHTML = html;

                // Handle avatar image errors (fallback to initial)
                deptMembersList.querySelectorAll('.dept-member-avatar').forEach(img => {
                    img.addEventListener('error', function() {
                        this.style.display = 'none';
                        const fallback = this.nextElementSibling;
                        if (fallback && fallback.classList.contains('dept-member-avatar-fallback')) {
                            fallback.style.display = 'flex';
                        }
                    });
                });

                // Add hover effects and click handlers to dropdown items
                const dropdownItems = deptMembersList.querySelectorAll('.dept-member-dropdown-item');
                dropdownItems.forEach(item => {
                    // Hover effects
                    item.addEventListener('mouseenter', () => {
                        item.style.background = '#f9fafb';
                    });
                    item.addEventListener('mouseleave', () => {
                        item.style.background = 'white';
                    });

                    // Make entire item clickable to toggle selection
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // Don't toggle if clicking directly on checkbox (it handles its own click)
                        if (e.target.type === 'checkbox' || e.target.closest('input[type="checkbox"]')) {
                            return;
                        }

                        const checkbox = item.querySelector('.dept-member-checkbox');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            // Trigger change event to add/remove recipient
                            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                            // Visual feedback
                            item.style.background = '#f0f9ff';
                            setTimeout(() => {
                                item.style.background = item.matches(':hover') ? '#f9fafb' : 'white';
                            }, 200);
                        }
                    });
                });

                // Sync checkboxes with already selected recipients
                if (window.recipientData && window.recipientData.length > 0) {
                    document.querySelectorAll('.dept-member-checkbox').forEach(cb => {
                        const email = cb.value.toLowerCase();
                        const isSelected = window.recipientData.some(r => r.email.toLowerCase() === email);
                        cb.checked = isSelected;
                    });

                    // Update select all checkbox
                    const selectAll = document.getElementById('selectAllDeptMembers');
                    if (selectAll) {
                        const allCheckboxes = document.querySelectorAll('.dept-member-checkbox');
                        const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                        selectAll.checked = allChecked && allCheckboxes.length > 0;
                    }
                }

                // Handle select all
                const selectAll = document.getElementById('selectAllDeptMembers');
                if (selectAll) {
                    selectAll.addEventListener('change', (e) => {
                        document.querySelectorAll('.dept-member-checkbox').forEach(cb => {
                            cb.checked = e.target.checked;
                            if (e.target.checked) {
                                addRecipientFromMember(cb);
                            } else {
                                removeRecipientByEmail(cb.value);
                            }
                        });
                    });
                }

                // Handle individual member selection
                document.querySelectorAll('.dept-member-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            addRecipientFromMember(e.target);
                        } else {
                            removeRecipientByEmail(e.target.value);
                        }
                    });
                });
            }

            function addRecipientFromMember(checkbox) {
                const email = checkbox.value;
                const userId = checkbox.getAttribute('data-user-id');
                console.log('Adding recipient from member:', { email, userId, departmentMembersCount: departmentMembers.length });

                // Try to find member in departmentMembers array
                let member = departmentMembers.find(m => m._id === userId || m.email === email);

                // If not found, try to get from the checkbox's parent element data
                if (!member && checkbox.closest('.dept-member-dropdown-item')) {
                    const item = checkbox.closest('.dept-member-dropdown-item');
                    const itemEmail = item.getAttribute('data-email');
                    const itemUserId = item.getAttribute('data-user-id');
                    member = departmentMembers.find(m => m._id === itemUserId || m.email === itemEmail);
                }

                // If still not found, construct from checkbox data
                if (!member) {
                    console.warn('Member not found in departmentMembers, constructing from checkbox data');
                    member = {
                        _id: userId,
                        email: email,
                        firstName: '',
                        lastName: '',
                        profilePicture: '/images/memofy-logo.png'
                    };
                }

                if (!member) {
                    console.error('Could not find or create member data');
                    return;
                }

                // Access recipientData from log.js (exposed globally)
                if (window.recipientData) {
                    // Check if already added
                    const exists = window.recipientData.find(u => u.email.toLowerCase() === email.toLowerCase());
                    if (exists) {
                        return; // Already added
                    }

                    // Add member to recipientData
                    window.recipientData.push({
                        _id: member._id,
                        email: member.email,
                        firstName: member.firstName,
                        lastName: member.lastName,
                        fullName: `${member.firstName || ''} ${member.lastName || ''}`.trim() || member.email,
                        profilePicture: member.profilePicture || '/images/memofy-logo.png'
                    });

                    // Trigger render if function exists
                    if (typeof window.renderRecipientChips === 'function') {
                        window.renderRecipientChips();
                    } else if (typeof renderRecipientChips === 'function') {
                        renderRecipientChips();
                    } else {
                        // Fallback: trigger via input event
                        const recipientsInput = document.getElementById('recipients');
                        if (recipientsInput && recipientsInput.dispatchEvent) {
                            recipientsInput.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    }
                } else {
                    // Fallback: use input method
                    const recipientsInput = document.getElementById('recipients');
                    if (recipientsInput) {
                        recipientsInput.value = member.email;
                        const enterEvent = new KeyboardEvent('keydown', {
                            key: 'Enter',
                            code: 'Enter',
                            keyCode: 13,
                            which: 13,
                            bubbles: true
                        });
                        recipientsInput.dispatchEvent(enterEvent);
                        recipientsInput.value = '';
                    }
                }
            }

            function removeRecipientByEmail(email) {
                // Find and remove the chip by clicking its remove button
                const chip = document.querySelector(`.recipient-chip[data-email="${email}"]`);
                if (chip) {
                    const removeBtn = chip.querySelector('.chip-remove');
                    if (removeBtn) {
                        removeBtn.click();
                    }
                }
            }
        });

        // Fetch and update all dashboard stats
        (async function updateDashboardStats() {
            try {
                const res = await fetch('/api/log/dashboard/stats/secretary', { credentials: 'same-origin' });
                const data = await res.json();
                if (data && data.success && data.stats) {
                    const stats = data.stats;

                    // Update all stat cards
                    const draftedEl = document.getElementById('draftedCount');
                    if (draftedEl) draftedEl.textContent = String(stats.drafted || 0);

                    const sentEl = document.getElementById('sentCount');
                    if (sentEl) sentEl.textContent = String(stats.sent || 0);

                    const acknowledgedEl = document.getElementById('acknowledgedCount');
                    if (acknowledgedEl) acknowledgedEl.textContent = String(stats.acknowledged || 0);

                    const pendingEl = document.getElementById('pendingCount');
                    if (pendingEl) pendingEl.textContent = String(stats.pending || 0);
                }
            } catch (e) {
                console.error('Error fetching dashboard stats:', e);
            }
        })();
    </script>

    <!-- Department Members Modal -->
    <div id="departmentMembersModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid #e5e7eb;">
                <h2 style="margin: 0; font-size: 20px; color: #1f2937;">Department Faculty - <%= user.department || 'My Department' %></h2>
                <button class="close-modal" id="closeDeptMembersModalBtn" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 16px;">
                <div id="departmentMembersContent" style="max-height: 500px; overflow-y: auto;">
                    <div style="text-align: center; padding: 40px; color: #9ca3af;">
                        <i data-lucide="loader" style="width: 24px; height: 24px; animation: spin 1s linear infinite;"></i>
                        <p style="margin-top: 12px;">Loading department faculty...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Details Modal for Mini Calendar -->
    <div id="dashboardDateModal" class="custom-modal" style="display: none;">
        <div class="custom-modal-overlay"></div>
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 id="dashboardDateModalTitle">Date Details</h3>
                <button class="custom-modal-close" id="dashboardDateModalClose">&times;</button>
            </div>
            <div class="custom-modal-body">
                <div id="dashboardDateModalContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
            <div class="custom-modal-footer">
                <button class="custom-modal-btn custom-modal-btn-secondary" id="dashboardDateModalCancel">Close</button>
                <button class="custom-modal-btn custom-modal-btn-primary" id="dashboardDateModalViewCalendar">View Full Calendar</button>
            </div>
        </div>
    </div>

    <script src="/js/log.js"></script>
    <script src="/js/dashboard-mini-calendar.js"></script>
</body>

</html>
