<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Faculty Dashboard | Memofy</title>
    <link rel="stylesheet" href="/css/faculty-dashboard.css">
    <link rel="stylesheet" href="/css/fal-topbar.css">
    <link rel="stylesheet" href="/css/fal-nav.css">
    <link rel="stylesheet" href="/css/calendar.css">
    <link rel="stylesheet" href="/css/custom-calendar.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Google Analytics Tracking -->
    <%- include('google-analytics', { propertyId: typeof gaPropertyId !=='undefined' ? gaPropertyId : null }); %>

    <!-- SweetAlert2 -->
    <%- include('../components/sweetalert2'); %>

    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="/js/lucide.min.js"></script>
</head>

<body data-current-user='<%- JSON.stringify({ id: user._id, email: user.email, role: user.role, firstName: user.firstName, department: user.department || "" }) %>'
    data-calendar-connected="<%= (user.calendarAccessToken || user.calendarRefreshToken) ? 'true' : 'false' %>"
    data-initial-stats='<%- JSON.stringify({ totalReceived: totalReceived || 0 }) %>'>

    <!-- Define Vue Components -->
    <script>
        // Stats Card Component
        const StatsCard = {
            props: ['stat'],
            template: `
                <div class="stat-card-container">
                    <div class="stat-card">
                        <div class="stat-icon" v-html="stat.icon"></div>
                        <div class="stat-info">
                            <h3>{{ stat.title }}</h3>
                            <div class="stat-value">{{ stat.value }}</div>
                            <div class="stat-change">{{ stat.change }}</div>
                        </div>
                    </div>
                </div>
            `
        };

        // Memo List Component
        const MemoList = {
            props: ['memos', 'loading'],
            methods: {
                formatDate(dateString) {
                    return new Date(dateString).toLocaleDateString();
                },
                getSenderName(sender) {
                    return sender ? `${sender.firstName} ${sender.lastName || ''}` : 'Unknown';
                }
            },
            template: `
                <section class="recent-memos-section">
                    <h2>Recent Memos</h2>
                    <div class="memo-container">
                        <div class="memo-list">
                            <div v-if="memos.length === 0 && !loading" class="memo-item">
                                <i data-lucide="inbox" class="memo-icon"></i>
                                <div class="memo-info">
                                    <h4>No memos received yet</h4>
                                    <p>Memos sent to you will appear here</p>
                                </div>
                            </div>

                            <div v-for="memo in memos" :key="memo._id" class="memo-item">
                                <i data-lucide="file-text" class="memo-icon blue"></i>
                                <div class="memo-info">
                                    <h4>{{ memo.subject }}</h4>
                                    <p>From: {{ getSenderName(memo.sender) }}</p>
                                </div>
                                <span class="memo-date">{{ formatDate(memo.createdAt) }}</span>
                            </div>
                        </div>
                    </div>
                </section>
            `
        };

        // Hero Header Component
        const HeroHeader = {
            props: ['userName'],
            template: `
                <header class="hero-header">
                    <div class="hero-overlay">
                        <div class="hero-texts">
                            <h1>Faculty Dashboard</h1>
                            <p>Welcome back, {{ userName }}!</p>
                        </div>
                        <div class="hero-img-container">
                            <img src="/uploads/hero-header.png" class="hero-img" alt="hero-img">
                        </div>
                    </div>
                </header>
            `
        };
    </script>

    <!-- Main Vue App -->
    <script>
        const { createApp } = Vue;

        const app = createApp({
            data() {
                return {
                    currentUser: {},
                    calendarConnected: false,
                    dashboardData: { stats: [], memos: [] },
                    receivedMemos: [],
                    loading: false,
                    statsData: [
                        {
                            title: 'Received Memos',
                            value: '0',
                            change: 'Total memos received',
                            icon: `<svg height="50" width="50" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 8.94a1.31 1.31 0 0 0-.06-.27v-.09a1.07 1.07 0 0 0-.19-.28l-6-6a1.07 1.07 0 0 0-.28-.19h-.09L13.06 2H7a3 3 0 0 0-3 3v14a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8.94Zm-6-3.53L16.59 8H14ZM18 19a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h5v5a1 1 0 0 0 1 1h5Z" fill="currentColor" /></svg>`
                        }
                    ]
                }
            },
            computed: {
                userFirstName() {
                    return this.currentUser.firstName || 'Faculty';
                }
            },
            methods: {
                // You can add methods for faculty-specific actions here
                // For example: fetchMemos, markAsRead, etc.

                loadInitialData() {
                    // Load stats from data attribute
                    try {
                        const statsData = JSON.parse(document.body.getAttribute('data-initial-stats') || '{}');
                        if (statsData.totalReceived !== undefined) {
                            this.statsData[0].value = statsData.totalReceived.toString();
                        }
                    } catch (err) {
                        console.error('Error loading initial stats:', err);
                    }
                }
            },
            mounted() {
                // Initialize from data attributes
                try {
                    this.currentUser = JSON.parse(document.body.getAttribute('data-current-user') || '{}');
                    const calAttr = document.body.getAttribute('data-calendar-connected');
                    this.calendarConnected = calAttr === 'true';
                } catch (err) {
                    this.currentUser = {};
                }

                // Initialize dashboard data
                if (window.initialFacultyData) {
                    this.dashboardData = window.initialFacultyData;
                    this.receivedMemos = window.initialFacultyData.memos || [];
                }

                // Load initial stats
                this.loadInitialData();

                lucide.createIcons();
            }
        });

        // Register components
        app.component('stats-card', StatsCard);
        app.component('memo-list', MemoList);
        app.component('hero-header', HeroHeader);

        // Store app instance globally so we can mount it after DOM is ready
        window.vueApp = app;
    </script>

    <!-- Vue App Container -->
    <div id="app">
        <div class="dashboard-container">
            <%- include('../components/fal-nav'); %>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Header -->
                <%- include('../components/fal-topbar'); %>

                <div class="content-area">
                    <!-- Main Grid -->
                    <div class="main-grid">

                        <!-- Hero Header Component -->
                        <hero-header :user-name="userFirstName"></hero-header>

                        <!-- Dashboard Content -->
                        <div class="dashboard-content">
                            <!-- Stats Cards -->
                            <div class="stats-grid">
                                <stats-card v-for="stat in statsData" :key="stat.title" :stat="stat"></stats-card>
                            </div>
                        </div>

                        <!-- Memo List Component -->
                        <memo-list
                            :memos="receivedMemos"
                            :loading="loading">
                        </memo-list>

                        <!-- Calendar and Analytics (Non-Vue parts) -->
                        <div class="side-grid">
                            <div class="calendar-section">
                                <div class="mini-cal-header" style="margin-bottom: 12px;">
                                    <h3 id="dashboardMiniCalMonth" style="margin: 0; font-size: 1rem; color: #1f2937; font-weight: 600;">Calendar</h3>
                                    <div class="mini-cal-nav">
                                        <button id="dashboardMiniPrev" class="btn-icon" aria-label="Prev" style="border: 1px solid #e2e8f0; background: #fff; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 14px;">&#8249;</button>
                                        <button id="dashboardMiniNext" class="btn-icon" aria-label="Next" style="border: 1px solid #e2e8f0; background: #fff; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 14px;">&#8250;</button>
                                    </div>
                                </div>
                                <div id="dashboardMiniCalendar" class="mini-calendar"></div>
                            </div>

                            <div class="backup-section">
                                <i data-lucide="cloud" class="backup-icon"></i>
                                <div class="backup-info">
                                    <h3>System Status</h3>
                                    <p><strong>All systems operational.</strong></p>
                                    <p>Memo delivery: Normal</p>
                                    <p>Calendar sync: Normal</p>
                                    <p>Email notifications: Normal</p>
                                    <p style="margin-top: 6px; font-size: 0.8rem; color: #6b7280;">
                                        If you notice any issues, please contact your department secretary or IT support.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Initialize lucide icons for non-Vue parts
        lucide.createIcons();
    </script>

    <!-- Date Details Modal for Mini Calendar -->
    <div id="dashboardDateModal" class="custom-modal" style="display: none;">
        <div class="custom-modal-overlay"></div>
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 id="dashboardDateModalTitle">Date Details</h3>
                <button class="custom-modal-close" id="dashboardDateModalClose">&times;</button>
            </div>
            <div class="custom-modal-body">
                <div id="dashboardDateModalContent"></div>
            </div>
            <div class="custom-modal-footer">
                <button class="custom-modal-btn custom-modal-btn-secondary" id="dashboardDateModalCancel">Close</button>
                <button class="custom-modal-btn custom-modal-btn-primary" id="dashboardDateModalViewCalendar">View Full Calendar</button>
            </div>
        </div>
    </div>

    <script src="/js/dashboard-mini-calendar.js"></script>
    <script src="/js/error-handler.js"></script>

    <script>
        // Check for error messages from query parameters (unauthorized access)
        // Only show errors that are relevant to the current user's role
        (function() {
            // If this dashboard is opened inside the Google auth popup window,
            // notify the opener and close this window so only the main tab stays open.
            try {
                if (window.name === 'google-auth') {
                    try {
                        window.opener && window.opener.postMessage({ type: 'GOOGLE_AUTH_SUCCESS' }, window.location.origin);
                    } catch (e) { /* ignore */ }
                    setTimeout(() => {
                        try { window.close(); } catch (e) { /* ignore */ }
                    }, 200);
                }
            } catch (e) { /* ignore */ }

            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            const message = urlParams.get('message');

            if (error === 'unauthorized_access' && message) {
                // Decode the message
                const decodedMessage = decodeURIComponent(message);

                // Get current user role from data attribute
                let currentUserRole = '';
                try {
                    const userData = JSON.parse(document.body.getAttribute('data-current-user') || '{}');
                    currentUserRole = userData.role || '';
                } catch (e) {
                    // If we can't get user role, clean up silently
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                }

                // If user is on their correct dashboard, NEVER show errors - just clean up URL silently
                // This prevents annoying error popups during normal login
                if (currentUserRole === 'faculty' && window.location.pathname === '/faculty-dashboard') {
                    // Faculty on their own dashboard - clean up URL silently, no error
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                }

                // If a secretary or admin somehow ends up here, redirect them immediately
                if (currentUserRole === 'secretary') {
                    // Secretary on faculty dashboard - redirect immediately
                    window.location.href = '/secretary-dashboard';
                    return;
                }

                if (currentUserRole === 'admin') {
                    // Admin on faculty dashboard - redirect immediately
                    window.location.href = '/admin-dashboard';
                    return;
                }

                // If we get here, it's an edge case - clean up silently
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        })();

        // Initialize faculty data from backend (joenil work)
        window.initialFacultyData = {
            stats: [],
            memos: <%- JSON.stringify(receivedMemos || []) %>
        };

        // Mount Vue app after DOM is ready (ensures #app element exists)
        if (window.vueApp) {
            const appElement = document.querySelector('#app');
            if (appElement && !appElement.__vue_app__) {
                const mountedApp = window.vueApp.mount('#app');

                // Wait for Vue to render, then initialize calendar
                if (mountedApp && mountedApp.$nextTick) {
                    mountedApp.$nextTick(() => {
                        setTimeout(() => {
                            if (window.initDashboardMiniCalendar) {
                                window.initDashboardMiniCalendar();
                            }
                        }, 200);
                    });
                } else {
                    setTimeout(() => {
                        if (window.initDashboardMiniCalendar) {
                            window.initDashboardMiniCalendar();
                        }
                    }, 300);
                }
            }
        }
    </script>
</body>
</html>
