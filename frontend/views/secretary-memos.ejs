<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>My Memos | Memofy</title>
    <link rel="stylesheet" href="/css/secretary-memos.css">
    <link rel="stylesheet" href="/css/log.css">
	<link rel="stylesheet" href="/css/sec-topbar.css">
	<link rel="stylesheet" href="/css/sec-nav.css">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
	<div class="dashboard-container">
		<%- include('../components/sec-nav'); %>

		<main class="main-content">
			<%- include('../components/sec-topbar'); %>

            <div class="dashboard-content">
                <div class="log-layout">

                    <!-- Memo List Area (Admin-like header) -->
                    <section class="memo-list-area" style="flex:1 1 auto;">
                        <div class="memo-container">
                            <div class="memo-list-header">
                                <div class="header-controls">
                                    <div class="checkbox-control">
                                        <input type="checkbox" id="selectAllMemos" />
                                        <button id="refreshBtn" class="icon-btn-sm" title="Refresh">
                                            <i data-lucide="rotate-cw"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="department-filters">
                                    <div class="department-dropdown-wrapper">
                                        <select id="deptFilterDropdown" class="dept-filter-dropdown">
                                            <option value="all">All Departments</option>
                                        </select>
                                    </div>
                                    <div class="priority-dropdown-wrapper">
                                        <select id="priorityFilterDropdown" class="priority-filter-dropdown">
                                            <option value="all">All Priorities</option>
                                            <option value="urgent">ðŸ”´ Urgent</option>
                                            <option value="high">ðŸŸ  High</option>
                                            <option value="medium">ðŸŸ¡ Medium</option>
                                            <option value="low">ðŸ”µ Low</option>
                                        </select>
                                    </div>
                                    <div class="sort-dropdown-wrapper">
                                        <select id="sortDropdown" class="sort-dropdown">
                                            <option value="newest">Newest</option>
                                            <option value="oldest">Oldest</option>
                                            <option value="priority">Priority</option>
                                            <option value="subject">Subject (A-Z)</option>
                                            <option value="sender">Sender/Recipient (A-Z)</option>
                                            <option value="sent">Sent by Me</option>
                                        </select>
                                    </div>
                                    <div class="date-filter-wrapper">
                                        <input type="date" id="dateFilterInput" class="date-filter-input" title="Filter by date">
                                        <button id="clearDateFilter" class="date-filter-clear" title="Clear date filter" style="display: none;">
                                            <i data-lucide="x"></i>
                                        </button>
                                    </div>
                                    <div class="compose-control">
                                        <button class="compose-btn">
                                            <i data-lucide="pen-tool"></i>
                                            <span>Compose</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div id="memoList" class="memo-list"></div>
                        </div>
                    </section>

                    <!-- Viewer Area (admin-like slide-in with PDF-style header) -->
                    <section id="memoViewerArea" class="memo-viewer-area">
                        <div id="emptyState" class="empty-state-view">
                            <i data-lucide="inbox"></i>
                            <p>Select a memo to view</p>
                        </div>
                        <div id="memoViewer" class="memo-viewer">
                            <div class="viewer-header">
                                <button id="backBtn" class="icon-btn"><i data-lucide="arrow-left"></i></button>
                                <div class="nav-buttons">
                                    <button id="prevBtn" class="icon-btn"><i data-lucide="chevron-left"></i></button>
                                    <span id="memoCounter" class="memo-counter">0 of 0</span>
                                    <button id="nextBtn" class="icon-btn"><i data-lucide="chevron-right"></i></button>
                                </div>
                                <div class="viewer-actions">
                                    <button id="starBtn" class="icon-btn" title="Star"><i data-lucide="bookmark"></i></button>
                                    <button id="deleteBtn" class="icon-btn" title="Delete"><i data-lucide="trash-2"></i></button>
                                </div>
                            </div>
                            <div class="memo-content">
                                <div class="memo-pdf-header">
                                    <h1 class="memo-title">MEMO</h1>
                                    <div class="memo-details">
                                        <div class="memo-detail-row"><span class="memo-detail-label">Subject:</span><span id="memoDetailSubject" class="memo-detail-value"></span></div>
                                        <div class="memo-detail-row"><span class="memo-detail-label">From:</span><span id="memoDetailFrom" class="memo-detail-value"></span></div>
                                        <div class="memo-detail-row"><span class="memo-detail-label">To:</span><span id="memoDetailTo" class="memo-detail-value"></span></div>
                                        <div class="memo-detail-row"><span class="memo-detail-label">Department:</span><span id="memoDetailDepartment" class="memo-detail-value"></span></div>
                                        <div class="memo-detail-row"><span class="memo-detail-label">Priority:</span><span id="memoDetailPriority" class="memo-detail-value"></span></div>
                                        <div class="memo-detail-row"><span class="memo-detail-label">Date:</span><span id="memoDetailDate" class="memo-detail-value"></span></div>
                                    </div>
                                    <div class="memo-separator"></div>
                                </div>
                                <div class="memo-body"><div id="memoBodyContent"></div></div>
                                <div id="attachments" class="memo-attachments"></div>
                            </div>
                        </div>
                    </section>
                </div>
			</div>
		</main>
	</div>

    <!-- Removed secretary-only Distribute modal to align with Admin memos UI -->

    <!-- Admin-style Compose Modal to enable Compose button -->
    <div id="composeModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Compose Memo</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="composeForm">
                    <div class="compose-header-fields">
                        <div class="recipient-input-container">
                            <label class="recipient-label">To</label>
                            <div class="recipient-input-wrapper">
                                <div id="recipient-chips" class="recipient-chips-wrapper"></div>
                                <input type="text" id="recipients" name="recipients" class="recipient-input" placeholder="">
                            </div>
                        </div>
                        <div class="compose-field-wrapper">
                            <label class="compose-field-label" style="display: none;">Subject</label>
                            <input type="text" id="subject" class="compose-field" placeholder="Subject" required>
                        </div>
                        <div class="compose-inline-fields">
                            <div class="custom-dropdown compose-field-dropdown compose-field-inline">
                                <button id="deptDropdownBtn" type="button" class="dept-dropdown-btn compose-field">
                                    <span class="dept-placeholder">Department</span>
                                </button>
                                <div id="deptDropdownMenu" class="dept-dropdown-menu">
                                    <label class="dept-checkbox-label">
                                        <input type="checkbox" id="selectAllDepts" class="dept-checkbox">
                                        <span>Select All</span>
                                    </label>
                                    <hr class="dept-dropdown-hr">
                                    <div id="deptCheckboxesContainer"></div>
                                </div>
                            </div>
                            <div class="compose-field-wrapper compose-field-inline">
                                <select id="prioritySelect" name="priority" class="compose-field compose-priority-select">
                                    <option value="medium">ðŸŸ¡ Medium</option>
                                    <option value="urgent">ðŸ”´ Urgent</option>
                                    <option value="high">ðŸŸ  High</option>
                                    <option value="low">ðŸ”µ Low</option>
                                </select>
                            </div>
                        </div>
                        <input type="hidden" id="selectedDepartments" name="departments">
                    </div>
                    <div class="compose-content-area" id="composeContentArea">
                        <textarea id="content" name="content" class="compose-textarea" placeholder="Enter memo content (plain text)..."></textarea>
                        <div id="attachment-preview" class="attachment-preview-container" style="display: none;"></div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-attach" id="attachBtn" title="Attach File or Image">
                            <i data-lucide="paperclip"></i>
                        </button>
                        <input type="file" id="attachments" name="attachments" style="display: none;" multiple>
                        <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="sendMemoBtn">
                            <span class="btn-text">Send</span>
                            <span class="btn-loading" style="display: none;"><span class="spinner"></span> Sending...</span>
                        </button>
                    </div>
                </form>
                <div id="sendingModal" class="sending-modal" style="display: none;">
                    <div class="sending-modal-content">
                        <div class="sending-spinner"></div>
                        <p>Sending memo...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
		let deptUsers = [];
		function openDistributeModal(){ document.getElementById('distributeModal').style.display='block'; loadDepartmentUsers(); }
		function closeDistributeModal(){ document.getElementById('distributeModal').style.display='none'; }
        // Secretary memos page aligned with Admin: removed department user picker modal and related handlers

        // Received memo modal logic + filters
        window.receivedMemos = <%- JSON.stringify(received || []) %>;
        const receivedListEl = document.getElementById('receivedList');
        function renderReceived(list){
            if (!receivedListEl) return;
            if (!Array.isArray(list) || list.length === 0){
                receivedListEl.innerHTML = `
                    <div class="memo-item">
                        <i data-lucide="inbox" class="memo-icon"></i>
                        <div class="memo-info">
                            <h4>No received memos</h4>
                            <p>Incoming memos will appear here</p>
                        </div>
                    </div>`;
                lucide.createIcons();
                return;
            }
            receivedListEl.innerHTML = list.map((memo, idx) => {
                const senderName = `${memo.sender?.firstName||''} ${memo.sender?.lastName||''}`.trim();
                const senderEmail = memo.sender?.email || '';
                const realAvatar = memo.sender?.profilePicture;
                const avatarSrc = realAvatar || '/images/memofy-logo.png';
                const dateStr = new Date(memo.createdAt).toLocaleDateString();
                const pr = (memo.priority || '').toLowerCase();
                let badge = '';
                if (pr === 'urgent') badge = '<span class="priority-badge priority-urgent" title="Urgent">ðŸ”´ URGENT</span>';
                else if (pr === 'high') badge = '<span class="priority-badge priority-high" title="High">ðŸŸ  HIGH</span>';
                else if (pr === 'medium') badge = '<span class="priority-badge priority-medium" title="Medium">ðŸŸ¡ MEDIUM</span>';
                else if (pr === 'low') badge = '<span class="priority-badge priority-low" title="Low">ðŸ”µ LOW</span>';

                const hasAvatar = realAvatar ? '1' : '0';
                return `
                <div class="memo-item received-item" data-index="${idx}" data-id="${memo._id}">
                    <img src="${avatarSrc}" alt="${senderName}" class="memo-avatar" data-has-avatar="${hasAvatar}" onerror="this.src='/images/memofy-logo.png'">
                    <div class="memo-sender-info">
                        <div class="memo-sender-name">From: ${senderName||'Unknown'}</div>
                        <div class="memo-sender-email">${senderEmail}</div>
                    </div>
                    <div class="memo-item-actions">${badge}</div>
                    <div class="memo-subject">${memo.subject || ''}</div>
                    <div class="memo-date">${dateStr}</div>
                </div>`;
            }).join('');
            lucide.createIcons();
            // Bind open handlers (always fetch full memo to ensure complete content and sender)
            receivedListEl.querySelectorAll('.received-item').forEach(el => {
                el.addEventListener('click', async () => {
                    const id = el.getAttribute('data-id');
                    if (id) {
                        try {
                            const res = await fetch(`/api/log/memos/${id}`);
                            const data = await res.json();
                            if (data && data.success && data.memo) {
                                openViewMemoByObject(data.memo);
                                return;
                            }
                        } catch (e) { /* fallback below */ }
                    }
                    const idx = Number(el.getAttribute('data-index'));
                    const fallback = (list||[])[idx] || (window.receivedMemos||[])[idx];
                    openViewMemoByObject(fallback);
                });
            });

            // Lazy-load missing avatars by fetching full memo details
            (async function lazyLoadAvatars(){
                const imgs = receivedListEl.querySelectorAll('img.memo-avatar[data-has-avatar="0"]');
                for (const img of imgs) {
                    const parent = img.closest('.received-item');
                    const id = parent && parent.getAttribute('data-id');
                    if (!id) continue;
                    try {
                        const res = await fetch(`/api/log/memos/${id}`);
                        const data = await res.json();
                        const pic = data && data.success && data.memo && data.memo.sender && data.memo.sender.profilePicture;
                        if (pic) { img.src = pic; img.setAttribute('data-has-avatar','1'); }
                    } catch (e) { /* ignore */ }
                }
            })();
        }
        renderReceived(window.receivedMemos);

        // Filters
        const rxTitle = document.getElementById('rxFilterTitle');
        const rxDate = document.getElementById('rxFilterDate');
        const rxClear = document.getElementById('rxFilterClear');
        function applyReceivedFilters(){
            const t = (rxTitle?.value || '').toLowerCase();
            const d = (rxDate?.value || '');
            const filtered = (window.receivedMemos||[]).filter(m => {
                const okTitle = !t || String(m.subject||'').toLowerCase().includes(t);
                const okDate = !d || (new Date(m.createdAt)).toISOString().slice(0,10) === d;
                return okTitle && okDate;
            });
            renderReceived(filtered);
        }
        if (rxTitle) rxTitle.addEventListener('input', applyReceivedFilters);
        if (rxDate) rxDate.addEventListener('change', applyReceivedFilters);
        if (rxClear) rxClear.addEventListener('click', () => { if (rxTitle) rxTitle.value=''; if (rxDate) rxDate.value=''; applyReceivedFilters(); });

        // Bind modal control buttons (no inline handlers to respect CSP)
        const closeBtn = document.getElementById('closeDistributeBtn');
        const cancelBtn = document.getElementById('cancelDistributeBtn');
        const sendBtn = document.getElementById('sendDistributeBtn');
        if (closeBtn) closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeDistributeModal(); });
        if (cancelBtn) cancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeDistributeModal(); });
        if (sendBtn) sendBtn.addEventListener('click', async (e)=>{ e.preventDefault(); await submitDistributeMemo(); });
        function openViewMemo(index){
            const memo = (window.receivedMemos||[])[index];
            openViewMemoByObject(memo);
        }

        async function openViewMemoByObject(memo){
            if(!memo) return;
            // If sender details are missing, fetch full memo from API
            if ((!memo.sender || !memo.sender.firstName) && memo._id) {
                try {
                    const res = await fetch(`/api/log/memos/${memo._id}`);
                    const data = await res.json();
                    if (data && data.success && data.memo) {
                        memo = data.memo;
                    }
                } catch (e) { /* ignore and proceed with what we have */ }
            }
            const viewerArea = document.getElementById('memoViewerArea');
            const subjectPdfEl = document.getElementById('vmDetailSubject');
            const fromEl = document.getElementById('vmDetailFrom');
            const toEl = document.getElementById('vmDetailTo');
            const deptEl = document.getElementById('vmDetailDepartment');
            const prioEl = document.getElementById('vmDetailPriority');
            const dateEl = document.getElementById('vmDetailDate');
            const contentEl = document.getElementById('vmContent');
            const attDiv = document.getElementById('vmAttachments');
            if (subjectPdfEl) subjectPdfEl.textContent = memo.subject || '(No subject)';
            const senderName = ((memo.sender?.firstName||'') + ' ' + (memo.sender?.lastName||'')).trim();
            if (fromEl) fromEl.textContent = `${senderName||'Unknown'} (${memo.sender?.email||''})`;
            const recipName = ((memo.recipient?.firstName||'') + ' ' + (memo.recipient?.lastName||'')).trim();
            if (toEl) toEl.textContent = `${recipName||'Unknown'} (${memo.recipient?.email||''})`;
            if (deptEl) deptEl.textContent = memo.department || 'N/A';
            if (prioEl) prioEl.textContent = memo.priority || 'medium';
            if (dateEl) dateEl.textContent = new Date(memo.createdAt).toLocaleString();
            if (contentEl) contentEl.textContent = memo.content || '';
            if (attDiv){
                attDiv.innerHTML='';
                if (Array.isArray(memo.attachments) && memo.attachments.length){
                    const wrap = document.createElement('div');
                    wrap.style.marginTop='8px';
                    memo.attachments.forEach(att => {
                        const fileName = att && att.path
                            ? (att.path.includes('/') ? att.path.split('/').pop() : (att.path.includes('\\\\') ? att.path.split('\\\\').pop() : (att.filename || '')))
                            : (att.filename || '');
                        const isImg = (att && att.mimetype && att.mimetype.startsWith('image/')) || /\.(png|jpe?g|gif|webp)$/i.test(fileName);
                        if (isImg){
                            const img = document.createElement('img'); img.src = `/uploads/${fileName}`; img.alt = att.filename || 'image'; img.style.maxWidth='100%'; img.style.height='auto'; img.style.border='1px solid #e5e7eb'; img.style.borderRadius='8px'; img.style.display='block'; img.style.marginBottom='8px';
                            wrap.appendChild(img);
                        }
                    });
                    attDiv.appendChild(wrap);
                }
            }
            if (viewerArea){
                viewerArea.style.display='block';
                viewerArea.style.flex = '0 0 55%';
                viewerArea.style.maxWidth = '55%';
            }
            const closeViewerBtn = document.getElementById('closeViewerBtn');
            if (closeViewerBtn){ closeViewerBtn.onclick = () => { viewerArea.style.display='none'; }; }
        }
    </script>
    <script>
        window.currentUser = {
            id: '<%= user._id %>',
            email: '<%= user.email %>',
            role: '<%= user.role %>',
            department: '<%= user.department || "" %>',
            canCrossSend: <%= user.canCrossSend || false %>
        };
    </script>
    <script src="/js/log.js"></script>
    <script src="/js/log-viewer.js"></script>
</body>

</html>


