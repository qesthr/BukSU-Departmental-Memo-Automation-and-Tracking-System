<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Memos | Memofy</title>
    <link rel="stylesheet" href="/css/secretary-memos.css">
    <link rel="stylesheet" href="/css/log.css">
    <link rel="stylesheet" href="/css/sec-topbar.css">
    <link rel="stylesheet" href="/css/sec-nav.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Google Analytics Tracking -->
    <%- include('google-analytics', { propertyId: typeof gaPropertyId !=='undefined' ? gaPropertyId : null }); %>

        <script src="/js/lucide.min.js"></script>
</head>

<body>
    <div class="dashboard-container">
        <%- include('../components/sec-nav'); %>

            <main class="main-content">
                <%- include('../components/sec-topbar'); %>

                    <div class="dashboard-content" style="margin-top: 10px; height: 630px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border-radius: 10px;">
                        <div class="log-layout" style="border: none;">

                            <!-- Memo List Area (Admin-like header) -->
                            <section class="memo-list-area" style="flex:1 1 auto; border: none;">
                                <div class="memo-container" style="height: 620px; border: none;">
                                    <div class="memo-list-header" style="flex-shrink: 0;">
                                        <div class="header-controls">
                                            <div class="checkbox-control" style="display: flex; align-items: center; gap: 8px;">
                                                <div class="select-dropdown-wrapper">
                                                    <button id="selectDropdownBtn" class="select-dropdown-btn" type="button">
                                                        <i data-lucide="square" class="select-icon"></i>
                                                        <i data-lucide="chevron-down" class="dropdown-arrow"></i>
                                                    </button>
                                                    <div id="selectDropdownMenu" class="select-dropdown-menu">
                                                        <button type="button" class="select-dropdown-item" data-action="all">All</button>
                                                        <button type="button" class="select-dropdown-item" data-action="none">None</button>
                                                        <button type="button" class="select-dropdown-item" data-action="read">Read</button>
                                                        <button type="button" class="select-dropdown-item" data-action="unread">Unread</button>
                                                        <button type="button" class="select-dropdown-item" data-action="starred">Starred</button>
                                                        <button type="button" class="select-dropdown-item" data-action="unstarred">Unstarred</button>
                                                    </div>
                                                </div>
                                                <button id="bulkArchiveBtn" class="icon-btn-sm" title="Archive Selected" style="display: none;">
                                                    <i data-lucide="archive"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="department-filters">
                                            <div class="department-dropdown-wrapper">
                                                <select id="deptFilterDropdown" class="dept-filter-dropdown">
                                                    <option value="all">All Departments</option>
                                                </select>
                                            </div>
                                            <div class="priority-dropdown-wrapper">
                                                <select id="priorityFilterDropdown" class="priority-filter-dropdown">
                                                    <option value="all">All Priorities</option>
                                                    <option value="urgent">ðŸ”´ Urgent</option>
                                                    <option value="high">ðŸŸ  High</option>
                                                    <option value="medium">ðŸŸ¡ Medium</option>
                                                    <option value="low">ðŸ”µ Low</option>
                                                </select>
                                            </div>
                                            <div class="sort-dropdown-wrapper">
                                                <select id="sortDropdown" class="sort-dropdown">
                                                    <option value="newest">Newest</option>
                                                    <option value="oldest">Oldest</option>
                                                    <option value="priority">Priority</option>
                                                    <option value="subject">Subject (A-Z)</option>
                                                    <option value="sender">Sender/Recipient (A-Z)</option>
                                                    <option value="sent">Sent by Me</option>
                                                </select>
                                            </div>
                                            <div class="date-filter-wrapper">
                                                <input type="date" id="dateFilterInput" class="date-filter-input"
                                                    title="Filter by date">
                                                <button id="clearDateFilter" class="date-filter-clear"
                                                    title="Clear date filter" style="display: none;">
                                                    <i data-lucide="x"></i>
                                                </button>
                                            </div>
                                            <div class="compose-control">
                                                <button class="compose-btn">
                                                    <i data-lucide="pen-tool"></i>
                                                    <span>Compose</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="memo-list-container">
                                        <div id="memoList" class="memo-list"></div>
                                    </div>
                                </div>
                            </section>

                            <!-- Memo Viewer Modal (matches admin experience) -->
                            <div id="memoViewerModal" class="modal memo-viewer-modal" style="display: none;">
                                <div class="modal-content memo-viewer-modal-content">
                                    <div id="memoViewer" class="memo-viewer">
                                        <div class="viewer-header">
                                            <button id="backBtn" class="icon-btn" title="Close">
                                                <i data-lucide="x"></i>
                                            </button>
                                            <div class="nav-buttons">
                                                <button id="prevBtn" class="icon-btn" title="Previous Memo">
                                                    <i data-lucide="chevron-left"></i>
                                                </button>
                                                <span id="memoCounter" class="memo-counter">0 of 0</span>
                                                <button id="nextBtn" class="icon-btn" title="Next Memo">
                                                    <i data-lucide="chevron-right"></i>
                                                </button>
                                            </div>
                                            <div class="viewer-actions">
                                                <button id="starBtn" class="icon-btn" title="Toggle Favorite"><i
                                                        data-lucide="bookmark"></i></button>
                                                <button id="downloadBtn" class="icon-btn" title="Download Memo"><i
                                                        data-lucide="download"></i></button>
                                                <button id="archiveBtn" class="icon-btn" title="Archive"><i
                                                        data-lucide="archive"></i></button>
                                            </div>
                                        </div>
                                        <div class="memo-content">
                                            <div class="memo-gmail-header">
                                                <h2 id="memoDetailSubject" class="memo-subject-title"></h2>
                                                <div class="memo-sender-header">
                                                    <img id="memoSenderAvatar" src="/images/memofy-logo.png" alt="Sender"
                                                        class="memo-sender-avatar-img">
                                                    <div class="memo-sender-info-header">
                                                        <div class="memo-sender-name-header" id="memoDetailFromName"></div>
                                                        <div class="memo-sender-email-header" id="memoDetailFromEmail"></div>
                                                    </div>
                                                </div>
                                                <div class="memo-to-dropdown-header" id="toDropdownToggle"
                                                    style="cursor: pointer; padding: 8px 0; color: #6b7280; font-size: 13px; position: relative;">
                                                    <span id="memoDetailToPreview" style="text-decoration: underline;">to me</span>
                                                    <i data-lucide="chevron-down" style="width: 16px; height: 16px; margin-left: 4px;"></i>
                                                    <div id="memoDetailsPopup" class="memo-details-popup" style="display: none;">
                                                        <div class="memo-details-popup-content">
                                                            <div class="memo-detail-popup-row">
                                                                <span class="memo-detail-popup-label">Subject:</span>
                                                                <span id="memoDetailSubjectPopup" class="memo-detail-popup-value"></span>
                                                            </div>
                                                            <div class="memo-detail-popup-row">
                                                                <span class="memo-detail-popup-label">From:</span>
                                                                <span id="memoDetailFromPopup" class="memo-detail-popup-value"></span>
                                                            </div>
                                                            <div class="memo-detail-popup-row">
                                                                <span class="memo-detail-popup-label">To:</span>
                                                                <span id="memoDetailToPopup" class="memo-detail-popup-value"></span>
                                                            </div>
                                                            <div class="memo-detail-popup-row">
                                                                <span class="memo-detail-popup-label">Department:</span>
                                                                <span id="memoDetailDepartmentPopup" class="memo-detail-popup-value"></span>
                                                            </div>
                                                            <div class="memo-detail-popup-row">
                                                                <span class="memo-detail-popup-label">Priority:</span>
                                                                <span id="memoDetailPriorityPopup" class="memo-detail-popup-value"></span>
                                                            </div>
                                                            <div class="memo-detail-popup-row">
                                                                <span class="memo-detail-popup-label">Date:</span>
                                                                <span id="memoDetailDatePopup" class="memo-detail-popup-value"></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="memo-body">
                                                <div id="memoBodyContent"></div>
                                            </div>
                                            <div id="acknowledgmentStatus" class="acknowledgment-status" style="display: none;">
                                                <div class="acknowledgment-header-compact">
                                                    <span class="acknowledgment-label">Acknowledgment Status:</span>
                                                    <div id="acknowledgmentAvatars" class="acknowledgment-avatars"></div>
                                                    <button id="reminderBtnCompact" class="reminder-btn-compact" title="Send Reminder" style="display: none;">
                                                        <i data-lucide="bell"></i>
                                                        <span>Reminder</span>
                                                    </button>
                                                </div>
                                            </div>
                                            <div id="attachments" class="memo-attachments"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            </main>
    </div>

    <!-- Removed secretary-only Distribute modal to align with Admin memos UI -->

    <!-- Admin-style Compose Modal to enable Compose button -->
    <div id="composeModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Compose Memo</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="composeForm">
                    <div class="compose-header-fields">
                        <div class="recipient-input-container" style="overflow: visible;">
                            <label class="recipient-label">To</label>
                            <div class="recipient-input-wrapper" style="position: relative; overflow: visible;">
                                <div id="recipient-chips" class="recipient-chips-wrapper"></div>
                                <input type="text" id="recipients" name="recipients" class="recipient-input"
                                    placeholder="Click to select department faculty or type email"
                                    style="cursor: pointer;">
                                
                            </div>
                            <div style="position: relative;">
                                <button type="button" id="selectDeptMembersBtn"
                                    style="background: #6366f1; color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;"
                                    title="Select Department Faculty">
                                    <i data-lucide="users"></i> Select Faculty
                                </button>
                                <!-- Department Members Dropdown -->
                                <div id="deptMembersDropdown" class="dept-members-dropdown" style="display: none; width: 350px; max-height: 350px;">
                                    <div style="padding: 6px 8px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-weight: 600; font-size: 13px; color: #1f2937;">Select Department Faculty</span>
                                        <button type="button" id="closeDeptMembersDropdown" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #6b7280;">&times;</button>
                                    </div>
                                    <div id="deptMembersList" style="padding: 4px 8px;">
                                        <!-- Department members will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="compose-field-wrapper">
                            <label class="compose-field-label" style="display: none;">Subject</label>
                            <input type="text" id="subject" class="compose-field" placeholder="Subject" required>
                        </div>
                        <div class="compose-inline-fields">
                            <div class="custom-dropdown compose-field-dropdown compose-field-inline">
                                <button id="templateDropdownBtn" type="button" class="dept-dropdown-btn compose-field">
                                    <span class="template-placeholder">Signature: None</span>
                                </button>
                                <div id="templateDropdownMenu" class="dept-dropdown-menu" style="max-height:300px;">
                                    <label class="dept-checkbox-label">
                                        <input type="checkbox" class="template-checkbox" value="none" checked>
                                        <span>None</span>
                                    </label>
                                    <div id="templateSignaturesContainer">
                                        <!-- Signatures loaded dynamically -->
                                    </div>
                                    <% if (user.canAddSignature !== false) { %>
                                    <hr class="dept-dropdown-hr">
                                    <button type="button" id="addSignatureBtn" class="add-signature-btn"
                                        style="width:100%; padding:8px; margin-top:4px; background:#f3f4f6; border:1px dashed #d1d5db; border-radius:6px; cursor:pointer; color:#2563eb; font-size:13px; font-weight:500;">
                                        + Add Signature
                                    </button>
                                    <% } %>
                                </div>
                            </div>
                            <!-- Department selection: checkbox for regular secretary, dropdown for canCrossSend secretary -->
                            <div id="secretaryDeptCheckboxWrapper" class="compose-field-wrapper compose-field-inline"
                                style="display: <%= user.canCrossSend ? 'none' : 'block' %>;">
                                <label class="compose-field-label"
                                    style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: #fff; margin: 0; height: 100%; min-height: 38px;">
                                    <input type="checkbox" id="sendToAllDeptCheckbox"
                                        style="width: 18px; height: 18px; cursor: pointer; accent-color: #2563eb; margin: 0;">
                                    <span style="font-size: 14px; color: #374151; white-space: nowrap;">
                                        <%= user.department || 'Department' %>
                                    </span>
                                </label>
                            </div>
                            <!-- Admin-style department dropdown for canCrossSend secretary -->
                            <div id="secretaryDeptDropdownWrapper" class="compose-field-wrapper compose-field-inline"
                                style="display: <%= user.canCrossSend ? 'block' : 'none' %>;">
                                <div class="custom-dropdown compose-field-dropdown">
                                    <button id="deptDropdownBtn" type="button" class="dept-dropdown-btn compose-field">
                                        <span class="dept-placeholder">Department</span>
                                    </button>
                                    <div id="deptDropdownMenu" class="dept-dropdown-menu">
                                        <label class="dept-checkbox-label" id="selectAllDeptsLabel"
                                            style="display: none;">
                                            <input type="checkbox" id="selectAllDepts">
                                            <span>Select All</span>
                                        </label>
                                        <hr class="dept-dropdown-hr" style="display: none;">
                                        <div id="deptCheckboxesContainer">
                                            <!-- Departments loaded dynamically -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="compose-field-wrapper compose-field-inline">
                                <select id="prioritySelect" name="priority"
                                    class="compose-field compose-priority-select">
                                    <option value="medium">ðŸŸ¡ Medium</option>
                                    <option value="urgent">ðŸ”´ Urgent</option>
                                    <option value="high">ðŸŸ  High</option>
                                    <option value="low">ðŸ”µ Low</option>
                                </select>
                            </div>
                        </div>
                        <input type="hidden" id="selectedDepartments" name="departments" value="">
                        <!-- Hidden date/time inputs (populated by schedule modal) -->
                        <input type="hidden" id="memoDate" name="memoDate">
                        <input type="hidden" id="memoTime" name="memoTime">
                        <input type="hidden" id="allDayEvent" name="allDayEvent" value="false">
                    </div>
                    <div id="signatorySection" class="signatory-section" style="display:none; padding: 0 16px 8px;">
                    </div>
                    <div class="compose-content-area" id="composeContentArea">
                        <textarea id="content" name="content" class="compose-textarea"
                            placeholder="Enter memo content (plain text)..."></textarea>
                        <div id="attachment-preview" class="attachment-preview-container" style="display: none;"></div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-attach" id="attachBtn" title="Attach File or Image">
                            <i data-lucide="paperclip"></i>
                        </button>
                        <input type="file" id="attachments" name="attachments" style="display: none;" multiple>
                        <button type="button" class="btn btn-calendar" id="calendarBtn" title="Schedule Date and Time">
                            <i data-lucide="calendar"></i>
                            <span id="calendarBtnText" style="margin-left: 6px; font-size: 13px;">Schedule</span>
                        </button>
                        <button type="button" class="btn btn-secondary close-modal"
                            style="padding: 21px 60px; font-size: 14px;">Cancel</button>
                        <button type="button" class="btn btn-secondary" id="previewMemoBtn"
                            title="Preview PDF">Preview</button>
                        <button type="submit" class="btn btn-primary" id="sendMemoBtn">
                            <span class="btn-text">Send</span>
                            <span class="btn-loading" style="display: none;"><span class="spinner"></span>
                                Sending...</span>
                        </button>
                    </div>
                </form>
                <div id="sendingModal" class="sending-modal" style="display: none;">
                    <div class="sending-modal-content">
                        <div class="sending-spinner"></div>
                        <p>Sending memo...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Signature Modal -->
    <div id="addSignatureModal" class="modal" style="display:none;">
        <div class="modal-content signature-modal" style="max-width:520px;">
            <div class="modal-header">
                <h2>Add Signature</h2>
                <button class="close-modal" data-modal="addSignatureModal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addSignatureForm">
                    <div class="signature-form-content">
                        <div class="form-group">
                            <label for="signatureName">Name</label>
                            <input type="text" id="signatureName" name="displayName" class="signature-input"
                                placeholder="e.g., Dr. John Doe" required>
                        </div>
                        <div class="form-group">
                            <label for="signatureTitle">Title/Role</label>
                            <input type="text" id="signatureTitle" name="roleTitle" class="signature-input"
                                placeholder="e.g., University President" required>
                        </div>
                        <div class="form-group">
                            <label for="signatureImage">Signature Image</label>
                            <div class="file-upload-wrapper">
                                <input type="file" id="signatureImage" name="image" accept="image/*" required
                                    class="file-input">
                                <label for="signatureImage" class="file-label">
                                    <span class="file-icon">ðŸ“Ž</span>
                                    <span class="file-text">Choose File</span>
                                    <span class="file-name" id="fileName">No file chosen</span>
                                </label>
                            </div>
                            <small class="file-hint">PNG or JPG, transparent background recommended</small>
                        </div>
                    </div>
                    <div class="form-actions signature-actions" style="margin-bottom: 2px; padding: 10px 24px;">
                        <button type="button" class="btn btn-secondary close-modal"
                            data-modal="addSignatureModal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Signature</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let deptUsers = [];
        function openDistributeModal() { document.getElementById('distributeModal').style.display = 'block'; loadDepartmentUsers(); }
        function closeDistributeModal() { document.getElementById('distributeModal').style.display = 'none'; }
        // Secretary memos page aligned with Admin: removed department user picker modal and related handlers

        // Received memo modal logic + filters
        window.receivedMemos = <%- JSON.stringify(received || []) %>;
        const receivedListEl = document.getElementById('receivedList');
        function renderReceived(list) {
            if (!receivedListEl) return;
            if (!Array.isArray(list) || list.length === 0) {
                receivedListEl.innerHTML = `
                    <div class="memo-item">
                        <i data-lucide="inbox" class="memo-icon"></i>
                        <div class="memo-info">
                            <h4>No received memos</h4>
                            <p>Incoming memos will appear here</p>
                        </div>
                    </div>`;
                lucide.createIcons();
                return;
            }
            receivedListEl.innerHTML = list.map((memo, idx) => {
                const senderName = ((memo.sender?.firstName || '') + ' ' + (memo.sender?.lastName || '')).trim();
                const senderEmail = memo.sender?.email || '';
                const realAvatar = memo.sender?.profilePicture;
                const avatarSrc = realAvatar || '/images/memofy-logo.png';
                const dateStr = new Date(memo.createdAt).toLocaleDateString();
                const pr = (memo.priority || '').toLowerCase();
                let badge = '';
                if (pr === 'urgent') badge = '<span class="priority-badge priority-urgent" title="Urgent">ðŸ”´ URGENT</span>';
                else if (pr === 'high') badge = '<span class="priority-badge priority-high" title="High">ðŸŸ  HIGH</span>';
                else if (pr === 'medium') badge = '<span class="priority-badge priority-medium" title="Medium">ðŸŸ¡ MEDIUM</span>';
                else if (pr === 'low') badge = '<span class="priority-badge priority-low" title="Low">ðŸ”µ LOW</span>';

                const hasAvatar = realAvatar ? '1' : '0';
                return '<div class="memo-item received-item" data-index="' + idx + '" data-id="' + memo._id + '">' +
                    '<img src="' + avatarSrc + '" alt="' + senderName + '" class="memo-avatar" data-has-avatar="' + hasAvatar + '" onerror="this.src=\'/images/memofy-logo.png\'">' +
                    '<div class="memo-sender-info">' +
                    '<div class="memo-sender-name">From: ' + (senderName || 'Unknown') + '</div>' +
                    '<div class="memo-sender-email">' + senderEmail + '</div>' +
                    '</div>' +
                    '<div class="memo-item-actions">' + badge + '</div>' +
                    '<div class="memo-subject">' + (memo.subject || '') + '</div>' +
                    '<div class="memo-date">' + dateStr + '</div>' +
                    '</div>';
            }).join('');
            lucide.createIcons();
            // Bind open handlers (always fetch full memo to ensure complete content and sender)
            receivedListEl.querySelectorAll('.received-item').forEach(el => {
                el.addEventListener('click', async () => {
                    const id = el.getAttribute('data-id');
                    if (id) {
                        try {
                            const res = await fetch('/api/log/memos/' + id);
                            const data = await res.json();
                            if (data && data.success && data.memo) {
                                openViewMemoByObject(data.memo);
                                return;
                            }
                        } catch (e) { /* fallback below */ }
                    }
                    const idx = Number(el.getAttribute('data-index'));
                    const fallback = (list || [])[idx] || (window.receivedMemos || [])[idx];
                    openViewMemoByObject(fallback);
                });
            });

            // Lazy-load missing avatars by fetching full memo details
            (async function lazyLoadAvatars() {
                const imgs = receivedListEl.querySelectorAll('img.memo-avatar[data-has-avatar="0"]');
                for (const img of imgs) {
                    const parent = img.closest('.received-item');
                    const id = parent && parent.getAttribute('data-id');
                    if (!id) continue;
                    try {
                        const res = await fetch('/api/log/memos/' + id);
                        const data = await res.json();
                        const pic = data && data.success && data.memo && data.memo.sender && data.memo.sender.profilePicture;
                        if (pic) { img.src = pic; img.setAttribute('data-has-avatar', '1'); }
                    } catch (e) { /* ignore */ }
                }
            })();
        }
        renderReceived(window.receivedMemos);

        // Archive functionality (for archive/unarchive buttons in viewer)
        const archiveBtn = document.getElementById('archiveBtn');
        const unarchiveBtn = document.getElementById('unarchiveBtn');
        let currentViewedMemo = null;

        // Archive a memo
        async function archiveMemo(memoId) {
            if (!memoId) return;
            try {
                const response = await fetch('/api/log/memos/' + memoId, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ status: 'archived' })
                });
                const data = await response.json();
                if (data && data.success) {
                    // Refresh memo list
                    if (typeof fetchMemos === 'function') {
                        fetchMemos();
                    }
                    // Update current memo if it's the one being archived
                    if (currentViewedMemo && currentViewedMemo._id === memoId) {
                        currentViewedMemo.status = 'archived';
                        updateArchiveButtons(currentViewedMemo);
                    }
                    // Show success notification
                    if (typeof showNotification === 'function') {
                        showNotification('Memo archived successfully', 'success');
                    }
                }
            } catch (error) {
                console.error('Error archiving memo:', error);
            }
        }

        // Unarchive a memo
        async function unarchiveMemo(memoId) {
            if (!memoId) return;
            try {
                const response = await fetch('/api/log/memos/' + memoId, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ status: 'sent' })
                });
                const data = await response.json();
                if (data && data.success) {
                    // Refresh memo list
                    if (typeof fetchMemos === 'function') {
                        fetchMemos();
                    }
                    // Update current memo if it's the one being unarchived
                    if (currentViewedMemo && currentViewedMemo._id === memoId) {
                        currentViewedMemo.status = 'sent';
                        updateArchiveButtons(currentViewedMemo);
                    }
                    // Show success notification
                    if (typeof showNotification === 'function') {
                        showNotification('Memo unarchived successfully', 'success');
                    }
                }
            } catch (error) {
                console.error('Error unarchiving memo:', error);
            }
        }

        // Update archive button visibility based on memo
        function updateArchiveButtons(memo) {
            if (!memo || !archiveBtn || !unarchiveBtn) return;
            currentViewedMemo = memo;
            const isArchived = memo.status === 'archived';

            // Show archive/unarchive button based on memo status
            // Allow archiving both sent and received memos (like admin and faculty)
            if (isArchived) {
                archiveBtn.style.display = 'none';
                unarchiveBtn.style.display = 'inline-flex';
            } else {
                archiveBtn.style.display = 'inline-flex';
                unarchiveBtn.style.display = 'none';
            }
        }

        // Expose updateArchiveButtons globally so log.js can call it
        window.updateArchiveButtons = updateArchiveButtons;

        // Add event listeners for archive buttons
        if (archiveBtn) {
            archiveBtn.addEventListener('click', async () => {
                if (currentViewedMemo && currentViewedMemo._id) {
                    await archiveMemo(currentViewedMemo._id);
                }
            });
        }

        if (unarchiveBtn) {
            unarchiveBtn.addEventListener('click', async () => {
                if (currentViewedMemo && currentViewedMemo._id) {
                    await unarchiveMemo(currentViewedMemo._id);
                }
            });
        }

        // Filters
        const rxTitle = document.getElementById('rxFilterTitle');
        const rxDate = document.getElementById('rxFilterDate');
        const rxClear = document.getElementById('rxFilterClear');
        function applyReceivedFilters() {
            const t = (rxTitle?.value || '').toLowerCase();
            const d = (rxDate?.value || '');
            const filtered = (window.receivedMemos || []).filter(m => {
                const okTitle = !t || String(m.subject || '').toLowerCase().includes(t);
                const okDate = !d || (new Date(m.createdAt)).toISOString().slice(0, 10) === d;
                return okTitle && okDate;
            });
            renderReceived(filtered);
        }
        if (rxTitle) rxTitle.addEventListener('input', applyReceivedFilters);
        if (rxDate) rxDate.addEventListener('change', applyReceivedFilters);
        if (rxClear) rxClear.addEventListener('click', () => { if (rxTitle) rxTitle.value = ''; if (rxDate) rxDate.value = ''; applyReceivedFilters(); });

        // Bind modal control buttons (no inline handlers to respect CSP)
        const closeBtn = document.getElementById('closeDistributeBtn');
        const cancelBtn = document.getElementById('cancelDistributeBtn');
        const sendBtn = document.getElementById('sendDistributeBtn');
        if (closeBtn) closeBtn.addEventListener('click', (e) => { e.preventDefault(); closeDistributeModal(); });
        if (cancelBtn) cancelBtn.addEventListener('click', (e) => { e.preventDefault(); closeDistributeModal(); });
        if (sendBtn) sendBtn.addEventListener('click', async (e) => { e.preventDefault(); await submitDistributeMemo(); });
        function openViewMemo(index) {
            const memo = (window.receivedMemos || [])[index];
            openViewMemoByObject(memo);
        }

        async function openViewMemoByObject(memo) {
            if (!memo) return;
            // If sender details are missing, fetch full memo from API
            if ((!memo.sender || !memo.sender.firstName) && memo._id) {
                try {
                    const res = await fetch('/api/log/memos/' + memo._id);
                    const data = await res.json();
                    if (data && data.success && data.memo) {
                        memo = data.memo;
                    }
                } catch (e) { /* ignore and proceed with what we have */ }
            }
            const viewerArea = document.getElementById('memoViewerArea');
            const subjectPdfEl = document.getElementById('vmDetailSubject');
            const fromEl = document.getElementById('vmDetailFrom');
            const toEl = document.getElementById('vmDetailTo');
            const deptEl = document.getElementById('vmDetailDepartment');
            const prioEl = document.getElementById('vmDetailPriority');
            const dateEl = document.getElementById('vmDetailDate');
            const contentEl = document.getElementById('vmContent');
            const attDiv = document.getElementById('vmAttachments');
            if (subjectPdfEl) subjectPdfEl.textContent = memo.subject || '(No subject)';
            const senderName = ((memo.sender?.firstName || '') + ' ' + (memo.sender?.lastName || '')).trim();
            if (fromEl) fromEl.textContent = (senderName || 'Unknown') + ' (' + (memo.sender?.email || '') + ')';
            const recipName = ((memo.recipient?.firstName || '') + ' ' + (memo.recipient?.lastName || '')).trim();
            if (toEl) toEl.textContent = (recipName || 'Unknown') + ' (' + (memo.recipient?.email || '') + ')';
            if (deptEl) deptEl.textContent = memo.department || 'N/A';
            if (prioEl) prioEl.textContent = memo.priority || 'medium';
            if (dateEl) dateEl.textContent = new Date(memo.createdAt).toLocaleString();
            if (contentEl) {
                let contentHtml = '';
                const memoText = memo.content || '';
                if (memoText && memoText.trim()) {
                    const safeContent = memoText
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                    const marginBottom = (memo.signatures && memo.signatures.length > 0) ? '1.5rem' : '0';
                    contentHtml += '<div style="white-space: pre-wrap; line-height: 1.6; color: #111827; margin-bottom: ' + marginBottom + ';">' + safeContent + '</div>';
                }

                // Add signatures if present
                if (memo.signatures && Array.isArray(memo.signatures) && memo.signatures.length > 0) {
                    contentHtml += '<div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">';
                    contentHtml += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 1rem;">';

                    memo.signatures.forEach(sig => {
                        const name = sig.displayName || sig.roleTitle || sig.role || '';
                        const title = sig.roleTitle || sig.role || '';
                        const imgSrc = sig.imageUrl || '';

                        contentHtml += '<div style="text-align: center;">';
                        if (imgSrc) {
                            contentHtml += '<img src="' + imgSrc + '" alt="' + name + '" style="max-width: 180px; max-height: 60px; object-fit: contain; margin-bottom: 8px;" onerror="this.style.display=\'none\'">';
                        } else {
                            contentHtml += '<div style="height: 60px; margin-bottom: 8px;"></div>';
                        }
                        contentHtml += '<div style="font-weight: 600; color: #111827; margin-top: 4px;">' + name + '</div>';
                        contentHtml += '<div style="font-size: 13px; color: #6b7280; margin-top: 2px;">' + title + '</div>';
                        contentHtml += '</div>';
                    });

                    contentHtml += '</div></div>';
                }

                contentEl.innerHTML = contentHtml || '<div style="color: #9ca3af; font-style: italic;">No content</div>';
            }
            if (attDiv) {
                attDiv.innerHTML = '';
                if (Array.isArray(memo.attachments) && memo.attachments.length) {
                    const wrap = document.createElement('div');
                    wrap.style.marginTop = '8px';
                    memo.attachments.forEach(att => {
                        const fileName = att && att.path
                            ? (att.path.includes('/') ? att.path.split('/').pop() : (att.path.includes('\\\\') ? att.path.split('\\\\').pop() : (att.filename || '')))
                            : (att.filename || '');
                        const isImg = (att && att.mimetype && att.mimetype.startsWith('image/')) || /\.(png|jpe?g|gif|webp)$/i.test(fileName);
                        if (isImg) {
                            const img = document.createElement('img'); img.src = '/uploads/' + fileName; img.alt = att.filename || 'image'; img.style.maxWidth = '100%'; img.style.height = 'auto'; img.style.border = '1px solid #e5e7eb'; img.style.borderRadius = '8px'; img.style.display = 'block'; img.style.marginBottom = '8px';
                            wrap.appendChild(img);
                        }
                    });
                    attDiv.appendChild(wrap);
                }
            }
            if (viewerArea) {
                viewerArea.style.display = 'block';
                viewerArea.style.flex = '0 0 55%';
                viewerArea.style.maxWidth = '55%';
            }
            // Update archive buttons based on memo
            updateArchiveButtons(memo);
            const closeViewerBtn = document.getElementById('closeViewerBtn');
            if (closeViewerBtn) { closeViewerBtn.onclick = () => { viewerArea.style.display = 'none'; }; }
        }
    </script>

    <!-- In-modal preview overlay -->
    <div id="previewOverlay" class="preview-overlay" style="display:none;">
        <div class="preview-content">
            <button type="button" class="close-preview" aria-label="Close preview">&times;</button>
            <iframe id="previewFrame" title="Memo Preview"></iframe>
        </div>
    </div>
    <script>
        window.currentUser = {
            id: '<%= user._id %>',
            email: '<%= user.email %>',
            role: '<%= user.role %>',
            department: '<%= user.department || "" %>',
            canCrossSend: <%= user.canCrossSend || false %>
        };
    </script>
    <script src="/js/log.js"></script>
    <script src="/js/log-viewer.js"></script>
    <script>
        // Auto-open compose modal if ?compose=true is in URL
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('compose') === 'true') {
                // Wait for log.js to initialize, then open compose modal
                setTimeout(() => {
                    const composeBtn = document.querySelector('.compose-btn');
                    if (composeBtn) {
                        composeBtn.click();
                        // Remove the query parameter from URL without reloading
                        const newUrl = window.location.pathname;
                        window.history.replaceState({}, '', newUrl);
                    }
                }, 500);
            }
        });

        // Department Members functionality for Compose Modal
        let departmentMembers = [];

        async function loadDepartmentMembers() {
            try {
                console.log('Loading department members...');
                const res = await fetch('/api/log/department-users', {
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!res.ok) {
                    console.error('Failed to fetch department members:', res.status, res.statusText);
                    return [];
                }

                const data = await res.json();
                console.log('Department members response:', data);

                if (data.success) {
                    departmentMembers = data.users || [];
                    console.log('Loaded department members:', departmentMembers.length, departmentMembers);
                    return departmentMembers;
                } else {
                    console.error('API returned error:', data.message);
                    return [];
                }
            } catch (e) {
                console.error('Error loading department members:', e);
                return [];
            }
        }

        // Compose Modal Department Members Dropdown
        document.addEventListener('DOMContentLoaded', () => {
            const selectDeptMembersBtn = document.getElementById('selectDeptMembersBtn');
            const deptMembersDropdown = document.getElementById('deptMembersDropdown');
            const closeDeptMembersDropdown = document.getElementById('closeDeptMembersDropdown');
            const deptMembersList = document.getElementById('deptMembersList');

            if (selectDeptMembersBtn && deptMembersDropdown) {
                selectDeptMembersBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    console.log('Select Faculty button clicked');
                    if (deptMembersDropdown.style.display === 'none' || !deptMembersDropdown.style.display) {
                        // Get button's position relative to viewport
                        const buttonRect = selectDeptMembersBtn.getBoundingClientRect();
                        
                        // Position dropdown below button using fixed positioning to avoid clipping
                        deptMembersDropdown.style.position = 'fixed';
                        deptMembersDropdown.style.top = (buttonRect.bottom + 4) + 'px';
                        deptMembersDropdown.style.left = buttonRect.left + 'px';
                        deptMembersDropdown.style.transform = 'none';
                        deptMembersDropdown.style.right = 'auto';
                        deptMembersDropdown.style.bottom = 'auto';
                        deptMembersDropdown.style.width = '350px';
                        deptMembersDropdown.style.maxHeight = '350px';
                        deptMembersDropdown.style.display = 'block';
                        await loadDeptMembersForDropdown();
                        // Re-initialize Lucide icons after content is loaded
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    } else {
                        deptMembersDropdown.style.display = 'none';
                    }
                });
            } else {
                console.error('Select Faculty button or dropdown element not found:', {
                    selectDeptMembersBtn: !!selectDeptMembersBtn,
                    deptMembersDropdown: !!deptMembersDropdown
                });
            }

            if (closeDeptMembersDropdown) {
                closeDeptMembersDropdown.addEventListener('click', () => {
                    if (deptMembersDropdown) {
                        deptMembersDropdown.style.display = 'none';
                    }
                });
            }

            // Reposition dropdown on scroll or resize
            function repositionDropdown() {
                if (deptMembersDropdown && deptMembersDropdown.style.display === 'block' && selectDeptMembersBtn) {
                    const buttonRect = selectDeptMembersBtn.getBoundingClientRect();
                    deptMembersDropdown.style.top = (buttonRect.bottom + 4) + 'px';
                    deptMembersDropdown.style.left = buttonRect.left + 'px';
                }
            }

            window.addEventListener('scroll', repositionDropdown, true);
            window.addEventListener('resize', repositionDropdown);

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (deptMembersDropdown && selectDeptMembersBtn) {
                    const wrapper = selectDeptMembersBtn.parentElement;
                    if (!deptMembersDropdown.contains(e.target) &&
                        e.target !== selectDeptMembersBtn &&
                        !selectDeptMembersBtn.contains(e.target) &&
                        (!wrapper || !wrapper.contains(e.target))) {
                        deptMembersDropdown.style.display = 'none';
                    }
                }
            });

            async function loadDeptMembersForDropdown() {
                if (!deptMembersList) {
                    console.error('deptMembersList element not found');
                    return;
                }

                console.log('Loading department members for dropdown...');
                deptMembersList.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af;"><i data-lucide="loader" style="width: 24px; height: 24px; animation: spin 1s linear infinite;"></i><p style="margin-top: 8px;">Loading faculty members...</p></div>';

                const members = await loadDepartmentMembers();
                console.log('Members loaded for dropdown:', members.length, members);

                // Update the global departmentMembers variable
                departmentMembers = members;

                if (members.length === 0) {
                    deptMembersList.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af;">No department faculty found</div>';
                    return;
                }

                const html = '<div style="padding: 6px 8px; border-bottom: 1px solid #e5e7eb;">' +
                    '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 2px;">' +
                    '<input type="checkbox" id="selectAllDeptMembers" style="width: 16px; height: 16px; cursor: pointer;">' +
                    '<span style="font-weight: 600; font-size: 12px;">Select All</span>' +
                    '</label>' +
                    '</div>' +
                    members.map(member => {
                        const fullName = ((member.firstName || '') + ' ' + (member.lastName || '')).trim() || member.email;
                        const initial = ((member.firstName || member.email || 'U')[0] || 'U').toUpperCase();
                        const role = member.role || 'Faculty';
                        const profilePicture = member.profilePicture || '';
                        const hasAvatar = profilePicture && profilePicture.trim() !== '';
                        return '<div class="dept-member-dropdown-item" style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; cursor: pointer; transition: background 0.2s; border-radius: 4px; border-bottom: 1px solid #f3f4f6;" ' +
                            'data-email="' + member.email + '" ' +
                            'data-user-id="' + member._id + '" ' +
                            'title="Click to add ' + fullName + ' to recipients">' +
                            '<input type="checkbox" class="dept-member-checkbox" value="' + member.email + '" data-user-id="' + member._id + '" style="cursor: pointer; width: 16px; height: 16px; flex-shrink: 0;">' +
                            (hasAvatar ?
                                '<img src="' + profilePicture + '" alt="' + fullName + '" class="dept-member-avatar" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid #e5e7eb;">' +
                                '<div class="dept-member-avatar-fallback" style="width: 32px; height: 32px; border-radius: 50%; background: #6366f1; display: none; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; flex-shrink: 0;">' + initial + '</div>'
                            :
                                '<div style="width: 32px; height: 32px; border-radius: 50%; background: #6366f1; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; flex-shrink: 0;">' + initial + '</div>'
                            ) +
                            '<div style="flex: 1; min-width: 0;">' +
                            '<div style="font-weight: 600; color: #1f2937; font-size: 13px; margin-bottom: 1px;">' + fullName + '</div>' +
                            '<div style="color: #6b7280; font-size: 11px; margin-bottom: 1px;">' + member.email + '</div>' +
                            '<div style="color: #9ca3af; font-size: 10px; text-transform: capitalize;">' + role + '</div>' +
                            '</div>' +
                            '</div>';
                    }).join('');

                deptMembersList.innerHTML = html;

                // Handle avatar image errors (fallback to initial)
                deptMembersList.querySelectorAll('.dept-member-avatar').forEach(img => {
                    img.addEventListener('error', function() {
                        this.style.display = 'none';
                        const fallback = this.nextElementSibling;
                        if (fallback && fallback.classList.contains('dept-member-avatar-fallback')) {
                            fallback.style.display = 'flex';
                        }
                    });
                });

                // Add hover effects and click handlers to dropdown items
                const dropdownItems = deptMembersList.querySelectorAll('.dept-member-dropdown-item');
                dropdownItems.forEach(item => {
                    // Hover effects
                    item.addEventListener('mouseenter', () => {
                        item.style.background = '#f9fafb';
                    });
                    item.addEventListener('mouseleave', () => {
                        item.style.background = 'white';
                    });

                    // Make entire item clickable to toggle selection
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // Don't toggle if clicking directly on checkbox (it handles its own click)
                        if (e.target.type === 'checkbox' || e.target.closest('input[type="checkbox"]')) {
                            return;
                        }

                        const checkbox = item.querySelector('.dept-member-checkbox');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            // Trigger change event to add/remove recipient
                            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                            // Visual feedback
                            item.style.background = '#f0f9ff';
                            setTimeout(() => {
                                item.style.background = item.matches(':hover') ? '#f9fafb' : 'white';
                            }, 200);
                        }
                    });
                });

                // Sync checkboxes with already selected recipients
                if (window.recipientData && window.recipientData.length > 0) {
                    document.querySelectorAll('.dept-member-checkbox').forEach(cb => {
                        const email = cb.value.toLowerCase();
                        const isSelected = window.recipientData.some(r => r.email.toLowerCase() === email);
                        cb.checked = isSelected;
                    });

                    // Update select all checkbox
                    const selectAll = document.getElementById('selectAllDeptMembers');
                    if (selectAll) {
                        const allCheckboxes = document.querySelectorAll('.dept-member-checkbox');
                        const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                        selectAll.checked = allChecked && allCheckboxes.length > 0;
                    }
                }

                // Handle select all
                const selectAll = document.getElementById('selectAllDeptMembers');
                if (selectAll) {
                    selectAll.addEventListener('change', (e) => {
                        document.querySelectorAll('.dept-member-checkbox').forEach(cb => {
                            cb.checked = e.target.checked;
                            if (e.target.checked) {
                                addRecipientFromMember(cb);
                            } else {
                                removeRecipientByEmail(cb.value);
                            }
                        });
                    });
                }

                // Handle individual member selection
                document.querySelectorAll('.dept-member-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            addRecipientFromMember(e.target);
                        } else {
                            removeRecipientByEmail(e.target.value);
                        }
                    });
                });
            }

            function addRecipientFromMember(checkbox) {
                const email = checkbox.value;
                const userId = checkbox.getAttribute('data-user-id');
                console.log('Adding recipient from member:', { email, userId, departmentMembersCount: departmentMembers.length });

                // Try to find member in departmentMembers array
                let member = departmentMembers.find(m => m._id === userId || m.email === email);

                // If not found, try to get from the checkbox's parent element data
                if (!member && checkbox.closest('.dept-member-dropdown-item')) {
                    const item = checkbox.closest('.dept-member-dropdown-item');
                    const itemEmail = item.getAttribute('data-email');
                    const itemUserId = item.getAttribute('data-user-id');
                    member = departmentMembers.find(m => m._id === itemUserId || m.email === itemEmail);
                }

                // If still not found, construct from checkbox data
                if (!member) {
                    console.warn('Member not found in departmentMembers, constructing from checkbox data');
                    member = {
                        _id: userId,
                        email: email,
                        firstName: '',
                        lastName: '',
                        profilePicture: '/images/memofy-logo.png'
                    };
                }

                if (!member) {
                    console.error('Could not find or create member data');
                    return;
                }

                // Access recipientData from log.js (exposed globally)
                if (window.recipientData) {
                    // Check if already added
                    const exists = window.recipientData.find(u => u.email.toLowerCase() === email.toLowerCase());
                    if (exists) {
                        return; // Already added
                    }

                    // Add member to recipientData
                    window.recipientData.push({
                        _id: member._id,
                        email: member.email,
                        firstName: member.firstName,
                        lastName: member.lastName,
                        fullName: ((member.firstName || '') + ' ' + (member.lastName || '')).trim() || member.email,
                        profilePicture: member.profilePicture || '/images/memofy-logo.png'
                    });

                    // Trigger render if function exists
                    if (typeof window.renderRecipientChips === 'function') {
                        window.renderRecipientChips();
                    } else if (typeof renderRecipientChips === 'function') {
                        renderRecipientChips();
                    } else {
                        // Fallback: trigger via input event
                        const recipientsInput = document.getElementById('recipients');
                        if (recipientsInput && recipientsInput.dispatchEvent) {
                            recipientsInput.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    }
                } else {
                    // Fallback: use input method
                    const recipientsInput = document.getElementById('recipients');
                    if (recipientsInput) {
                        recipientsInput.value = member.email;
                        const enterEvent = new KeyboardEvent('keydown', {
                            key: 'Enter',
                            code: 'Enter',
                            keyCode: 13,
                            which: 13,
                            bubbles: true
                        });
                        recipientsInput.dispatchEvent(enterEvent);
                        recipientsInput.value = '';
                    }
                }
            }

            function removeRecipientByEmail(email) {
                // Find and remove the chip by clicking its remove button
                const chip = document.querySelector('.recipient-chip[data-email="' + email + '"]');
                if (chip) {
                    const removeBtn = chip.querySelector('.chip-remove');
                    if (removeBtn) {
                        removeBtn.click();
                    }
                }
            }
        });
    </script>

    <!-- Schedule Date/Time Modal -->
    <div id="scheduleModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 550px; width: 90%;">
            <div class="modal-header">
                <h2>Schedule Memo</h2>
                <button class="close-modal" onclick="document.getElementById('scheduleModal').style.display='none'">&times;</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <!-- Start Date/Time Section -->
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0;">Start</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">
                                    ðŸ“… Start Date
                                </label>
                                <input type="date" id="scheduleStartDate"
                                    style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">
                                    ðŸ• Start Time
                                </label>
                                <input type="time" id="scheduleStartTime"
                                    style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                            </div>
                        </div>
                    </div>

                    <!-- End Date/Time Section -->
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0;">End</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">
                                    ðŸ“… End Date
                                </label>
                                <input type="date" id="scheduleEndDate"
                                    style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">
                                    ðŸ• End Time
                                </label>
                                <input type="time" id="scheduleEndTime"
                                    style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                            </div>
                        </div>
                    </div>

                    <!-- Legacy fields (hidden, kept for backward compatibility) -->
                    <input type="date" id="scheduleDate" style="display: none;">
                    <input type="time" id="scheduleTime" style="display: none;">

                    <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f9fafb; border-radius: 8px;">
                        <input type="checkbox" id="scheduleAllDay" style="width: 18px; height: 18px; cursor: pointer; accent-color: #2563eb;">
                        <label for="scheduleAllDay" style="font-size: 14px; color: #374151; cursor: pointer; margin: 0; flex: 1;">
                            All Day Event
                        </label>
                    </div>
                    <div style="font-size: 12px; color: #6b7280; padding: 8px 12px; background: #eff6ff; border-radius: 6px; border-left: 3px solid #2563eb;">
                        <strong>ðŸ“Œ Schedule Send:</strong> This memo will be sent at the scheduled start date and time, and will appear in your calendar and all recipients' calendars until the end date and time.
                    </div>
                </div>
            </div>
            <div class="form-actions" style="padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px;">
                <button type="button" class="btn btn-secondary" id="clearScheduleBtn" style="padding: 10px 20px; font-size: 14px;">
                    Clear
                </button>
                <button type="button" class="btn btn-primary" id="saveScheduleBtn" style="padding: 10px 24px; font-size: 14px;">
                    Save
                </button>
            </div>
        </div>
    </div>
</body>

</html>
