<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Memofy</title>
    <link rel="stylesheet" href="/css/admin-dashboard.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/admintopbar.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="/js/admin-dash.js" defer></script>
    <script>
        window.currentUser = {
            id: '<%= user._id %>',
            email: '<%= user.email %>',
            role: '<%= user.role %>'
        };
    </script>
</head>

<body>
    <div class="dashboard-container">
        <%- include('../components/nav'); %>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Header -->
                <%- include('../components/admintopbar'); %>

                    <!-- Dashboard Content -->
                    <div class="dashboard-content">
                        <!-- Stats Cards -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">üìù</div>
                                <div class="stat-info">
                                    <h3>Total Memos</h3>
                                    <div class="stat-value">0</div>
                                    <div class="stat-change">0 sent, 0 received</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">‚åõ</div>
                                <div class="stat-info">
                                    <h3>Pending Acknowledgment</h3>
                                    <div class="stat-value">45</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">üìä</div>
                                <div class="stat-info">
                                    <h3>Overdue Memos</h3>
                                    <div class="stat-value">150</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">üë•</div>
                                <div class="stat-info">
                                    <h3>Active Users</h3>
                                    <div class="stat-value">7</div>
                                </div>
                            </div>
                        </div>

                        <!-- Main Grid -->
                        <div class="main-grid">
                            <!-- Recent Memos Section -->
                            <section class="recent-memos-section">
                                <h2>Recent Memos</h2>
                        <div class="memo-container">
                            <div class="memo-list">
                                <% const sortedMemos = (allMemos||[]).slice().sort(function(a,b){
                                     const pa = (a.status === 'pending') ? 1 : 0;
                                     const pb = (b.status === 'pending') ? 1 : 0;
                                     if (pb !== pa) return pb - pa; // pending first
                                     const ad = new Date(a.createdAt||0).getTime();
                                     const bd = new Date(b.createdAt||0).getTime();
                                     return bd - ad; // newest next
                                   }); %>

                                <% if ((sortedMemos||[]).length === 0) { %>
                                    <div class="memo-item">
                                        <i data-lucide="inbox" class="memo-icon"></i>
                                        <div class="memo-info">
                                            <h4>No memos yet</h4>
                                            <p>New submissions will appear here</p>
                                        </div>
                                    </div>
                                <% } %>

                                <% (sortedMemos||[]).forEach(function(memo){ %>
                                    <div class="memo-item">
                                        <% if (memo.status === 'pending') { %>
                                            <i data-lucide="alert-triangle" class="memo-icon orange"></i>
                                        <% } else { %>
                                            <i data-lucide="file-text" class="memo-icon blue"></i>
                                        <% } %>
                                        <div class="memo-info">
                                            <h4><%= memo.subject %></h4>
                                            <p>From: <%= memo.sender ? (memo.sender.firstName + ' ' + (memo.sender.lastName || '')) : 'Unknown' %></p>
                                        </div>
                                        <div style="display:flex; gap:8px; align-items:center;">
                                            <% if (memo.status === 'pending') { %>
                                                <button class="btn-primary" onclick="approveMemo('<%= memo._id %>')">Approve</button>
                                                <button class="btn-secondary" onclick="rejectMemo('<%= memo._id %>')">Reject</button>
                                            <% } else { %>
                                                <span class="memo-date"><%= new Date(memo.createdAt).toLocaleDateString() %></span>
                                            <% } %>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                        </div>
                            </section>


                            <!-- Calendar and Analytics -->
                            <div class="side-grid">
                                <div class="calendar-section">
                                    <div style="padding: 20px; background: white; border-radius: 12px; text-align: center;">
                                        <i data-lucide="calendar" style="width: 48px; height: 48px; color: #6366f1; margin: 0 auto 12px;"></i>
                                        <h3 style="margin: 0 0 8px; color: #1f2937;">Calendar</h3>
                                        <p style="margin: 0; color: #6b7280;">Coming soon</p>
                                    </div>
                                </div>
                                <div class="backup-section">
                                    <i data-lucide="cloud" class="backup-icon"></i>
                                    <div class="backup-info">
                                        <h3>System Status</h3>
                                        <p>All systems operational</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            </main>
    </div>
    </main>
    </div>

    <script>
        // Auto logout after 24 hours of inactivity
        let logoutTimer;

        function resetTimer() {
            clearTimeout(logoutTimer);
            logoutTimer = setTimeout(() => {
                window.location.href = '/auth/logout';
            }, 24 * 60 * 60 * 1000); // 24 hours
        }

        // Reset timer on user activity
        document.addEventListener('mousemove', resetTimer);
        document.addEventListener('keypress', resetTimer);
        document.addEventListener('click', resetTimer);

        // Start timer
        resetTimer();

    </script>

    <!-- Initialize Lucide icons -->
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

		async function approveMemo(id){
			try{
				const res = await fetch(`/api/log/memos/${id}/approve`, { method: 'PUT', headers: { 'Content-Type': 'application/json' } });
				const data = await res.json();
				alert(data.message || 'Approved');
				location.reload();
			}catch(e){ alert('Failed to approve'); }
		}
        async function rejectMemo(id){
            try {
                const reason = window.prompt('Optional reason for rejection:', '');
                const res = await fetch(`/api/log/memos/${id}/reject`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: reason || '' })
                });
                const data = await res.json().catch(()=>({}));
                if (!res.ok) throw new Error(data.message || 'Failed to reject');
                alert(data.message || 'Rejected');
                location.reload();
            } catch (e) {
                alert(e?.message || 'Failed to reject');
            }
        }
    </script>
    <script src="/js/freezeZoom.js"></script>
</body>

</html>
