<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Admin Dashboard | Memofy</title>
    <link rel="stylesheet" href="/css/admin-dashboard.css">
    <link rel="stylesheet" href="/css/admintopbar.css">
    <link rel="stylesheet" href="/css/calendar.css">
    <link rel="stylesheet" href="/css/custom-calendar.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.0/css/all.min.css" />

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Google Analytics Tracking -->
    <%- include('google-analytics', { propertyId: typeof gaPropertyId !=='undefined' ? gaPropertyId : null }); %>

        <!-- SweetAlert2 -->
        <%- include('../components/sweetalert2'); %>

            <!-- Google APIs -->
            <script src="https://apis.google.com/js/api.js"></script>
            <script src="https://accounts.google.com/gsi/client"></script>
            <script src="/js/lucide.min.js"></script>
            <script src="/js/admin-dash.js" defer></script>
</head>

<body
    data-current-user='<%- JSON.stringify({ id: user._id, email: user.email, role: user.role, firstName: user.firstName }) %>'
    data-calendar-connected="<%= (user.calendarAccessToken || user.calendarRefreshToken) ? 'true' : 'false' %>">

    <!-- Define ALL Vue Components FIRST -->
    <script>
        // Stats Card Component - FIXED (individual card)
        const StatsCard = {
            props: ['stat'],
            template: `
                <div class="stat-card">
                    <div class="stat-icon" v-html="stat.icon"></div>
                    <div class="stat-info">
                        <h3>{{ stat.title }}</h3>
                        <div class="stat-value">{{ stat.value }}</div>
                        <div v-if="stat.change" class="stat-change">{{ stat.change }}</div>
                    </div>
                </div>
            `
        };

        // Memo List Component - FIXED (no EJS, pure Vue)
        const MemoList = {
            props: ['memos', 'loading'],
            methods: {
                formatDate(dateString) {
                    return new Date(dateString).toLocaleDateString();
                },
                getSenderName(sender) {
                    return sender ? `${sender.firstName} ${sender.lastName || ''}` : 'Unknown';
                }
            },
            template: `
                <section class="recent-memos-section">
                    <h2>Recent Memos</h2>
                    <div class="memo-container">
                        <div class="memo-list">
                            <div v-if="memos.length === 0 && !loading" class="memo-item">
                                <i data-lucide="inbox" class="memo-icon"></i>
                                <div class="memo-info">
                                    <h4>No memos yet</h4>
                                    <p>New submissions will appear here</p>
                                </div>
                            </div>

                            <div v-for="memo in memos" :key="memo._id" class="memo-item">
                                <i :data-lucide="memo.status === 'pending' ? 'alert-triangle' : 'file-text'"
                                   :class="['memo-icon', memo.status === 'pending' ? 'orange' : 'blue']"></i>
                                <div class="memo-info">
                                    <h4>{{ memo.subject }}</h4>
                                    <p>From: {{ getSenderName(memo.sender) }}</p>
                                </div>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <template v-if="memo.status === 'pending'">
                                        <button class="btn-primary" @click="$emit('approve', memo._id)">Approve</button>
                                        <button class="btn-secondary" @click="$emit('reject', memo._id)">Reject</button>
                                    </template>
                                    <template v-else>
                                        <span class="memo-date">{{ formatDate(memo.createdAt) }}</span>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            `
        };

        // Hero Header Component - ADDED
        const HeroHeader = {
            props: ['userName'],
            template: `
                <header class="hero-header">
                    <div class="hero-overlay">
                        <div class="hero-texts">
                            <h1>Admin Dashboard</h1>
                            <p>Welcome back, {{ userName }}!</p>
                        </div>
                        <div class="hero-img-container">
                            <img src="/uploads/hero-header.png" class="hero-img" alt="hero-img">
                        </div>
                    </div>
                </header>
            `
        };
    </script>

    <!-- Main Vue App -->
    <script>
        const { createApp } = Vue;

        const app = createApp({
            data() {
                return {
                    currentUser: {},
                    calendarConnected: false,
                    dashboardData: { stats: [], memos: [] },
                    sortedMemos: [],
                    loading: false,
                    statsData: [
                        {
                            title: 'Total Memos',
                            value: '0',
                            change: '0 sent, 0 received',
                            icon: `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 8.94a1.31 1.31 0 0 0-.06-.27v-.09a1.07 1.07 0 0 0-.19-.28l-6-6a1.07 1.07 0 0 0-.28-.19h-.09L13.06 2H7a3 3 0 0 0-3 3v14a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8.94Zm-6-3.53L16.59 8H14ZM18 19a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h5v5a1 1 0 0 0 1 1h5Z" fill="currentColor" /></svg>`
                        },
                        {
                            title: 'Pending',
                            value: '45',
                            icon: `<svg viewBox="0 0 352 512" xmlns="http://www.w3.org/2000/svg"><path d="M48 363v106H27q-22 0-22 22q0 9 6 15t16 6h298q10 0 16-6t6-15q0-22-22-22h-21V363q0-69-58-107q58-38 58-107V43h21q22 0 22-22q0-9-6-15t-16-6H27Q17 0 11 6T5 21q0 22 22 22h21v106q0 69 58 107q-58 38-58 107zm43-214V43h170v106q0 35-25 60.5T176 235t-60-25.5T91 149zm0 214q0-35 25-60.5t60-25.5t60 25.5t25 60.5v106H91V363zm149-256l-128 42v22q1 5 4.5 12t19.5 18.5t40 11.5t40-10.5t20-20.5l4-11v-64zM112 448h128v-85l-128 21v64z" fill="currentColor" /></svg>`
                        },
                        {
                            title: 'Overdue Memos',
                            value: '150',
                            icon: `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none"><path d="M17.75 3A3.25 3.25 0 0 1 21 6.25v5.772a6.471 6.471 0 0 0-1.5-.709V8.5h-15v9.25c0 .966.784 1.75 1.75 1.75h5.063c.173.534.412 1.037.709 1.5H6.25A3.25 3.25 0 0 1 3 17.75V6.25A3.25 3.25 0 0 1 6.25 3h11.5zm0 1.5H6.25A1.75 1.75 0 0 0 4.5 6.25V7h15v-.75a1.75 1.75 0 0 0-1.75-1.75z" fill="currentColor" /><path d="M23 17.5a5.5 5.5 0 1 1-11 0a5.5 5.5 0 0 1 11 0zM17.5 14a.5.5 0 0 0-.5.5v4a.5.5 0 0 0 1 0v-4a.5.5 0 0 0-.5-.5zm0 7.125a.625.625 0 1 0 0-1.25a.625.625 0 0 0 0 1.25z" fill="currentColor" /></g></svg>`
                        },
                        {
                            title: 'Active Users',
                            value: '7',
                            icon: `<svg viewBox="0 0 640 512" xmlns="http://www.w3.org/2000/svg"><path d="M320 16a104 104 0 1 1 0 208a104 104 0 1 1 0-208M96 88a72 72 0 1 1 0 144a72 72 0 1 1 0-144M0 416c0-70.7 57.3-128 128-128c12.8 0 25.2 1.9 36.9 5.4C132 330.2 112 378.8 112 432v16c0 11.4 2.4 22.2 6.7 32H32c-17.7 0-32-14.3-32-32zm521.3 64c4.3-9.8 6.7-20.6 6.7-32v-16c0-53.2-20-101.8-52.9-138.6c11.7-3.5 24.1-5.4 36.9-5.4c70.7 0 128 57.3 128 128v32c0 17.7-14.3 32-32 32zM472 160a72 72 0 1 1 144 0a72 72 0 1 1-144 0M160 432c0-88.4 71.6-160 160-160s160 71.6 160 160v16c0 17.7-14.3 32-32 32H192c-17.7 0-32-14.3-32-32z" fill="currentColor" /></svg>`
                        }
                    ]
                }
            },
            computed: {
                userFirstName() {
                    return this.currentUser.firstName || 'User';
                }
            },
            methods: {
                async fetchDashboardStats() {
                    try {
                        const response = await fetch('/api/log/dashboard/stats', {
                            credentials: 'same-origin'
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log('Dashboard stats response:', data);

                        if (data.success && data.stats) {
                            // Update stats cards with real data
                            const stats = data.stats;

                            // Update Total Memos
                            const totalMemos = stats.memos.total ||
                                ((stats.memos.totalSent || 0) + (stats.memos.totalReceived || 0));
                            this.statsData[0].value = totalMemos.toLocaleString();
                            this.statsData[0].change = `${stats.memos.totalSent || 0} sent, ${stats.memos.totalReceived || 0} received`;

                            // Update Pending
                            this.statsData[1].value = (stats.memos.pending || 0).toLocaleString();

                            // Update Overdue Memos
                            this.statsData[2].value = (stats.memos.overdue || 0).toLocaleString();

                            // Update Active Users
                            this.statsData[3].value = (stats.users.active || 0).toLocaleString();

                            console.log('Stats updated successfully:', this.statsData);
                        } else {
                            console.warn('Dashboard stats response missing success or stats:', data);
                        }
                    } catch (error) {
                        console.error('Error fetching dashboard stats:', error);
                        // Keep default/hardcoded values if API fails
                    }
                },

                async approveMemo(id) {
                    try {
                        this.loading = true;
                        const res = await fetch(`/api/log/memos/${id}/approve`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin'
                        });
                        const data = await res.json();
                        await Swal.fire({
                            icon: 'success',
                            title: 'Success',
                            text: data.message || 'Approved'
                        });
                        location.reload();
                    } catch (e) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to approve'
                        });
                    } finally {
                        this.loading = false;
                    }
                },

                async rejectMemo(id) {
                    try {
                        const reason = await this.showRejectionReasonModal();
                        if (reason === null) return;

                        const res = await fetch(`/api/log/memos/${id}/reject`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ reason: reason || '' }),
                            credentials: 'same-origin'
                        });
                        const data = await res.json().catch(() => ({}));
                        if (!res.ok) throw new Error(data.message || 'Failed to reject');

                        await Swal.fire({
                            icon: 'success',
                            title: 'Success',
                            text: data.message || 'Rejected'
                        });
                        location.reload();
                    } catch (e) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: e?.message || 'Failed to reject'
                        });
                    }
                },

                showRejectionReasonModal() {
                    return new Promise((resolve) => {
                        const modal = document.createElement('div');
                        modal.id = 'rejectionReasonModal';
                        modal.style.cssText = `
                            display: flex;
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: rgba(0, 0, 0, 0.5);
                            z-index: 20000;
                            align-items: center;
                            justify-content: center;
                            padding: 2rem;
                        `;

                        modal.innerHTML = `
                            <div style="
                                background: white;
                                border-radius: 12px;
                                max-width: 500px;
                                width: 100%;
                                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                            ">
                                <div style="
                                    padding: 1.5rem;
                                    border-bottom: 1px solid #e5e7eb;
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                ">
                                    <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: #111827;">Rejection Reason</h3>
                                    <button id="closeRejectionModal" style="
                                        background: none;
                                        border: none;
                                        font-size: 1.5rem;
                                        color: #6b7280;
                                        cursor: pointer;
                                        padding: 0.5rem;
                                        line-height: 1;
                                        border-radius: 6px;
                                        transition: all 0.2s;
                                    ">&times;</button>
                                </div>
                                <div style="padding: 1.5rem;">
                                    <label style="
                                        display: block;
                                        font-size: 0.875rem;
                                        font-weight: 500;
                                        color: #374151;
                                        margin-bottom: 0.5rem;
                                    ">Optional reason for rejection:</label>
                                    <textarea id="rejectionReasonInput" style="
                                        width: 100%;
                                        padding: 0.75rem;
                                        border: 1px solid #d1d5db;
                                        border-radius: 8px;
                                        font-size: 0.875rem;
                                        font-family: inherit;
                                        resize: vertical;
                                        min-height: 100px;
                                        box-sizing: border-box;
                                    " placeholder="Enter reason for rejection (optional)"></textarea>
                                </div>
                                <div style="
                                    padding: 1rem 1.5rem;
                                    border-top: 1px solid #e5e7eb;
                                    display: flex;
                                    justify-content: flex-end;
                                    gap: 0.75rem;
                                ">
                                    <button id="cancelRejectionBtn" style="
                                        padding: 0.625rem 1.25rem;
                                        background: #f3f4f6;
                                        border: none;
                                        border-radius: 8px;
                                        font-size: 0.875rem;
                                        font-weight: 500;
                                        color: #374151;
                                        cursor: pointer;
                                        transition: all 0.2s;
                                    ">Cancel</button>
                                    <button id="confirmRejectionBtn" style="
                                        padding: 0.625rem 1.25rem;
                                        background: #2563eb;
                                        border: none;
                                        border-radius: 8px;
                                        font-size: 0.875rem;
                                        font-weight: 500;
                                        color: white;
                                        cursor: pointer;
                                        transition: all 0.2s;
                                    ">OK</button>
                                </div>
                            </div>
                        `;

                        document.body.appendChild(modal);

                        const closeModal = () => {
                            document.body.removeChild(modal);
                        };

                        const confirm = () => {
                            const input = document.getElementById('rejectionReasonInput');
                            const reason = input ? input.value.trim() : '';
                            closeModal();
                            resolve(reason);
                        };

                        const cancel = () => {
                            closeModal();
                            resolve(null);
                        };

                        // Event listeners
                        document.getElementById('closeRejectionModal').addEventListener('click', cancel);
                        document.getElementById('cancelRejectionBtn').addEventListener('click', cancel);
                        document.getElementById('confirmRejectionBtn').addEventListener('click', confirm);

                        // Close on background click
                        modal.addEventListener('click', (e) => {
                            if (e.target === modal) {
                                cancel();
                            }
                        });

                        // Close on Escape key
                        const escapeHandler = (e) => {
                            if (e.key === 'Escape') {
                                cancel();
                                document.removeEventListener('keydown', escapeHandler);
                            }
                        };
                        document.addEventListener('keydown', escapeHandler);

                        // Focus on textarea
                        setTimeout(() => {
                            const input = document.getElementById('rejectionReasonInput');
                            if (input) input.focus();
                        }, 100);
                    });
                },

                sortMemos(memos) {
                    return memos.slice().sort((a, b) => {
                        const pa = (a.status === 'pending') ? 1 : 0;
                        const pb = (b.status === 'pending') ? 1 : 0;
                        if (pb !== pa) return pb - pa;
                        const ad = new Date(a.createdAt || 0).getTime();
                        const bd = new Date(b.createdAt || 0).getTime();
                        return bd - ad;
                    });
                }
            },
            mounted() {
                // Initialize from data attributes
                try {
                    this.currentUser = JSON.parse(document.body.getAttribute('data-current-user') || '{}');
                    const calAttr = document.body.getAttribute('data-calendar-connected');
                    this.calendarConnected = calAttr === 'true';
                } catch (err) {
                    this.currentUser = {};
                }

                // Initialize dashboard data
                if (window.initialDashboardData) {
                    this.dashboardData = window.initialDashboardData;
                    this.sortedMemos = this.sortMemos(this.dashboardData.memos || []);
                }

                // Fetch real-time stats from API
                this.fetchDashboardStats();

                lucide.createIcons();
            }
        });

        // Register components
        app.component('stats-card', StatsCard);
        app.component('memo-list', MemoList);
        app.component('hero-header', HeroHeader);

        // Store app instance globally so we can mount it after DOM is ready
        window.vueApp = app;

        // Wait for DOM to be ready before mounting
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                if (document.querySelector('#app') && !document.querySelector('#app').__vue_app__) {
                    app.mount('#app');
                }
            });
        } else {
            // DOM is already ready, but #app might not be yet
            // Mount will be handled by script at end of file
        }
    </script>

    <!-- Vue App Container -->
    <div id="app">
        <div class="dashboard-container">
            <!-- Navigations -->
            <div class="navigations">
                <%- include('../components/nav', { skipScripts: true }); %>
            </div>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Header -->
                <%- include('../components/admintopbar', { skipScripts: true }); %>

                    <div class="content-area">
                        <!-- Main Grid -->
                        <div class="main-grid">

                            <!-- Hero Header Component -->
                            <hero-header :user-name="userFirstName"></hero-header>

                            <!-- Dashboard Content -->
                            <div class="dashboard-content">
                                <!-- Stats Cards -->
                                <div class="stats-grid">
                                    <stats-card v-for="stat in statsData" :key="stat.title" :stat="stat"></stats-card>
                                </div>
                            </div>

                            <!-- Memo List Component -->
                            <memo-list :memos="sortedMemos" :loading="loading" @approve="approveMemo"
                                @reject="rejectMemo">
                            </memo-list>

                            <!-- Calendar and Analytics (Non-Vue parts) -->
                            <div class="side-grid">
                                <div class="calendar-section">
                                    <div class="mini-cal-header" style="margin-bottom: 12px;">
                                        <h3 id="dashboardMiniCalMonth"
                                            style="margin: 0; font-size: 1rem; color: #1f2937; font-weight: 600;">
                                            Calendar
                                        </h3>
                                        <div class="mini-cal-nav">
                                            <button id="dashboardMiniPrev" class="btn-icon" aria-label="Prev"
                                                style="border: 1px solid #e2e8f0; background: #fff; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 14px;">&#8249;</button>
                                            <button id="dashboardMiniNext" class="btn-icon" aria-label="Next"
                                                style="border: 1px solid #e2e8f0; background: #fff; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 14px;">&#8250;</button>
                                        </div>
                                    </div>
                                    <div id="dashboardMiniCalendar" class="mini-calendar"></div>
                                </div>

                                <div class="backup-section system-status-widget" id="systemStatusWidget">
                                    <div class="system-status-header">
                                        <div class="system-status-icon-container">
                                            <i data-lucide="activity" class="backup-icon system-status-icon"
                                                id="systemStatusIcon"></i>
                                            <span class="status-indicator" id="statusIndicator"></span>
                                        </div>
                                        <div class="backup-info">
                                            <div class="system-status-title-row">
                                                <h3>System Status</h3>
                                                <button class="system-status-refresh-btn" id="systemStatusRefresh"
                                                    title="Refresh status">
                                                    <i data-lucide="refresh-cw"></i>
                                                </button>
                                            </div>
                                            <p class="system-status-text" id="systemStatusText">Checking...</p>
                                            <p class="system-status-time" id="systemStatusTime"></p>
                                        </div>
                                    </div>
                                    <div class="system-status-details" id="systemStatusDetails" style="display: none;">
                                        <div class="system-status-services" id="systemStatusServices"></div>
                                    </div>
                                    <button class="system-status-toggle" id="systemStatusToggle">
                                        <span class="toggle-text">Show Details</span>
                                        <i data-lucide="chevron-down" class="toggle-icon"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
            </main>
        </div>
    </div>

    <!-- Scripts from included components (moved outside Vue app to avoid warnings) -->
    <!-- These will be initialized after Vue mounts (see script at end of file) -->
    <script src="/js/sidebar-hover.js"></script>
    <script src="/js/profile-modal.js"></script>
    <script src="/js/logout-modal.js"></script>
    <script src="/js/session-timeout.js"></script>
    <script src="/js/contextual-search.js"></script>
    <script src="/js/notifications.js" defer></script>

    <script>
        // Only keep lucide icons initialization if needed for non-Vue parts
        lucide.createIcons();
    </script>

    <!-- Date Details Modal for Mini Calendar -->
    <div id="dashboardDateModal" class="custom-modal" style="display: none;">
        <div class="custom-modal-overlay"></div>
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 id="dashboardDateModalTitle">Date Details</h3>
                <button class="custom-modal-close" id="dashboardDateModalClose">&times;</button>
            </div>
            <div class="custom-modal-body">
                <div id="dashboardDateModalContent"></div>
            </div>
            <div class="custom-modal-footer">
                <button class="custom-modal-btn custom-modal-btn-secondary" id="dashboardDateModalCancel">Close</button>
                <button class="custom-modal-btn custom-modal-btn-primary" id="dashboardDateModalViewCalendar">View Full
                    Calendar</button>
            </div>
        </div>
    </div>

    <script src="/js/dashboard-mini-calendar.js"></script>
    <script src="/js/error-handler.js"></script>

    <script>
        // Check for error messages from query parameters (unauthorized access)
        // Only show errors that are relevant to the current user's role
        (function() {
            // If this dashboard is opened inside the Google auth popup window,
            // notify the opener and close this window so only the main tab stays open.
            try {
                if (window.name === 'google-auth') {
                    try {
                        window.opener && window.opener.postMessage({ type: 'GOOGLE_AUTH_SUCCESS' }, window.location.origin);
                    } catch (e) { /* ignore */ }
                    setTimeout(() => {
                        try { window.close(); } catch (e) { /* ignore */ }
                    }, 200);
                }
            } catch (e) { /* ignore */ }

            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            const message = urlParams.get('message');

            if (error === 'unauthorized_access' && message) {
                // Decode the message
                const decodedMessage = decodeURIComponent(message);

                // Get current user role from data attribute
                let currentUserRole = '';
                try {
                    const userData = JSON.parse(document.body.getAttribute('data-current-user') || '{}');
                    currentUserRole = userData.role || '';
                } catch (e) {
                    // If we can't get user role, clean up silently
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                }

                // If user is on their correct dashboard WITH error params, they tried to access unauthorized route
                // Show SweetAlert to inform them
                if (currentUserRole === 'admin' && window.location.pathname === '/admin-dashboard') {
                    // Admin tried to access unauthorized route (secretary/faculty route) - show SweetAlert
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Unauthorized Access',
                            text: decodedMessage || 'You do not have permission to access that page.',
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#1C89E3',
                            allowOutsideClick: false,
                            allowEscapeKey: true
                        }).then(() => {
                            // Clean up URL after user clicks OK
                            window.history.replaceState({}, document.title, window.location.pathname);
                        });
                    } else {
                        // Fallback if SweetAlert not available
                        alert(decodedMessage || 'You do not have permission to access that page.');
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                    return;
                }

                // If a secretary or faculty somehow ends up here, redirect them immediately
                if (currentUserRole === 'secretary') {
                    // Secretary on admin dashboard - redirect immediately
                    window.location.href = '/secretary-dashboard';
                    return;
                }

                if (currentUserRole === 'faculty') {
                    // Faculty on admin dashboard - redirect immediately
                    window.location.href = '/faculty-dashboard';
                    return;
                }

                // If we get here, it's an edge case - clean up silently
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        })();

        // Fix data initialization with JSON.stringify (for joenil work)
        window.initialDashboardData = {
            stats: [],
            memos: <%- JSON.stringify(allMemos || []) %>
        };

        // Mount Vue app after DOM is ready (ensures #app element exists)
        if (window.vueApp) {
            const appElement = document.querySelector('#app');
            if (appElement && !appElement.__vue_app__) {
                const mountedApp = window.vueApp.mount('#app');

                // Wait for Vue to render, then initialize everything
                const initAfterVue = () => {
                    // Initialize sidebar settings (from nav.ejs) - must run after Vue renders
                    (function () {
                        const sidebar = document.querySelector('.sidebar');
                        if (!sidebar) { return; }
                        let settings = {};
                        try {
                            settings = JSON.parse(sidebar.getAttribute('data-user-settings') || '{}');
                        } catch (err) {
                            settings = {};
                        }
                        window.__initialUserSettings = Object.assign({}, window.__initialUserSettings || {}, settings);
                        window.__currentUserRole = sidebar.getAttribute('data-user-role') || window.__currentUserRole || '';
                        const enableDark = !!settings.darkMode;
                        document.documentElement.classList.toggle('dark-mode', enableDark);
                        document.body && document.body.classList.toggle('dark-mode', enableDark);
                    })();

                    // Initialize calendar after Vue has rendered
                    if (window.initDashboardMiniCalendar) {
                        window.initDashboardMiniCalendar();
                    }

                    // Re-initialize lucide icons for any dynamically rendered elements
                    lucide.createIcons();
                };

                if (mountedApp && mountedApp.$nextTick) {
                    mountedApp.$nextTick(() => {
                        setTimeout(initAfterVue, 200);
                    });
                } else {
                    // Fallback: wait a bit then initialize
                    setTimeout(initAfterVue, 300);
                }
            }
        }
    </script>
</body>

</html>
